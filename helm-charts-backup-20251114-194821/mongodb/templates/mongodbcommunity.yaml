apiVersion: mongodbcommunity.mongodb.com/v1
kind: MongoDBCommunity
metadata:
  name: {{ .Values.cluster.name }}
  namespace: {{ .Values.cluster.namespace }}
  labels:
    {{- include "mongodb.labels" . | nindent 4 }}
  annotations:
    neural-hive.io/backup-enabled: {{ .Values.backup.enabled | quote }}
    neural-hive.io/environment: {{ .Values.environment | quote }}
spec:
  members: {{ .Values.cluster.members }}
  type: ReplicaSet
  version: {{ .Values.cluster.version | quote }}

  security:
    authentication:
      modes: ["SCRAM"]
    {{- if .Values.security.tls.enabled }}
    tls:
      enabled: true
      certificateKeySecret:
        name: {{ .Values.cluster.name }}-tls
    {{- end }}

  users:
    - name: admin
      db: admin
      passwordSecretRef:
        name: {{ if .Values.security.auth.existingSecret }}{{ .Values.security.auth.existingSecret }}{{ else }}{{ .Values.cluster.name }}-auth{{ end }}
        key: password
      roles:
        - name: root
          db: admin
      scramCredentialsSecretName: {{ .Values.cluster.name }}-admin-scram

    - name: app-user
      db: neural_hive
      passwordSecretRef:
        name: {{ if .Values.security.auth.existingSecret }}{{ .Values.security.auth.existingSecret }}{{ else }}{{ .Values.cluster.name }}-auth{{ end }}
        key: password
      roles:
        - name: readWrite
          db: neural_hive
        - name: clusterMonitor
          db: admin
      scramCredentialsSecretName: {{ .Values.cluster.name }}-app-scram

  statefulSet:
    spec:
      volumeClaimTemplates:
        - metadata:
            name: data-volume
          spec:
            accessModes:
              - {{ .Values.storage.accessMode }}
            storageClassName: {{ .Values.storage.storageClass }}
            resources:
              requests:
                storage: {{ .Values.storage.size }}

      template:
        spec:
          containers:
            - name: mongod
              resources:
                requests:
                  cpu: {{ .Values.resources.requests.cpu }}
                  memory: {{ .Values.resources.requests.memory }}
                limits:
                  cpu: {{ .Values.resources.limits.cpu }}
                  memory: {{ .Values.resources.limits.memory }}

            {{- if .Values.metrics.enabled }}
            - name: mongodb-exporter
              image: {{ .Values.metrics.image }}
              ports:
                - name: metrics
                  containerPort: {{ .Values.metrics.port }}
              env:
                - name: MONGODB_URI
                  value: "mongodb://localhost:27017"
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 200m
                  memory: 256Mi
            {{- end }}

          affinity:
            {{- toYaml .Values.affinity | nindent 12 }}

          {{- with .Values.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          {{- with .Values.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}

  additionalMongodConfig:
    storage:
      wiredTiger:
        engineConfig:
          journalCompressor: zstd
    net:
      tls:
        mode: {{ if .Values.security.tls.enabled }}requireTLS{{ else }}disabled{{ end }}

  {{- if .Values.metrics.enabled }}
  prometheus:
    enabled: true
    port: {{ .Values.metrics.port }}
  {{- end }}
