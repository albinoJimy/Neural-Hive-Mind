{{- if .Values.operator.install -}}
apiVersion: redis.redis.opstreelabs.in/v1beta1
kind: RedisCluster
metadata:
  name: {{ .Values.cluster.name | default (printf "%s-cluster" (include "redis-cluster.fullname" .)) }}
  namespace: {{ .Values.cluster.namespace | default .Release.Namespace }}
  labels:
    {{- include "redis-cluster.labels" . | nindent 4 }}
    {{- with .Values.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    neural-hive.io/data-classification: "internal"
    neural-hive.io/sla-tier: "gold"
    neural-hive.io/backup-enabled: "{{ .Values.backup.enabled }}"
spec:
  clusterSize: {{ .Values.cluster.clusterSize }}

  kubernetesConfig:
    image: quay.io/opstree/redis:{{ .Values.cluster.redisVersion }}
    imagePullPolicy: IfNotPresent

    resources:
      {{- toYaml .Values.cluster.resources | nindent 6 }}

    {{- if .Values.security.auth.enabled }}
    redisSecret:
      name: {{ include "redis-cluster.secretName" . }}
      key: {{ .Values.security.auth.secretKey | default "password" }}
    {{- end }}

    {{- if .Values.rbac.serviceAccountName }}
    serviceAccountName: {{ .Values.rbac.serviceAccountName }}
    {{- else }}
    serviceAccountName: {{ include "redis-cluster.serviceAccountName" . }}
    {{- end }}

  storage:
    volumeClaimTemplate:
      spec:
        accessModes:
          - {{ .Values.cluster.storage.accessMode | default "ReadWriteOnce" }}
        resources:
          requests:
            storage: {{ .Values.cluster.storage.size }}
        storageClassName: {{ .Values.cluster.storage.storageClass }}

  {{- if .Values.metrics.enabled }}
  redisExporter:
    enabled: true
    image: {{ .Values.metrics.image.repository }}:{{ .Values.metrics.image.tag }}
    imagePullPolicy: {{ .Values.metrics.image.pullPolicy }}
  {{- end }}

  redisConfig:
    {{- range $key, $value := .Values.cluster.config }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}

  {{- if .Values.security.tls.enabled }}
  TLS:
    enabled: true
    secret:
      secretName: {{ include "redis-cluster.tlsSecretName" . }}
  {{- end }}

  {{- with .Values.podAnnotations }}
  podAnnotations:
    {{- toYaml . | nindent 4 }}
    sidecar.istio.io/inject: "{{ .Values.istio.injection }}"
  {{- end }}

  {{- with .Values.podLabels }}
  podLabels:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .Values.affinity }}
  affinity:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .Values.tolerations }}
  tolerations:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .Values.nodeSelector }}
  nodeSelector:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  # Configuração de security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  # Configuração de recursos de inicialização
  initContainer:
    enabled: true
    image: busybox:1.35
    command:
      - sh
      - -c
      - |
        echo "Iniciando configuração do Redis Cluster..."
        echo "Verificando storage..."
        df -h /redis-data || true
        echo "Redis Cluster configurado com sucesso"
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 100m
        memory: 128Mi

---
# Service para acesso ao Redis Cluster
apiVersion: v1
kind: Service
metadata:
  name: {{ include "redis-cluster.fullname" . }}
  namespace: {{ .Values.cluster.namespace | default .Release.Namespace }}
  labels:
    {{- include "redis-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: service
  annotations:
    {{- with .Values.service.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - name: redis
      port: {{ .Values.service.port }}
      targetPort: redis
      protocol: TCP
  selector:
    app: {{ .Values.cluster.name | default (printf "%s-cluster" (include "redis-cluster.fullname" .)) }}

{{- if .Values.metrics.enabled }}
---
# Service para métricas
apiVersion: v1
kind: Service
metadata:
  name: {{ include "redis-cluster.fullname" . }}-metrics
  namespace: {{ .Values.cluster.namespace | default .Release.Namespace }}
  labels:
    {{- include "redis-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: metrics
  annotations:
    {{- with .Values.metrics.service.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  type: {{ .Values.metrics.service.type }}
  ports:
    - name: metrics
      port: {{ .Values.metrics.service.port }}
      targetPort: metrics
      protocol: TCP
  selector:
    app: {{ .Values.cluster.name | default (printf "%s-cluster" (include "redis-cluster.fullname" .)) }}
{{- end }}

{{- end }}