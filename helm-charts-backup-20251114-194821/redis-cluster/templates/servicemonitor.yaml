{{- if and .Values.metrics.enabled .Values.metrics.serviceMonitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "redis-cluster.fullname" . }}
  namespace: {{ .Values.metrics.serviceMonitor.namespace | default .Release.Namespace }}
  labels:
    {{- include "redis-cluster.labels" . | nindent 4 }}
    {{- with .Values.metrics.serviceMonitor.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    app.kubernetes.io/component: monitoring
spec:
  selector:
    matchLabels:
      {{- include "redis-cluster.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: metrics
  endpoints:
    - port: metrics
      interval: {{ .Values.metrics.serviceMonitor.interval | default "30s" }}
      scrapeTimeout: {{ .Values.metrics.serviceMonitor.scrapeTimeout | default "10s" }}
      path: /metrics
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: instance
        - sourceLabels: [__meta_kubernetes_pod_ip]
          targetLabel: pod_ip
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - targetLabel: job
          replacement: redis-cluster
        - targetLabel: neural_hive_component
          replacement: cache
        - targetLabel: neural_hive_layer
          replacement: memory
      metricRelabelings:
        # Adicionar labels específicos do Neural Hive-Mind
        - sourceLabels: [__name__]
          regex: redis_(.+)
          targetLabel: __name__
          replacement: neural_hive_redis_${1}
        # Filtrar métricas desnecessárias
        - sourceLabels: [__name__]
          regex: redis_slowlog_length|redis_slowlog_last_id
          action: drop
  namespaceSelector:
    matchNames:
      - {{ .Values.cluster.namespace | default .Release.Namespace }}
  jobLabel: neural-hive-redis-cluster

---
# PrometheusRule para alertas específicos do Redis
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "redis-cluster.fullname" . }}-alerts
  namespace: {{ .Values.metrics.serviceMonitor.namespace | default .Release.Namespace }}
  labels:
    {{- include "redis-cluster.labels" . | nindent 4 }}
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    - name: redis-cluster.rules
      interval: 30s
      rules:
        # Memory Usage Alert
        - alert: RedisClusterHighMemoryUsage
          expr: |
            (redis_memory_used_bytes / redis_memory_max_bytes) * 100 > 80
          for: 5m
          labels:
            severity: warning
            component: redis-cluster
            layer: memory
          annotations:
            summary: "Redis Cluster high memory usage"
            description: "Redis cluster {{ $labels.instance }} memory usage is above 80% ({{ $value }}%)"

        # Hit Ratio Alert
        - alert: RedisClusterLowHitRatio
          expr: |
            rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m])) < 0.7
          for: 5m
          labels:
            severity: warning
            component: redis-cluster
            layer: memory
          annotations:
            summary: "Redis Cluster low hit ratio"
            description: "Redis cluster {{ $labels.instance }} hit ratio is below 70% ({{ $value }})"

        # Cluster Down Alert
        - alert: RedisClusterDown
          expr: |
            up{job="neural-hive-redis-cluster"} == 0
          for: 1m
          labels:
            severity: critical
            component: redis-cluster
            layer: memory
          annotations:
            summary: "Redis Cluster is down"
            description: "Redis cluster instance {{ $labels.instance }} is down"

        # Connection Count Alert
        - alert: RedisClusterHighConnections
          expr: |
            redis_connected_clients > 1000
          for: 5m
          labels:
            severity: warning
            component: redis-cluster
            layer: memory
          annotations:
            summary: "Redis Cluster high connection count"
            description: "Redis cluster {{ $labels.instance }} has {{ $value }} connections (threshold: 1000)"

        # Replication Lag Alert
        - alert: RedisClusterReplicationLag
          expr: |
            redis_master_repl_offset - redis_slave_repl_offset > 1000
          for: 2m
          labels:
            severity: warning
            component: redis-cluster
            layer: memory
          annotations:
            summary: "Redis Cluster replication lag"
            description: "Redis cluster {{ $labels.instance }} replication lag is {{ $value }} bytes"

        # Keyspace Events (TTL effectiveness)
        - alert: RedisClusterLowTTLEffectiveness
          expr: |
            rate(redis_expired_keys_total[5m]) / rate(redis_keyspace_hits_total[5m]) < 0.1
          for: 10m
          labels:
            severity: info
            component: redis-cluster
            layer: memory
          annotations:
            summary: "Redis Cluster low TTL effectiveness"
            description: "Redis cluster {{ $labels.instance }} TTL effectiveness is low ({{ $value }})"

        # Blocked Clients
        - alert: RedisClusterBlockedClients
          expr: |
            redis_blocked_clients > 10
          for: 5m
          labels:
            severity: warning
            component: redis-cluster
            layer: memory
          annotations:
            summary: "Redis Cluster has blocked clients"
            description: "Redis cluster {{ $labels.instance }} has {{ $value }} blocked clients"

{{- end }}