nameOverride: ""
fullnameOverride: ""

# Configuração global
global:
  domain: neural-hive.local
  environment: production

# Configuração do OpenTelemetry Collector
collector:
  enabled: true
  mode: deployment
  replicas: 2

  # Configurações de recursos
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi

  # Configurações de segurança
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534
    seccompProfile:
      type: RuntimeDefault

  # Anti-affinity para alta disponibilidade
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - neural-hive-otel-collector
          topologyKey: kubernetes.io/hostname

  # Service configuration
  service:
    type: ClusterIP
    ports:
      otlp:
        port: 4317
        targetPort: 4317
        protocol: TCP
        appProtocol: grpc
      otlp-http:
        port: 4318
        targetPort: 4318
        protocol: TCP
        appProtocol: http
      jaeger-grpc:
        port: 14250
        targetPort: 14250
        protocol: TCP
        appProtocol: grpc
      jaeger-thrift:
        port: 14268
        targetPort: 14268
        protocol: TCP
        appProtocol: http
      metrics:
        port: 8888
        targetPort: 8888
        protocol: TCP
        appProtocol: http
      health:
        port: 13133
        targetPort: 13133
        protocol: TCP
        appProtocol: http

  # Configuração do OpenTelemetry
  config:
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
        check_collector_pipeline:
          enabled: true
          interval: "5m"
          exporter_failure_threshold: 5
      pprof:
        endpoint: 0.0.0.0:1777
        block_profile_fraction: 0
        mutex_profile_fraction: 0
      zpages:
        endpoint: 0.0.0.0:55679
      memory_ballast:
        size_mib: 683
      # Resource detection para metadados automáticos
      resourcedetection:
        detectors: [env, system, k8snode, kubernetes]
        timeout: 2s
        override: false
        k8snode:
          auth_type: "serviceAccount"
        kubernetes:
          auth_type: "serviceAccount"
          node_from_env_var: "K8S_NODE_NAME"
          extract:
            metadata:
              - k8s.pod.name
              - k8s.pod.uid
              - k8s.deployment.name
              - k8s.namespace.name
              - k8s.node.name
              - k8s.pod.start_time
            annotations:
              - service_name: "neural.hive/service-name"
              - version: "neural.hive/version"
              - domain: "neural.hive/domain"
            labels:
              - service_version: "app.kubernetes.io/version"
              - team: "app.kubernetes.io/managed-by"

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      # Receiver para métricas Prometheus
      prometheus:
        config:
          global:
            scrape_interval: 15s
            evaluation_interval: 15s
          scrape_configs:
          - job_name: 'neural-hive-services'
            kubernetes_sd_configs:
            - role: pod
              namespaces:
                names:
                - default
                - neural-hive
                - gateway
            relabel_configs:
            - source_labels: [__meta_kubernetes_pod_annotation_neural_hive_metrics]
              action: keep
              regex: enabled
            - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
              action: replace
              target_label: __metrics_path__
              regex: (.+)
            - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
              action: replace
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              target_label: __address__
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)

      # Receiver para Jaeger traces
      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_http:
            endpoint: 0.0.0.0:14268

      # Receiver para logs via OTLP
      otlp/logs:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      # Memory limiter para evitar OOM
      memory_limiter:
        check_interval: 1s
        limit_mib: 1536

      # Batch processor para otimizar throughput
      batch:
        send_batch_size: 1024
        timeout: 10s
        send_batch_max_size: 2048

      # Resource processor para adicionar atributos padrão
      resource:
        attributes:
        - key: deployment.environment
          value: production
          action: upsert
        - key: service.namespace
          from_attribute: k8s.namespace.name
          action: insert
        - key: neural.hive.cluster
          value: main
          action: upsert

      # Processor para correlação Neural Hive-Mind
      attributes/neural_hive:
        actions:
        - key: neural.hive.intent.id
          from_attribute: http.request.header.x-neural-hive-intent-id
          action: upsert
        - key: neural.hive.plan.id
          from_attribute: http.request.header.x-neural-hive-plan-id
          action: upsert
        - key: neural.hive.domain
          from_attribute: http.request.header.x-neural-hive-domain
          action: upsert
        - key: neural.hive.user.id
          from_attribute: http.request.header.x-neural-hive-user-id
          action: upsert

      # Tail sampling otimizado para Neural Hive-Mind
      tail_sampling:
        decision_wait: 30s
        num_traces: 50000
        expected_new_traces_per_sec: 100
        policies:
        # Sempre manter traces com erro
        - name: neural_hive_errors
          type: status_code
          status_code:
            status_codes: [ERROR, UNSET]
        # Manter traces de alta latência (SLO violations)
        - name: neural_hive_high_latency
          type: latency
          latency:
            threshold_ms: 1000
        # Sampling alto para traces com intent_id (fluxos principais)
        - name: neural_hive_intent_traces
          type: and
          and:
            and_sub_policies:
            - name: has_intent_id
              type: string_attribute
              string_attribute:
                key: neural.hive.intent.id
                values: [".+"]
                enabled_regex_matching: true
            - name: intent_sampling
              type: probabilistic
              probabilistic:
                sampling_percentage: 50
        # Sampling alto para traces com plan_id (processamento cognitivo)
        - name: neural_hive_plan_traces
          type: and
          and:
            and_sub_policies:
            - name: has_plan_id
              type: string_attribute
              string_attribute:
                key: neural.hive.plan.id
                values: [".+"]
                enabled_regex_matching: true
            - name: plan_sampling
              type: probabilistic
              probabilistic:
                sampling_percentage: 30
        # Sampling específico por componente Neural Hive
        - name: neural_hive_gateway_sampling
          type: and
          and:
            and_sub_policies:
            - name: is_gateway
              type: string_attribute
              string_attribute:
                key: service.name
                values: ["gateway-intencoes"]
            - name: gateway_rate
              type: probabilistic
              probabilistic:
                sampling_percentage: 25
        # Sampling para traces de health checks (reduzido)
        - name: neural_hive_health_checks
          type: and
          and:
            and_sub_policies:
            - name: is_health_check
              type: string_attribute
              string_attribute:
                key: http.target
                values: ["/health", "/ready", "/metrics"]
            - name: health_rate
              type: probabilistic
              probabilistic:
                sampling_percentage: 1
        # Sampling geral para outros traces
        - name: neural_hive_general_sampling
          type: probabilistic
          probabilistic:
            sampling_percentage: 10

    exporters:
      # Prometheus exporter para métricas
      prometheus:
        endpoint: "0.0.0.0:8888"
        const_labels:
          cluster: neural-hive-main
        send_timestamps: true
        metric_expiration: 180m
        enable_open_metrics: true

      # Jaeger exporter para traces
      jaeger:
        endpoint: jaeger-collector:14250
        tls:
          insecure: true

      # OTLP exporter para backends externos
      otlp/traces:
        endpoint: jaeger-collector:4317
        tls:
          insecure: true
        headers:
          X-Neural-Hive-Source: "otel-collector"

      # Debug exporter para troubleshooting
      debug:
        verbosity: normal

      # Logging exporter para desenvolvimento
      logging:
        loglevel: info
        sampling_initial: 5
        sampling_thereafter: 200

    service:
      extensions: [health_check, pprof, zpages, memory_ballast, resourcedetection]
      pipelines:
        traces:
          receivers: [otlp, jaeger]
          processors: [memory_limiter, resource, attributes/neural_hive, tail_sampling, batch]
          exporters: [jaeger, otlp/traces]

        metrics:
          receivers: [otlp, prometheus]
          processors: [memory_limiter, resource, attributes/neural_hive, batch]
          exporters: [prometheus]

        logs:
          receivers: [otlp/logs]
          processors: [memory_limiter, resource, attributes/neural_hive, batch]
          exporters: [logging]

      telemetry:
        logs:
          level: "info"
        metrics:
          level: detailed
          address: 0.0.0.0:8888

# Configurações de monitoramento
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    labels:
      neural.hive/metrics: "enabled"
    interval: 30s
    scrapeTimeout: 10s
    path: /metrics

# Network policies
networkPolicy:
  enabled: true
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: neural-hive
      - namespaceSelector:
          matchLabels:
            name: gateway
      - namespaceSelector:
          matchLabels:
            name: istio-system
      ports:
      - protocol: TCP
        port: 4317
      - protocol: TCP
        port: 4318
      - protocol: TCP
        port: 14250
      - protocol: TCP
        port: 14268
  egress:
    - to:
      - namespaceSelector:
          matchLabels:
            name: observability
      ports:
      - protocol: TCP
        port: 9090  # Prometheus
      - protocol: TCP
        port: 14250 # Jaeger Collector

# Configurações de ambiente específicas
environments:
  development:
    collector:
      replicas: 1
      config:
        processors:
          tail_sampling:
            policies:
            - name: dev_sampling
              type: probabilistic
              probabilistic:
                sampling_percentage: 100

  staging:
    collector:
      replicas: 1
      config:
        processors:
          tail_sampling:
            policies:
            - name: staging_sampling
              type: probabilistic
              probabilistic:
                sampling_percentage: 50

  production:
    collector:
      replicas: 2
      config:
        processors:
          tail_sampling:
            policies:
            - name: prod_sampling
              type: probabilistic
              probabilistic:
                sampling_percentage: 10