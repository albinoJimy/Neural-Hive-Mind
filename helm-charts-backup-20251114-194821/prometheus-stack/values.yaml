nameOverride: ""
fullnameOverride: ""

# Configura√ß√£o global
global:
  domain: neural-hive.local
  environment: production
  cluster: neural-hive-main

# Configura√ß√£o do Prometheus
prometheus:
  enabled: true

  # Configura√ß√µes espec√≠ficas do Prometheus Operator
  prometheusOperator:
    enabled: true
    admissionWebhooks:
      enabled: true
      patch:
        enabled: true
    tlsProxy:
      enabled: false

  prometheus:
    enabled: true

    # Configura√ß√µes de alta disponibilidade
    prometheusSpec:
      replicas: 2
      retention: 30d
      retentionSize: 90GB

      # Storage
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: gp3
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 100Gi

      # Resources
      resources:
        limits:
          cpu: 2000m
          memory: 8Gi
        requests:
          cpu: 1000m
          memory: 4Gi

      # Service discovery rules
      serviceDiscoveryRules:
        endpoints: true
        services: true
        pods: true
        ingresses: false
        nodes: true

      # Configura√ß√£o avan√ßada de exemplars para correla√ß√£o com traces
      exemplars:
        max_exemplars: 100000
        # Configura√ß√£o otimizada para Neural Hive-Mind
        retention: 24h
        # Filtrar apenas m√©tricas com alta cardinalidade de trace correlation
        exemplar_config:
          filters:
          - regex: 'neural_hive_(request_duration|operation_duration)_seconds.*'
            action: keep
          - regex: 'neural_hive_(intent_processing|plan_generation)_duration_seconds.*'
            action: keep

      # Configura√ß√£o otimizada de remote write para Thanos (se habilitado)
      remoteWrite:
      - url: "$(THANOS_REMOTE_WRITE_URL)"
        name: thanos-sidecar
        writeRelabelConfigs:
        # Manter apenas m√©tricas essenciais para long-term storage
        - sourceLabels: [__name__]
          regex: 'neural_hive_(availability|latency|error_rate)_.*|up|prometheus_build_info'
          action: keep
        # Adicionar labels de cluster para multi-cluster federation
        - targetLabel: cluster
          replacement: "$(CLUSTER_NAME)"
        - targetLabel: environment
          replacement: "$(ENVIRONMENT)"
        queueConfig:
          capacity: 10000
          maxShards: 200
          minShards: 1
          maxSamplesPerSend: 2000
          batchSendDeadline: 5s
          minBackoff: 30ms
          maxBackoff: 100ms
          retryOnRateLimit: true
        metadataConfig:
          send: true
          sendInterval: 30s
          maxSamplesPerSend: 500

      # Configura√ß√£o de federation para m√∫ltiplas inst√¢ncias Prometheus
      federationTargets:
      - job_name: 'prometheus-federation'
        honor_labels: true
        metrics_path: /federate
        params:
          'match[]':
          - '{__name__=~"neural_hive_.*"}'
          - '{__name__=~"up|prometheus_.*"}'
          - '{__name__=~"alertmanager_.*"}'
        static_configs:
        - targets:
          - prometheus-dr.neural-hive.local:9090

      # Configura√ß√£o de query federation
      queryLogFile: "/prometheus/query.log"
      enableAdminAPI: true
      walCompression: true
      enableFeatures:
      - exemplar-storage
      - expand-external-labels
      - memory-snapshot-on-shutdown
      - promql-at-modifier
      - promql-negative-offset

      # Scrape configs espec√≠ficos para Neural Hive-Mind
      additionalScrapeConfigs:
      - job_name: 'neural-hive-services'
        scrape_interval: 15s
        scrape_timeout: 10s
        honor_labels: true
        honor_timestamps: true
        kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
            - neural-hive
            - gateway
            - default
        relabel_configs:
        - source_labels: [__meta_kubernetes_pod_annotation_neural_hive_metrics]
          action: keep
          regex: enabled
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: ${1}:${2}
          target_label: __address__
        - source_labels: [__meta_kubernetes_pod_label_neural_hive_component]
          target_label: neural_hive_component
        - source_labels: [__meta_kubernetes_pod_label_neural_hive_layer]
          target_label: neural_hive_layer
        - source_labels: [__meta_kubernetes_pod_label_neural_hive_domain]
          target_label: neural_hive_domain
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        metric_relabel_configs:
        # Drop m√©tricas de alta cardinalidade desnecess√°rias
        - source_labels: [__name__]
          regex: 'go_memstats_.*|process_.*|python_gc_.*'
          action: drop
        # Manter apenas m√©tricas relevantes do Neural Hive
        - source_labels: [__name__]
          regex: 'neural_hive_.*|up|scrape_.*'
          target_label: __tmp_neural_hive_metric
          replacement: 'true'
        # Configurar exemplars para correla√ß√£o
        - source_labels: [__name__]
          regex: 'neural_hive_(request_duration|operation_duration).*'
          target_label: __exemplar_enabled
          replacement: 'true'

      - job_name: 'opentelemetry-collector'
        static_configs:
        - targets: ['opentelemetry-collector:8888']
        scrape_interval: 10s
        scrape_timeout: 5s
        metrics_path: /metrics
        honor_labels: true
        static_labels:
          job: opentelemetry-collector
          neural_hive_component: telemetry-collector
        metric_relabel_configs:
        # Manter m√©tricas essenciais do OTel Collector
        - source_labels: [__name__]
          regex: 'otelcol_(receiver|processor|exporter)_.+|otelcol_process_.+'
          action: keep
        # Adicionar exemplars para m√©tricas de lat√™ncia
        - source_labels: [__name__]
          regex: 'otelcol_.*_duration.*'
          target_label: __exemplar_enabled
          replacement: 'true'

      - job_name: 'istio-mesh'
        kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
            - istio-system
        relabel_configs:
        - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: istio-proxy;http-monitoring
        - source_labels: [__address__, __meta_kubernetes_endpoint_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:15090
          target_label: __address__
        - action: labelmap
          regex: __meta_kubernetes_service_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: namespace
        - source_labels: [__meta_kubernetes_service_name]
          action: replace
          target_label: service_name

      # Regras de alertas customizadas
      ruleSelector:
        matchLabels:
          prometheus: kube-prometheus
          role: alert-rules

      # Configura√ß√µes de seguran√ßa
      securityContext:
        fsGroup: 2000
        runAsGroup: 2000
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault

      # Affinity para alta disponibilidade
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                - prometheus
            topologyKey: kubernetes.io/hostname

# AlertManager configuration
alertmanager:
  enabled: true

  alertmanagerSpec:
    replicas: 3

    # Storage
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: gp3
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi

    # Resources
    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 512Mi

    # Configura√ß√£o de alerting
    config:
      global:
        resolve_timeout: 5m
        smtp_smarthost: 'localhost:587'
        smtp_from: 'alertmanager@neural-hive.local'
        # Templates customizados para Neural Hive-Mind
        smtp_headers:
          Subject: '[Neural Hive-Mind] {{ .Status | toUpper }}{{ if eq .Status "firing" }}: {{ .Alerts.Firing | len }}{{ end }} - {{ .GroupLabels.SortedPairs.Values | join " " }}'

      # Templates espec√≠ficos para Neural Hive-Mind
      templates:
      - '/etc/alertmanager/config/*.tmpl'

      # Silence patterns para manuten√ß√µes
      silencePatterns:
      - comment: 'Manuten√ß√£o programada'
        matchers:
        - name: 'maintenance'
          value: 'true'
          isRegex: false

      route:
        group_by: ['neural_hive_component', 'neural_hive_layer', 'alertname']
        group_wait: 10s
        group_interval: 10s
        repeat_interval: 1h
        receiver: 'default'
        routes:
        # Alertas cr√≠ticos do Neural Hive-Mind
        - match:
            severity: critical
          receiver: 'neural-hive-critical'
          group_wait: 0s
          repeat_interval: 5m
        # Alertas de SLO
        - match_re:
            slo: ".*"
          receiver: 'neural-hive-slo'
          group_wait: 30s
          repeat_interval: 30m
        # Alertas por camada
        - match:
            neural_hive_layer: experiencia
          receiver: 'neural-hive-experiencia'
        - match:
            neural_hive_layer: cognicao
          receiver: 'neural-hive-cognicao'
        - match:
            neural_hive_layer: orquestracao
          receiver: 'neural-hive-orquestracao'
        - match:
            neural_hive_layer: execucao
          receiver: 'neural-hive-execucao'
        - match:
            neural_hive_layer: resiliencia
          receiver: 'neural-hive-resiliencia'
        # Alertas por especialista
        - match:
            specialist_type: technical
          receiver: 'neural-hive-specialist-technical'
        - match:
            specialist_type: business
          receiver: 'neural-hive-specialist-business'
        - match:
            specialist_type: behavior
          receiver: 'neural-hive-specialist-behavior'
        - match:
            specialist_type: evolution
          receiver: 'neural-hive-specialist-evolution'
        - match:
            specialist_type: architecture
          receiver: 'neural-hive-specialist-architecture'

      receivers:
      - name: 'default'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-alerts'
          title: 'Neural Hive-Mind Alert'
          text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

      - name: 'neural-hive-critical'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-critical'
          title: 'üö® CR√çTICO: Neural Hive-Mind'
          text: |
            *Alerta:* {{ .GroupLabels.alertname }}
            *Componente:* {{ .GroupLabels.neural_hive_component }}
            *Camada:* {{ .GroupLabels.neural_hive_layer }}
            *Severidade:* {{ .CommonLabels.severity }}
            {{ range .Alerts }}
            *Descri√ß√£o:* {{ .Annotations.description }}
            *Runbook:* {{ .Annotations.runbook_url }}
            {{ end }}
          actions:
          - type: button
            text: 'Ver Grafana'
            url: 'https://grafana.neural-hive.local'
          - type: button
            text: 'Ver Runbook'
            url: '{{ .CommonAnnotations.runbook_url }}'

      - name: 'neural-hive-slo'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-slo'
          title: 'üìä SLO Viola√ß√£o: Neural Hive-Mind'
          text: |
            *SLO:* {{ .GroupLabels.slo }}
            *Error Budget:* {{ .CommonAnnotations.error_budget }}
            {{ range .Alerts }}
            *M√©trica:* {{ .Annotations.summary }}
            *Valor Atual:* {{ .Annotations.current_value }}
            *SLO Target:* {{ .Annotations.slo_target }}
            {{ end }}

      # Receivers por camada
      - name: 'neural-hive-experiencia'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-experiencia'
          title: 'üéØ Camada Experi√™ncia'

      - name: 'neural-hive-cognicao'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-cognicao'
          title: 'üß† Camada Cogni√ß√£o'

      - name: 'neural-hive-orquestracao'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-orquestracao'
          title: 'üéº Camada Orquestra√ß√£o'

      - name: 'neural-hive-execucao'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-execucao'
          title: '‚ö° Camada Execu√ß√£o'

      - name: 'neural-hive-resiliencia'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-resiliencia'
          title: 'üõ°Ô∏è Camada Resili√™ncia'

      # Receivers por especialista
      - name: 'neural-hive-specialist-technical'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-specialist-technical'
          title: 'üîß Especialista T√©cnico'

      - name: 'neural-hive-specialist-business'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-specialist-business'
          title: 'üíº Especialista Business'

      - name: 'neural-hive-specialist-behavior'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-specialist-behavior'
          title: 'üë§ Especialista Behavior'

      - name: 'neural-hive-specialist-evolution'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-specialist-evolution'
          title: 'üìà Especialista Evolution'

      - name: 'neural-hive-specialist-architecture'
        slack_configs:
        - api_url: 'https://hooks.slack.com/services/PLACEHOLDER'
          channel: '#neural-hive-specialist-architecture'
          title: 'üèóÔ∏è Especialista Architecture'

      # Webhook receivers para integra√ß√£o externa
      - name: 'pagerduty-critical'
        pagerduty_configs:
        - service_key: '$(PAGERDUTY_SERVICE_KEY)'
          description: 'Neural Hive-Mind Critical Alert'
          details:
            component: '{{ .GroupLabels.neural_hive_component }}'
            layer: '{{ .GroupLabels.neural_hive_layer }}'
            cluster: '{{ .CommonLabels.cluster }}'
            environment: '{{ .CommonLabels.environment }}'

      - name: 'servicenow-integration'
        webhook_configs:
        - url: '$(SERVICENOW_WEBHOOK_URL)'
          http_config:
            bearer_token: '$(SERVICENOW_API_TOKEN)'
          send_resolved: true
          title: 'Neural Hive-Mind Incident'
          text: |
            Alert: {{ .GroupLabels.alertname }}
            Component: {{ .GroupLabels.neural_hive_component }}
            Severity: {{ .CommonLabels.severity }}
            {{ range .Alerts }}
            Description: {{ .Annotations.description }}
            {{ end }}

      inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['neural_hive_component', 'alertname']

# Grafana configuration (disabled - using standalone Grafana chart)
grafana:
  enabled: false

# Node Exporter
nodeExporter:
  enabled: true

# Kube State Metrics
kubeStateMetrics:
  enabled: true

# Service monitors customizados
serviceMonitor:
  enabled: true

  # Labels para sele√ß√£o
  selector:
    matchLabels:
      neural.hive/metrics: "enabled"

  # Configura√ß√µes de scraping
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    honorLabels: true

# Configura√ß√µes de rede
networkPolicy:
  enabled: true

  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: neural-hive
    - namespaceSelector:
        matchLabels:
          name: gateway
    ports:
    - protocol: TCP
      port: 9090  # Prometheus
    - protocol: TCP
      port: 3000  # Grafana
    - protocol: TCP
      port: 9093  # AlertManager

# Configura√ß√µes de backup
backup:
  enabled: true
  schedule: "0 2 * * *"
  retention: 30
  storage:
    class: gp3
    size: 50Gi

# SLOs espec√≠ficos do Neural Hive-Mind
slos:
  barramento_latency:
    target: 0.15  # 150ms
    window: 5m

  availability:
    target: 0.999  # 99.9%
    window: 5m

  plan_generation:
    target: 0.12  # 120ms
    window: 5m

  capture_latency:
    target: 0.2   # 200ms
    window: 5m

# Configura√ß√µes espec√≠ficas por ambiente
environments:
  development:
    prometheus:
      retention: 7d
      storage: 20Gi
    alertmanager:
      replicas: 1
    grafana:
      replicas: 1

  staging:
    prometheus:
      retention: 15d
      storage: 50Gi
    alertmanager:
      replicas: 2
    grafana:
      replicas: 1

  production:
    prometheus:
      retention: 30d
      storage: 100Gi
    alertmanager:
      replicas: 3
    grafana:
      replicas: 2