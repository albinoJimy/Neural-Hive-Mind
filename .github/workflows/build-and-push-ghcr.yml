name: Build and Push to GHCR

on:
  push:
    branches: [main, develop]
    paths:
      - 'services/**'
      - 'libraries/**'
      - 'schemas/**'
      - 'base-images/**'
      - '.github/workflows/build-and-push-ghcr.yml'

  pull_request:
    branches: [main, develop]
    paths:
      - 'services/**'
      - 'libraries/**'

  workflow_dispatch:
    inputs:
      services:
        description: 'Servicos especificos (separados por virgula, vazio = todos)'
        required: false
        type: string
        default: ''
      version_tag:
        description: 'Tag da versao (ex: 1.0.8, latest)'
        required: false
        type: string
        default: 'latest'
      skip_tests:
        description: 'Pular testes'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/neural-hive-mind

jobs:
  # ============================================================================
  # Job 1: Detectar servicos modificados
  # ============================================================================
  detect-changes:
    name: Detectar Mudancas
    # Usar self-hosted runner no cluster K8s
    runs-on: [self-hosted, linux, kubernetes, neural-hive]
    outputs:
      services_matrix: ${{ steps.set-matrix.outputs.matrix }}
      services_list: ${{ steps.set-matrix.outputs.list }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar servicos modificados
        id: set-matrix
        run: |
          # Lista completa de servicos
          ALL_SERVICES=(
            "analyst-agents"
            "code-forge"
            "execution-ticket-service"
            "explainability-api"
            "gateway-intencoes"
            "guard-agents"
            "mcp-tool-catalog"
            "memory-layer-api"
            "orchestrator-dynamic"
            "queen-agent"
            "scout-agents"
            "self-healing-engine"
            "service-registry"
            "sla-management-system"
            "consensus-engine"
            "semantic-translation-engine"
            "worker-agents"
            "optimizer-agents"
            "approval-service"
          )

          # Se workflow_dispatch com servicos especificos
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.services }}" ]]; then
            IFS=',' read -ra SERVICES <<< "${{ inputs.services }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # workflow_dispatch sem servicos = todos
            SERVICES=("${ALL_SERVICES[@]}")
          else
            # Detectar modificados via git diff
            SERVICES=()
            for svc in "${ALL_SERVICES[@]}"; do
              if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "services/${svc}/"; then
                SERVICES+=("$svc")
              fi
            done
            
            # Se libraries ou schemas modificados, rebuildar todos
            if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -qE "^(libraries|schemas)/"; then
              echo "Libraries ou schemas modificados - rebuildando todos os servicos"
              SERVICES=("${ALL_SERVICES[@]}")
            fi
          fi

          # Se nenhum servico detectado
          if [[ ${#SERVICES[@]} -eq 0 ]]; then
            echo "Nenhum servico para buildar"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "list=" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Criar matriz JSON
          MATRIX_JSON=$(printf '%s\n' "${SERVICES[@]}" | jq -R -s -c 'split("\n") | map(select(. != ""))')
          LIST=$(IFS=','; echo "${SERVICES[*]}")

          echo "matrix=${MATRIX_JSON}" >> $GITHUB_OUTPUT
          echo "list=${LIST}" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT

          echo "Servicos a buildar: ${#SERVICES[@]}"
          echo "${MATRIX_JSON}" | jq .

  # ============================================================================
  # Job 2: Build e Push das imagens
  # ============================================================================
  build-and-push:
    name: Build ${{ matrix.service }}
    runs-on: [self-hosted, linux, kubernetes, neural-hive]
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services_matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
          buildkitd-config-inline: |
            [registry."37.60.241.150:30500"]
              http = true
              insecure = true

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extrair metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=raw,value=${{ inputs.version_tag || 'latest' }}
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}

      - name: Verificar Dockerfile
        id: check-dockerfile
        run: |
          DOCKERFILE_PATH="services/${{ matrix.service }}/Dockerfile"
          if [[ -f "$DOCKERFILE_PATH" ]]; then
            echo "dockerfile_exists=true" >> $GITHUB_OUTPUT
            echo "dockerfile_path=$DOCKERFILE_PATH" >> $GITHUB_OUTPUT
          else
            echo "dockerfile_exists=false" >> $GITHUB_OUTPUT
            echo "Dockerfile nao encontrado: $DOCKERFILE_PATH"
          fi

      - name: Preparar contexto de build
        if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
        run: |
          # Alguns Dockerfiles referenciam imagens base do registry antigo
          # Vamos verificar e ajustar se necessario
          DOCKERFILE="services/${{ matrix.service }}/Dockerfile"
          
          # Verificar se usa imagem base do registry interno
          if grep -q "37.60.241.150:30500" "$DOCKERFILE"; then
            echo "AVISO: Dockerfile usa registry interno, pode precisar de ajuste"
          fi

      - name: Build e Push
        if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/${{ matrix.service }}/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            VERSION=${{ inputs.version_tag || 'latest' }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Verificar imagem
        if: steps.check-dockerfile.outputs.dockerfile_exists == 'true' && github.event_name != 'pull_request'
        run: |
          echo "Imagem publicada:"
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ inputs.version_tag || 'latest' }}"
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ github.sha }}"

  # ============================================================================
  # Job 3: Resumo e notificacao
  # ============================================================================
  summary:
    name: Resumo do Build
    runs-on: [self-hosted, linux, kubernetes, neural-hive]
    needs: [detect-changes, build-and-push]
    if: always()

    steps:
      - name: Gerar resumo
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.detect-changes.outputs.has_changes }}" == "true" ]]; then
            echo "### Servicos Buildados" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Servico | Imagem |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
            
            IFS=',' read -ra SERVICES <<< "${{ needs.detect-changes.outputs.services_list }}"
            for svc in "${SERVICES[@]}"; do
              echo "| $svc | ghcr.io/${{ env.IMAGE_PREFIX }}/$svc |" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "Nenhum servico foi buildado (sem mudancas detectadas)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Proximos Passos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Para usar as imagens no cluster:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# 1. Criar secret para GHCR (se ainda nao existe)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl create secret docker-registry ghcr-secret \\" >> $GITHUB_STEP_SUMMARY
          echo "  --docker-server=ghcr.io \\" >> $GITHUB_STEP_SUMMARY
          echo "  --docker-username=<GITHUB_USER> \\" >> $GITHUB_STEP_SUMMARY
          echo "  --docker-password=<GITHUB_TOKEN> \\" >> $GITHUB_STEP_SUMMARY
          echo "  -n neural-hive" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 2. Atualizar deployment" >> $GITHUB_STEP_SUMMARY
          echo "kubectl set image deployment/<SERVICE> \\" >> $GITHUB_STEP_SUMMARY
          echo "  <SERVICE>=ghcr.io/${{ env.IMAGE_PREFIX }}/<SERVICE>:${{ github.sha }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  -n neural-hive" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Notificar sucesso
        if: needs.build-and-push.result == 'success'
        run: |
          echo "Build completed successfully!"

      - name: Notificar falha
        if: needs.build-and-push.result == 'failure'
        run: |
          echo "Build failed - check logs for details"
          exit 1
