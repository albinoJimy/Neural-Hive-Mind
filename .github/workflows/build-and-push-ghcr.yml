name: Build and Push to GHCR

on:
  push:
    branches: [main, develop]
    paths:
      - 'services/**'
      - 'libraries/**'
      - 'schemas/**'
      - 'base-images/**'
      - '.github/workflows/build-and-push-ghcr.yml'

  pull_request:
    branches: [main, develop]
    paths:
      - 'services/**'
      - 'libraries/**'

  workflow_dispatch:
    inputs:
      services:
        description: 'Servicos especificos (separados por virgula, vazio = todos)'
        required: false
        type: string
        default: ''
      version_tag:
        description: 'Tag sem√¢ntica da vers√£o (ex: v1.2.3, v2.0.0-beta.1). Formato: v?MAJOR.MINOR.PATCH[-prerelease][+build]'
        required: false
        type: string
        default: 'latest'
      skip_tests:
        description: 'Pular testes'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/neural-hive-mind

jobs:
  # ============================================================================
  # Job 1: Detectar servicos modificados
  # ============================================================================
  detect-changes:
    name: Detectar Mudancas
    runs-on: self-hosted
    outputs:
      services_matrix: ${{ steps.set-matrix.outputs.matrix }}
      services_list: ${{ steps.set-matrix.outputs.list }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validar formato semver
        if: github.event_name == 'workflow_dispatch' && inputs.version_tag != '' && inputs.version_tag != 'latest'
        run: |
          VERSION_TAG="${{ inputs.version_tag }}"
          # Regex para semver: v?MAJOR.MINOR.PATCH[-prerelease][+build]
          SEMVER_REGEX="^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$"

          if [[ ! "$VERSION_TAG" =~ $SEMVER_REGEX ]]; then
            echo "‚ùå Erro: version_tag '$VERSION_TAG' n√£o √© um formato semver v√°lido"
            echo ""
            echo "Formatos v√°lidos:"
            echo "  - v1.2.3"
            echo "  - 1.2.3"
            echo "  - v2.0.0-alpha.1"
            echo "  - v1.0.0-beta.2+build.123"
            echo ""
            echo "Formatos inv√°lidos:"
            echo "  - v1.2 (falta PATCH)"
            echo "  - latest-v1 (formato incorreto)"
            echo "  - 1.2.3.4 (muitos d√≠gitos)"
            exit 1
          fi

          echo "‚úÖ version_tag '$VERSION_TAG' validado com sucesso"

      - name: Detectar servicos modificados
        id: set-matrix
        run: |
          # Lista completa de servicos
          ALL_SERVICES=(
            "analyst-agents"
            "code-forge"
            "execution-ticket-service"
            "explainability-api"
            "gateway-intencoes"
            "guard-agents"
            "mcp-tool-catalog"
            "memory-layer-api"
            "orchestrator-dynamic"
            "queen-agent"
            "scout-agents"
            "self-healing-engine"
            "service-registry"
            "sla-management-system"
            "consensus-engine"
            "semantic-translation-engine"
            "worker-agents"
            "optimizer-agents"
            "approval-service"
          )

          # Se workflow_dispatch com servicos especificos
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.services }}" ]]; then
            IFS=',' read -ra SERVICES <<< "${{ inputs.services }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # workflow_dispatch sem servicos = todos
            SERVICES=("${ALL_SERVICES[@]}")
          else
            # Detectar modificados via git diff
            SERVICES=()
            for svc in "${ALL_SERVICES[@]}"; do
              if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "services/${svc}/"; then
                SERVICES+=("$svc")
              fi
            done
            
            # Se libraries ou schemas modificados, rebuildar todos
            if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -qE "^(libraries|schemas)/"; then
              echo "Libraries ou schemas modificados - rebuildando todos os servicos"
              SERVICES=("${ALL_SERVICES[@]}")
            fi
          fi

          # Se nenhum servico detectado
          if [[ ${#SERVICES[@]} -eq 0 ]]; then
            echo "Nenhum servico para buildar"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "list=" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Criar matriz JSON
          MATRIX_JSON=$(printf '%s\n' "${SERVICES[@]}" | jq -R -s -c 'split("\n") | map(select(. != ""))')
          LIST=$(IFS=','; echo "${SERVICES[*]}")

          echo "matrix=${MATRIX_JSON}" >> $GITHUB_OUTPUT
          echo "list=${LIST}" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT

          echo "Servicos a buildar: ${#SERVICES[@]}"
          echo "${MATRIX_JSON}" | jq .

  # ============================================================================
  # Job 2: Build e Push das imagens
  # ============================================================================
  build-and-push:
    name: Build ${{ matrix.service }}
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services_matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Aviso sobre pol√≠tica de push em PRs
        if: github.event_name == 'pull_request'
        run: |
          echo "## ‚ö†Ô∏è Aviso: Pull Request - Build sem Push" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Este build foi disparado por um **Pull Request**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### O que acontecer√°:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Build da imagem ser√° executado normalmente" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Testes e valida√ß√µes ser√£o realizados" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå **Imagem N√ÉO ser√° enviada para o registry GHCR**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Por qu√™?" >> $GITHUB_STEP_SUMMARY
          echo "Por seguran√ßa, apenas c√≥digo revisado e aprovado √© publicado no registry." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Como fazer push ap√≥s aprova√ß√£o do PR:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Op√ß√£o 1: Merge do PR (recomendado)" >> $GITHUB_STEP_SUMMARY
          echo "# O merge autom√°tico dispara build com push" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Op√ß√£o 2: Workflow manual" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run build-and-push-ghcr.yml \\" >> $GITHUB_STEP_SUMMARY
          echo "  --ref ${{ github.head_ref }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  -f services=\"${{ matrix.service }}\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  -f version_tag=\"v1.x.x\"" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Set lowercase owner
        id: owner
        run: echo "lowercase=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Verificar Dockerfile
        id: check-dockerfile
        run: |
          DOCKERFILE_PATH="services/${{ matrix.service }}/Dockerfile"
          if [[ -f "$DOCKERFILE_PATH" ]]; then
            echo "dockerfile_exists=true" >> $GITHUB_OUTPUT
            echo "dockerfile_path=$DOCKERFILE_PATH" >> $GITHUB_OUTPUT
          else
            echo "dockerfile_exists=false" >> $GITHUB_OUTPUT
            echo "Dockerfile nao encontrado: $DOCKERFILE_PATH"
          fi

      - name: Set up Docker Buildx
        if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login no GHCR
        if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          # CR_PAT √© necess√°rio para criar novos pacotes, GITHUB_TOKEN para atualizar existentes
          password: ${{ secrets.CR_PAT || secrets.GITHUB_TOKEN }}

      - name: Extract version from values.yaml
        if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
        id: version
        run: |
          VALUES_FILE="helm-charts/${{ matrix.service }}/values.yaml"
          if [[ -f "$VALUES_FILE" ]]; then
            # Extrair tag do values.yaml (formato: tag: "1.2.3" ou tag: 1.2.3)
            VERSION=$(grep -E "^\s*tag:" "$VALUES_FILE" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
            if [[ -n "$VERSION" && "$VERSION" != "latest" ]]; then
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "has_version=true" >> $GITHUB_OUTPUT
              echo "üì¶ Vers√£o extra√≠da do values.yaml: $VERSION"
            else
              echo "has_version=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è Nenhuma vers√£o semver encontrada no values.yaml"
            fi
          else
            echo "has_version=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Arquivo values.yaml n√£o encontrado"
          fi

      - name: Extract metadata
        if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.owner.outputs.lowercase }}/neural-hive-mind/${{ matrix.service }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.has_version == 'true' && github.ref == 'refs/heads/main' }}
            type=raw,value=${{ inputs.version_tag }},enable=${{ github.event_name == 'workflow_dispatch' && inputs.version_tag != '' && inputs.version_tag != 'latest' }}
            type=semver,pattern={{version}},value=${{ inputs.version_tag }},enable=${{ github.event_name == 'workflow_dispatch' && startsWith(inputs.version_tag, 'v') }}
            type=semver,pattern={{major}}.{{minor}},value=${{ inputs.version_tag }},enable=${{ github.event_name == 'workflow_dispatch' && startsWith(inputs.version_tag, 'v') }}

      - name: Build e Push
        if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/${{ matrix.service }}/Dockerfile
          # ============================================================================
          # POL√çTICA DE SEGURAN√áA - PUSH PARA REGISTRY
          # ============================================================================
          # Pull Requests: Build √© executado para valida√ß√£o, mas N√ÉO faz push para o registry.
          #                Isso previne que c√≥digo n√£o revisado seja publicado.
          #
          # Push em branches: Build E push s√£o executados automaticamente.
          #
          # Workflow manual: Build E push s√£o executados com controle total de vers√£o.
          #                  Use workflow_dispatch para for√ßar build/push de PRs ap√≥s revis√£o.
          # ============================================================================
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            REGISTRY=ghcr.io/${{ steps.owner.outputs.lowercase }}
            VERSION=${{ inputs.version_tag || 'latest' }}
            CACHE_BUST=${{ github.sha }}
          # TEMP: Desabilitar cache para for√ßar rebuild limpo
          # Problema: cache GHA estava servindo layers com c√≥digo antigo
          # TODO: Reativar ap√≥s confirmar fix do erro "too many values to unpack"
          no-cache: true
          # cache-from: type=gha
          # cache-to: type=gha,mode=max

  # ============================================================================
  # Job 3: Resumo e notificacao
  # ============================================================================
  summary:
    name: Resumo do Build
    runs-on: self-hosted
    needs: [detect-changes, build-and-push]
    if: always()

    steps:
      - name: Gerar resumo
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version Tag:** ${{ inputs.version_tag || 'auto (latest/sha)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.detect-changes.outputs.has_changes }}" == "true" ]]; then
            echo "### Servicos Buildados" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Servico | Imagem |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

            # Determinar tag para exibi√ß√£o
            VERSION_TAG="${{ inputs.version_tag }}"
            if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "$VERSION_TAG" && "$VERSION_TAG" != "latest" ]]; then
              DISPLAY_TAG="$VERSION_TAG"
            else
              DISPLAY_TAG="latest"
            fi

            IFS=',' read -ra SERVICES <<< "${{ needs.detect-changes.outputs.services_list }}"
            for svc in "${SERVICES[@]}"; do
              echo "| $svc | ghcr.io/${{ env.IMAGE_PREFIX }}/$svc:$DISPLAY_TAG |" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "Nenhum servico foi buildado (sem mudancas detectadas)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Proximos Passos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Para usar as imagens no cluster:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# 1. Criar secret para GHCR (se ainda nao existe)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl create secret docker-registry ghcr-secret \\" >> $GITHUB_STEP_SUMMARY
          echo "  --docker-server=ghcr.io \\" >> $GITHUB_STEP_SUMMARY
          echo "  --docker-username=<GITHUB_USER> \\" >> $GITHUB_STEP_SUMMARY
          echo "  --docker-password=<GITHUB_TOKEN> \\" >> $GITHUB_STEP_SUMMARY
          echo "  -n neural-hive" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 2. Atualizar deployment" >> $GITHUB_STEP_SUMMARY
          echo "kubectl set image deployment/<SERVICE> \\" >> $GITHUB_STEP_SUMMARY
          echo "  <SERVICE>=ghcr.io/${{ env.IMAGE_PREFIX }}/<SERVICE>:${{ github.sha }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  -n neural-hive" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "### ‚ö†Ô∏è Pol√≠tica de Push" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Build executado, mas imagens **N√ÉO foram enviadas** para o registry." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Para publicar as imagens ap√≥s aprova√ß√£o do PR:" >> $GITHUB_STEP_SUMMARY
            echo "1. Fa√ßa merge do PR (dispara build autom√°tico com push)" >> $GITHUB_STEP_SUMMARY
            echo "2. Ou use workflow_dispatch manualmente (veja documenta√ß√£o)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ Imagens Publicadas" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Registry:** ghcr.io/${{ env.IMAGE_PREFIX }}" >> $GITHUB_STEP_SUMMARY
            echo "**Tags geradas:** latest, SHA, branch" >> $GITHUB_STEP_SUMMARY
            if [[ -n "${{ inputs.version_tag }}" && "${{ inputs.version_tag }}" != "latest" ]]; then
              echo "**Vers√£o sem√¢ntica:** ${{ inputs.version_tag }}" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Notificar sucesso
        if: needs.build-and-push.result == 'success'
        run: |
          echo "Build completed successfully!"

      - name: Notificar falha
        if: needs.build-and-push.result == 'failure'
        run: |
          echo "Build failed - check logs for details"
          exit 1

      - name: Salvar lista de servi√ßos buildados
        if: needs.detect-changes.outputs.has_changes == 'true'
        run: |
          mkdir -p build-info
          echo "${{ needs.detect-changes.outputs.services_list }}" > build-info/services.txt
          echo "${{ github.sha }}" > build-info/commit-sha.txt
          echo "${{ inputs.version_tag || '' }}" > build-info/version-tag.txt

      - name: Upload artifact com informa√ß√µes do build
        if: needs.detect-changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: build-info/
          retention-days: 1

  # ============================================================================
  # Job 4: Disparar Deployment Autom√°tico
  # ============================================================================
  trigger-deployment:
    name: Disparar Deployment
    runs-on: self-hosted
    needs: [detect-changes, build-and-push, summary]
    if: github.event_name != 'pull_request' && needs.build-and-push.result == 'success' && needs.detect-changes.outputs.has_changes == 'true'

    permissions:
      actions: write
      contents: read

    steps:
      - name: Determinar ambiente
        id: env
        run: |
          BRANCH="${{ github.ref_name }}"
          case "$BRANCH" in
            main|master)
              echo "environment=staging" >> $GITHUB_OUTPUT
              ;;
            develop)
              echo "environment=staging" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "environment=development" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Determinar tag da imagem
        id: tag
        run: |
          VERSION_TAG="${{ inputs.version_tag }}"
          if [[ -n "$VERSION_TAG" && "$VERSION_TAG" != "latest" ]]; then
            echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Disparar Deploy workflow
        env:
          GH_TOKEN: ${{ secrets.CR_PAT }}
        run: |
          SERVICES="${{ needs.detect-changes.outputs.services_list }}"
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          IMAGE_TAG=$(echo "${{ steps.tag.outputs.tag }}" | cut -c1-7)

          echo "Disparando deploy para: $SERVICES"
          echo "Ambiente: $ENVIRONMENT"
          echo "Tag: $IMAGE_TAG"

          gh workflow run deploy-after-build.yml \
            --ref "${{ github.ref_name }}" \
            -f environment="$ENVIRONMENT" \
            -f services="$SERVICES" \
            -f image_tag="$IMAGE_TAG"

          echo "‚úÖ Deploy workflow disparado com sucesso!"

      - name: Gerar resumo
        run: |
          echo "## üöÄ Deployment Autom√°tico Disparado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configura√ß√£o | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Servi√ßos** | ${{ needs.detect-changes.outputs.services_list }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ambiente** | ${{ steps.env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | ${{ steps.tag.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Acompanhe: **Actions > Deploy After Build**" >> $GITHUB_STEP_SUMMARY
