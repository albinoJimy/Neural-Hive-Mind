name: Build Parallel Matrix

on:
  push:
    branches: [main, develop]
    paths:
      - 'base-images/**'
      - 'services/**'
      - 'libraries/**'
      - 'scripts/build/**'
      - 'scripts/lib/**'
      - '.github/workflows/build-parallel-matrix.yml'

  pull_request:
    branches: [main, develop]
    paths:
      - 'base-images/**'
      - 'services/**'
      - 'libraries/**'
      - 'scripts/build/**'
      - 'scripts/lib/**'

  workflow_dispatch:
    inputs:
      services:
        description: 'Servi√ßos espec√≠ficos (separados por v√≠rgula, vazio = todos modificados)'
        required: false
        type: string
      no_cache:
        description: 'Build sem cache'
        required: false
        default: false
        type: boolean
      smart_build:
        description: 'Habilitar smart build com self-healing'
        required: false
        default: true
        type: boolean
      push_metrics:
        description: 'Enviar m√©tricas para Prometheus'
        required: false
        default: true
        type: boolean

env:
  DOCKER_BUILDKIT: 1
  REGISTRY_PRIMARY: registry.neural-hive.local:5000
  REGISTRY_SECONDARY: 37.60.241.150:30500

jobs:
  detect-changes:
    name: Detectar Mudan√ßas
    runs-on: ubuntu-latest
    outputs:
      base_images_changed: ${{ steps.changes.outputs.base_images }}
      services_matrix: ${{ steps.build-matrix.outputs.services_matrix }}
      services_count: ${{ steps.build-matrix.outputs.services_count }}
      libraries_changed: ${{ steps.changes.outputs.libraries }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar mudan√ßas por path
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            base_images:
              - 'base-images/**'
            services:
              - 'services/**'
            libraries:
              - 'libraries/**'

      - name: Identificar servi√ßos modificados
        id: changed-services
        if: steps.changes.outputs.services == 'true' || steps.changes.outputs.libraries == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # Usar script existente de detec√ß√£o de mudan√ßas
          source scripts/build/changed-services.sh

          # Se workflow_dispatch com servi√ßos espec√≠ficos, priorizar inputs.services
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.services }}" ]]; then
            echo "services=${{ github.event.inputs.services }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && -z "${{ github.event.inputs.services }}" ]]; then
            # workflow_dispatch sem servi√ßos espec√≠ficos: buildar todos os servi√ßos
            all_services="gateway-intencoes,semantic-translation-engine,specialist-business,specialist-technical,specialist-behavior,specialist-evolution,specialist-architecture,consensus-engine,memory-layer-api,orchestrator-dynamic,queen-agent,worker-agents,code-forge,service-registry,execution-ticket-service,scout-agents,analyst-agents,guard-agents,sla-management-system,mcp-tool-catalog,self-healing-engine,explainability-api"
            echo "services=${all_services}" >> $GITHUB_OUTPUT
          else
            # Detectar servi√ßos modificados
            changed=$(get_services_to_build "HEAD~1" \
              gateway-intencoes semantic-translation-engine \
              specialist-business specialist-technical specialist-behavior \
              specialist-evolution specialist-architecture consensus-engine \
              memory-layer-api orchestrator-dynamic queen-agent worker-agents \
              code-forge service-registry execution-ticket-service \
              scout-agents analyst-agents guard-agents sla-management-system \
              mcp-tool-catalog self-healing-engine explainability-api)
            echo "services=${changed}" >> $GITHUB_OUTPUT
          fi

      - name: Construir matrix de servi√ßos
        id: build-matrix
        run: |
          services="${{ steps.changed-services.outputs.services }}"

          if [[ -z "$services" ]]; then
            echo "services_matrix=[]" >> $GITHUB_OUTPUT
            echo "services_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Converter para array JSON
          json_array=$(echo "$services" | tr ',' '\n' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          count=$(echo "$json_array" | jq 'length')

          echo "services_matrix=${json_array}" >> $GITHUB_OUTPUT
          echo "services_count=${count}" >> $GITHUB_OUTPUT

          echo "üì¶ Servi√ßos a buildar: ${count}"
          echo "${json_array}" | jq .

  build-base-images:
    name: Build Imagens Base
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.base_images_changed == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Cache Docker layers (base images)
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache-base
          key: ${{ runner.os }}-buildx-base-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-base-

      - name: Build imagens base
        run: |
          ./scripts/build.sh \
            --target local \
            --skip-base-images=false \
            --version ${{ github.sha }} \
            --parallel 4

      - name: Salvar lista de imagens base
        run: |
          docker images --filter "reference=neural-hive-mind/*-base" \
            --format "{{.Repository}}:{{.Tag}}" > /tmp/base-images-built.txt
          cat /tmp/base-images-built.txt

      - name: Upload artifact de imagens base
        uses: actions/upload-artifact@v4
        with:
          name: base-images-list
          path: /tmp/base-images-built.txt
          retention-days: 1

  build-services-matrix:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-images]
    if: |
      always() &&
      needs.detect-changes.outputs.services_count > 0 &&
      (needs.build-base-images.result == 'success' || needs.build-base-images.result == 'skipped')

    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services_matrix) }}
      max-parallel: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache-${{ matrix.service }}
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-

      - name: Build com Smart Build
        id: smart-build
        env:
          SERVICE: ${{ matrix.service }}
          SMART_BUILD: ${{ github.event.inputs.smart_build || 'true' }}
          METRICS_DIR: /tmp/metrics
        run: |
          mkdir -p /tmp/metrics

          source scripts/lib/common.sh
          source scripts/lib/docker.sh
          source scripts/build/smart-build.sh
          source scripts/build/services.sh

          export DOCKER_BUILD_LOG_FILE="/tmp/build-${{ matrix.service }}.log"

          no_cache=""
          if [[ "${{ github.event.inputs.no_cache }}" == "true" ]]; then
            no_cache="--no-cache"
          fi

          start_time=$(date +%s)

          if [[ "$SMART_BUILD" == "true" ]]; then
            smart_build_service "${{ matrix.service }}" "${{ github.sha }}" "$no_cache"
            build_result=$?
          else
            build_service "${{ matrix.service }}" "${{ github.sha }}" "$no_cache"
            build_result=$?
          fi

          end_time=$(date +%s)
          duration=$((end_time - start_time))

          echo "build_result=${build_result}" >> $GITHUB_OUTPUT
          echo "duration=${duration}" >> $GITHUB_OUTPUT

          if [[ $build_result -eq 0 ]]; then
            echo "‚úÖ Build bem-sucedido: ${{ matrix.service }} (${duration}s)"
          else
            echo "‚ùå Build falhou: ${{ matrix.service }}"
            exit 1
          fi

      - name: Coletar tamanho da imagem
        if: success()
        run: |
          size=$(docker image inspect "neural-hive-mind/${{ matrix.service }}:${{ github.sha }}" \
            --format='{{.Size}}' 2>/dev/null || echo "0")
          echo "Tamanho da imagem: $(numfmt --to=iec-i --suffix=B $size)"

      - name: Upload m√©tricas
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-metrics-${{ matrix.service }}
          path: /tmp/metrics/build-metrics-*.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload logs de build
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.service }}
          path: /tmp/build-${{ matrix.service }}.log
          retention-days: 7
          if-no-files-found: ignore

  push-images:
    name: Push Imagens
    runs-on: ubuntu-latest
    needs: [detect-changes, build-services-matrix]
    if: |
      always() &&
      needs.build-services-matrix.result == 'success' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services_matrix) }}
      max-parallel: 6

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login no registry prim√°rio
        if: ${{ secrets.REGISTRY_USERNAME != '' && secrets.REGISTRY_PASSWORD != '' }}
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY_PRIMARY }} \
            -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin || true

      - name: Login no registry secund√°rio
        if: ${{ secrets.REGISTRY_SECONDARY_USERNAME != '' && secrets.REGISTRY_SECONDARY_PASSWORD != '' }}
        run: |
          echo "${{ secrets.REGISTRY_SECONDARY_PASSWORD }}" | docker login ${{ env.REGISTRY_SECONDARY }} \
            -u "${{ secrets.REGISTRY_SECONDARY_USERNAME }}" --password-stdin || true

      - name: Configurar credenciais AWS (ECR)
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Login no ECR
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION || 'us-east-1' }} | \
            docker login --username AWS --password-stdin \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION || 'us-east-1' }}.amazonaws.com || true

      - name: Push para registry com fallback
        run: |
          source scripts/lib/common.sh
          source scripts/lib/docker.sh

          docker_push_with_fallback \
            "neural-hive-mind/${{ matrix.service }}:${{ github.sha }}" \
            "neural-hive-mind/${{ matrix.service }}" \
            "${{ github.sha }}"

          # Push tag latest tamb√©m
          docker_push_with_fallback \
            "neural-hive-mind/${{ matrix.service }}:latest" \
            "neural-hive-mind/${{ matrix.service }}" \
            "latest"

  collect-metrics:
    name: Agregar e Enviar M√©tricas
    runs-on: ubuntu-latest
    needs: [detect-changes, build-services-matrix, push-images]
    if: always() && github.event.inputs.push_metrics != 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download todas as m√©tricas
        uses: actions/download-artifact@v4
        with:
          pattern: build-metrics-*
          path: /tmp/metrics
          merge-multiple: true

      - name: Agregar e enviar m√©tricas
        env:
          PROMETHEUS_PUSHGATEWAY_URL: ${{ secrets.PROMETHEUS_PUSHGATEWAY_URL }}
        run: |
          source scripts/lib/common.sh
          source scripts/lib/metrics.sh

          echo "üìä Arquivos de m√©tricas encontrados:"
          find /tmp/metrics -name "*.json" -type f | head -20

          # Criar resumo do build
          create_build_summary_metrics "/tmp/metrics"

          # Enviar para Prometheus (se configurado)
          if [[ -n "$PROMETHEUS_PUSHGATEWAY_URL" ]]; then
            push_build_metrics "/tmp/metrics"
          else
            echo "‚ö†Ô∏è PROMETHEUS_PUSHGATEWAY_URL n√£o configurado, pulando envio"
          fi

      - name: Upload resumo de m√©tricas
        uses: actions/upload-artifact@v4
        with:
          name: build-summary
          path: /tmp/metrics/build-summary.json
          retention-days: 30
          if-no-files-found: ignore

  notify:
    name: Notificar Resultado
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-images, build-services-matrix, push-images, collect-metrics]
    if: always()

    steps:
      - name: Resumo do Build
        run: |
          echo "## üì¶ Resultado do Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detectar Mudan√ßas | ${{ needs.detect-changes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Base Images | ${{ needs.build-base-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Services | ${{ needs.build-services-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Push Images | ${{ needs.push-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| M√©tricas | ${{ needs.collect-metrics.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          services_count="${{ needs.detect-changes.outputs.services_count }}"
          echo "**Servi√ßos buildados:** ${services_count:-0}" >> $GITHUB_STEP_SUMMARY

      - name: Notificar falha
        if: failure()
        run: |
          echo "‚ùå Build falhou - verificar logs para detalhes"
          # Aqui pode adicionar integra√ß√£o com Slack/Discord/etc
