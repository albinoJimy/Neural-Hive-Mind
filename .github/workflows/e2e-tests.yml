name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *"

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      localstack:
        image: localstack/localstack:3.0
        ports:
          - 4566:4566
        env:
          SERVICES: s3
          DEFAULT_REGION: us-east-1
          EDGE_PORT: 4566
        options: >-
          --health-cmd="curl -s http://localhost:4566/_localstack/health | grep -q '\"s3\": \"running\"'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=6

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Setup Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: neural-hive-e2e
          config: tests/e2e/kind-config.yaml

      - name: Install dependencies
        run: |
          pip install -r tests/requirements-test.txt

      - name: Install External Security Tools
        run: |
          # Install Snyk CLI
          curl -o /usr/local/bin/snyk https://static.snyk.io/cli/latest/snyk-linux
          chmod +x /usr/local/bin/snyk

          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.45.0

          # Verify installations
          snyk --version || echo "Snyk not available (token required)"
          trivy --version

      - name: Setup LocalStack S3 bucket
        run: |
          pip install awscli-local
          awslocal s3 mb s3://code-forge-artifacts-test
          awslocal s3api put-bucket-versioning \
            --bucket code-forge-artifacts-test \
            --versioning-configuration Status=Enabled
          echo "‚úÖ LocalStack S3 bucket created"

      - name: Run Code Forge Integration Tests
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SONARQUBE_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd services/code-forge
          pip install -r requirements.txt
          pytest tests/test_snyk_client_integration.py tests/test_trivy_client_integration.py tests/test_git_client_integration.py -v --tb=short || true

      - name: Run Code Forge S3 Integration Tests
        env:
          ARTIFACTS_S3_ENDPOINT: http://localhost:4566
          ARTIFACTS_S3_BUCKET: code-forge-artifacts-test
          ARTIFACTS_S3_REGION: us-east-1
          LOCALSTACK_AVAILABLE: "true"
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
        run: |
          cd services/code-forge
          pytest tests/integration/test_s3_sbom_upload.py -v --tb=short -m integration

      - name: Run MCP Tool Catalog Stdio Transport Tests
        run: |
          cd services/mcp-tool-catalog
          pip install -r requirements.txt
          pytest tests/test_mcp_server_client.py::TestStdioTransport -v --tb=short
          pytest tests/e2e/test_mcp_stdio_real.py -v --tb=short --log-cli-level=INFO

      - name: Deploy infrastructure to Kind
        run: |
          kubectl apply -f k8s/infrastructure/
          kubectl apply -f k8s/
          kubectl wait --for=condition=ready pod --all --timeout=300s

      - name: Run Phase 1 E2E Tests
        run: ./tests/run-tests.sh --type e2e --phase 1 --report --coverage

      - name: Run Avro Flow E2E Tests
        run: |
          pytest tests/e2e/test_avro_flow_complete.py \
            -v \
            --tb=short \
            --junit-xml=tests/results/avro-flow-junit.xml \
            --cov=services/semantic-translation-engine \
            --cov=services/consensus-engine \
            --cov-report=xml:tests/results/avro-flow-coverage.xml \
            --log-cli-level=INFO
        timeout-minutes: 15

      - name: Upload Avro Flow Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: avro-flow-test-results
          path: tests/results/avro-flow-*.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-results
          path: tests/results/

      - name: Verify coverage files exist
        if: always()
        run: |
          echo "üìä Verificando arquivos de cobertura..."
          ls -la tests/results/ || echo "Diret√≥rio tests/results/ n√£o existe"
          if [ -f "tests/results/avro-flow-coverage.xml" ]; then
            echo "‚úÖ Arquivo avro-flow-coverage.xml encontrado"
          else
            echo "‚ö†Ô∏è Arquivo avro-flow-coverage.xml n√£o encontrado"
          fi

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: tests/results/avro-flow-coverage.xml
          flags: e2e,avro-flow
          fail_ci_if_error: false

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name neural-hive-e2e
