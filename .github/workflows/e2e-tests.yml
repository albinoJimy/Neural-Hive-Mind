name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *"

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Setup Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: neural-hive-e2e
          config: tests/e2e/kind-config.yaml

      - name: Install dependencies
        run: |
          pip install -r tests/requirements-test.txt

      - name: Deploy infrastructure to Kind
        run: |
          kubectl apply -f k8s/infrastructure/
          kubectl apply -f k8s/
          kubectl wait --for=condition=ready pod --all --timeout=300s

      - name: Run Phase 1 E2E Tests
        run: ./tests/run-tests.sh --type e2e --phase 1 --report --coverage

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-results
          path: tests/results/

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: tests/results/coverage/coverage.xml
          flags: e2e

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name neural-hive-e2e
