name: Phase 2 Secrets Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      mode:
        description: 'Secret generation mode'
        required: true
        type: choice
        options:
          - static
          - vault
      dry_run:
        description: 'Dry run (generate files only)'
        required: false
        type: boolean
        default: false
      validate_only:
        description: 'Only validate existing secrets'
        required: false
        type: boolean
        default: false

  pull_request:
    paths:
      - 'scripts/security.sh'
      - 'scripts/security/modules/secrets.sh'
      - 'scripts/security/modules/vault.sh'
      - 'k8s/bootstrap/namespaces-phase2.yaml'
      - '.github/workflows/phase2-secrets-setup.yaml'

env:
  KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}

jobs:
  validate-scripts:
    name: Validate Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate shell scripts
        run: |
          echo "Validating shell scripts..."

          # Check syntax do CLI unificado
          bash -n scripts/security.sh
          bash -n scripts/security/modules/secrets.sh
          bash -n scripts/security/modules/vault.sh

          echo "All scripts validated successfully"

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          additional_files: 'security.sh security/modules/secrets.sh security/modules/vault.sh'

  validate-kubernetes-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Validate namespaces manifest
        run: |
          kubeval k8s/bootstrap/namespaces-phase2.yaml --strict

  dry-run-secrets:
    name: Dry Run - Generate Secret Files
    runs-on: ubuntu-latest
    needs: [validate-scripts, validate-kubernetes-manifests]
    if: github.event_name == 'pull_request' || github.event.inputs.dry_run == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate secrets (dry-run)
        run: |
          mkdir -p /tmp/phase2-secrets

          # Usar CLI unificado de seguranÃ§a
          ./scripts/security.sh secrets create \
            --phase 2 \
            --mode static \
            --environment dev \
            --dry-run \
            --output-dir /tmp/phase2-secrets

          echo "Generated secret files:"
          find /tmp/phase2-secrets -name "*.yaml" -type f

      - name: Validate generated manifests
        run: |
          # Install kubeval if not present
          if ! command -v kubeval &> /dev/null; then
            wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
            tar xf kubeval-linux-amd64.tar.gz
            sudo mv kubeval /usr/local/bin/
          fi

          # Validate all generated secrets
          for file in $(find /tmp/phase2-secrets -name "*.yaml" -type f); do
            echo "Validating: $file"
            kubeval "$file" --strict || echo "Warning: $file validation failed"
          done

      - name: Upload generated secrets as artifact
        uses: actions/upload-artifact@v4
        with:
          name: phase2-secrets-dry-run
          path: /tmp/phase2-secrets/
          retention-days: 7

  create-secrets-staging:
    name: Create Secrets (Staging)
    runs-on: ubuntu-latest
    needs: [validate-scripts, validate-kubernetes-manifests]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging' && github.event.inputs.dry_run == 'false' && github.event.inputs.validate_only == 'false'
    environment: staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_STAGING_BASE64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespaces
        run: |
          kubectl apply -f k8s/bootstrap/namespaces-phase2.yaml

      - name: Create secrets
        run: |
          ./scripts/security.sh secrets create \
            --phase 2 \
            --mode ${{ github.event.inputs.mode }} \
            --environment staging

      - name: Validate secrets
        run: |
          ./scripts/security.sh secrets validate \
            --phase 2 \
            --report-file ./reports/staging-secrets-validation.txt

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: staging-secrets-validation
          path: ./reports/staging-secrets-validation.txt

  create-secrets-production:
    name: Create Secrets (Production)
    runs-on: ubuntu-latest
    needs: [validate-scripts, validate-kubernetes-manifests]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production' && github.event.inputs.dry_run == 'false' && github.event.inputs.validate_only == 'false'
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION_BASE64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Install Vault CLI
        if: github.event.inputs.mode == 'vault'
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install vault

      - name: Authenticate with Vault
        if: github.event.inputs.mode == 'vault'
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        run: |
          # Use JWT/OIDC authentication for GitHub Actions
          vault login -method=jwt role=github-actions jwt="${{ secrets.GITHUB_TOKEN }}"

      - name: Populate Vault secrets
        if: github.event.inputs.mode == 'vault'
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          # Production secrets from GitHub Secrets
          ORCH_POSTGRES_PASSWORD: ${{ secrets.ORCH_POSTGRES_PASSWORD }}
          ORCH_MONGODB_URI: ${{ secrets.ORCH_MONGODB_URI }}
          QUEEN_NEO4J_PASSWORD: ${{ secrets.QUEEN_NEO4J_PASSWORD }}
          CF_OPENAI_API_KEY: ${{ secrets.CF_OPENAI_API_KEY }}
          CF_ANTHROPIC_API_KEY: ${{ secrets.CF_ANTHROPIC_API_KEY }}
          CF_GIT_TOKEN: ${{ secrets.CF_GIT_TOKEN }}
          WORKER_ARGOCD_TOKEN: ${{ secrets.WORKER_ARGOCD_TOKEN }}
          SHE_PAGERDUTY_API_KEY: ${{ secrets.SHE_PAGERDUTY_API_KEY }}
          SHE_SLACK_WEBHOOK_URL: ${{ secrets.SHE_SLACK_WEBHOOK_URL }}
          MCP_GITHUB_TOKEN: ${{ secrets.MCP_GITHUB_TOKEN }}
          MCP_GITLAB_TOKEN: ${{ secrets.MCP_GITLAB_TOKEN }}
        run: |
          ./scripts/security.sh vault populate \
            --mode vault \
            --environment production

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespaces
        run: |
          kubectl apply -f k8s/bootstrap/namespaces-phase2.yaml

      - name: Create secrets
        run: |
          ./scripts/security.sh secrets create \
            --phase 2 \
            --mode ${{ github.event.inputs.mode }} \
            --environment production

      - name: Validate secrets
        run: |
          ./scripts/security.sh secrets validate \
            --phase 2 \
            --report-file ./reports/production-secrets-validation.txt

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: production-secrets-validation
          path: ./reports/production-secrets-validation.txt

  validate-existing-secrets:
    name: Validate Existing Secrets
    runs-on: ubuntu-latest
    needs: [validate-scripts]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.validate_only == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "${{ secrets.KUBECONFIG_PRODUCTION_BASE64 }}" | base64 -d > ~/.kube/config
          else
            echo "${{ secrets.KUBECONFIG_STAGING_BASE64 }}" | base64 -d > ~/.kube/config
          fi
          chmod 600 ~/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info

      - name: Validate secrets
        run: |
          ./scripts/security.sh secrets validate \
            --phase 2 \
            --verbose \
            --report-file ./reports/${{ github.event.inputs.environment }}-secrets-validation.txt

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.environment }}-secrets-validation
          path: ./reports/${{ github.event.inputs.environment }}-secrets-validation.txt

      - name: Check validation result
        run: |
          if grep -q "Some secrets are missing or invalid" ./reports/${{ github.event.inputs.environment }}-secrets-validation.txt; then
            echo "::error::Secrets validation failed. Check the validation report."
            exit 1
          fi
          echo "All secrets validated successfully!"

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [create-secrets-staging, create-secrets-production, validate-existing-secrets]
    if: failure()
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Phase 2 Secrets Setup Failed - ${process.env.GITHUB_RUN_NUMBER}`;
            const body = `
            ## Workflow Failed

            **Workflow:** ${process.env.GITHUB_WORKFLOW}
            **Run:** ${process.env.GITHUB_RUN_NUMBER}
            **Environment:** ${{ github.event.inputs.environment || 'N/A' }}
            **Mode:** ${{ github.event.inputs.mode || 'N/A' }}

            Please check the [workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) for details.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['secrets', 'infrastructure', 'bug']
            });
