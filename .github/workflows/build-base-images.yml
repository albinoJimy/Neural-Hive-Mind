name: Build Base Images

on:
  workflow_dispatch:
    inputs:
      images:
        description: 'Imagens a buildar (separadas por virgula, vazio = todas)'
        required: false
        type: string
        default: ''
      version:
        description: 'Tag da versao'
        required: false
        type: string
        default: '1.0.7'
  push:
    branches: [main]
    paths:
      - 'base-images/**'
      - 'libraries/python/neural_hive_observability/**'
      - 'libraries/python/neural_hive_domain/**'
      - 'libraries/python/neural_hive_specialists/**'
      - '.github/workflows/build-base-images.yml'

env:
  GHCR_REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/neural-hive-mind

jobs:
  select-runner:
    name: Select Runner with Auto Fallback
    uses: ./.github/workflows/_runner-select.yml
    secrets: inherit

  build-base-images:
    name: Build Imagens Base
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          # CR_PAT é necessário para criar novos pacotes, GITHUB_TOKEN para atualizar existentes
          password: ${{ secrets.CR_PAT || secrets.GITHUB_TOKEN }}

      - name: Determinar imagens a buildar
        id: images
        run: |
          if [[ -n "${{ inputs.images }}" ]]; then
            IFS=',' read -ra IMAGES <<< "${{ inputs.images }}"
          else
            IMAGES=(
              "python-ml-base"
              "python-observability-base"
              "python-grpc-base"
              "python-mlops-base"
              "python-nlp-base"
              "python-specialist-base"
            )
          fi

          echo "images=${IMAGES[*]}" >> $GITHUB_OUTPUT
          echo "Imagens a buildar: ${IMAGES[*]}"

      # ============================================================================
      # NOTA: Ordem de build é CRITICAL devido a dependências
      # ============================================================================
      # python-ml-base (base, sem dependências internas)
      # python-observability-base (base, sem dependências internas)
      # python-grpc-base → depende de python-ml-base
      # python-nlp-base → depende de python-grpc-base
      # python-specialist-base → depende de python-nlp-base

      # ===== python-ml-base =====
      - name: Build python-ml-base
        if: contains(steps.images.outputs.images, 'python-ml-base')
        env:
          OWNER_LC: ${{ github.repository_owner }}
          VERSION_INPUT: ${{ inputs.version }}
        run: |
          OWNER_LOWER=$(echo "${OWNER_LC}" | tr '[:upper:]' '[:lower:]')
          VERSION="${VERSION_INPUT:-1.0.7}"
          IMAGE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-ml-base"

          echo "=== Building python-ml-base ==="
          docker buildx build \
            --build-arg VERSION=${VERSION} \
            --cache-from=type=registry,ref=${IMAGE}:buildcache \
            --cache-to=type=registry,ref=${IMAGE}:buildcache,mode=max \
            --push \
            -t ${IMAGE}:${VERSION} \
            -t ${IMAGE}:latest \
            -f base-images/python-ml-base/Dockerfile \
            .

      # ===== python-observability-base =====
      - name: Build python-observability-base
        if: contains(steps.images.outputs.images, 'python-observability-base')
        env:
          OWNER_LC: ${{ github.repository_owner }}
        run: |
          OWNER_LOWER=$(echo "${OWNER_LC}" | tr '[:upper:]' '[:lower:]')
          IMAGE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-observability-base"

          echo "=== Building python-observability-base ==="
          docker buildx build \
            --build-arg VERSION=1.2.6 \
            --cache-from=type=registry,ref=${IMAGE}:buildcache \
            --cache-to=type=registry,ref=${IMAGE}:buildcache,mode=max \
            --push \
            -t ${IMAGE}:1.2.6 \
            -t ${IMAGE}:latest \
            -f base-images/python-observability-base/Dockerfile \
            .

      # ===== python-grpc-base (depende de python-ml-base) =====
      - name: Build python-grpc-base
        if: contains(steps.images.outputs.images, 'python-grpc-base')
        env:
          OWNER_LC: ${{ github.repository_owner }}
          VERSION_INPUT: ${{ inputs.version }}
        run: |
          OWNER_LOWER=$(echo "${OWNER_LC}" | tr '[:upper:]' '[:lower:]')
          VERSION="${VERSION_INPUT:-1.0.7}"
          IMAGE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-grpc-base"
          ML_BASE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-ml-base"

          echo "=== Building python-grpc-base (depends on: python-ml-base) ==="
          echo "Verifying base image availability..."
          docker pull ${ML_BASE}:latest || echo "Warning: Could not pull base image"

          docker buildx build \
            --build-arg REGISTRY=${{ env.GHCR_REGISTRY }}/${OWNER_LOWER} \
            --build-arg VERSION=${VERSION} \
            --cache-from=type=registry,ref=${IMAGE}:buildcache \
            --cache-to=type=registry,ref=${IMAGE}:buildcache,mode=max \
            --push \
            -t ${IMAGE}:${VERSION} \
            -t ${IMAGE}:latest \
            -f base-images/python-grpc-base/Dockerfile \
            .

      # ===== python-mlops-base (depende de python-grpc-base) =====
      - name: Build python-mlops-base
        if: contains(steps.images.outputs.images, 'python-mlops-base')
        env:
          OWNER_LC: ${{ github.repository_owner }}
          VERSION_INPUT: ${{ inputs.version }}
        run: |
          OWNER_LOWER=$(echo "${OWNER_LC}" | tr '[:upper:]' '[:lower:]')
          VERSION="${VERSION_INPUT:-1.0.7}"
          IMAGE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-mlops-base"
          GRPC_BASE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-grpc-base"

          echo "=== Building python-mlops-base (depends on: python-grpc-base) ==="
          echo "Verifying base image availability..."
          docker pull ${GRPC_BASE}:latest || echo "Warning: Could not pull base image"

          docker buildx build \
            --build-arg REGISTRY=${{ env.GHCR_REGISTRY }}/${OWNER_LOWER} \
            --build-arg VERSION=${VERSION} \
            --cache-from=type=registry,ref=${IMAGE}:buildcache \
            --cache-to=type=registry,ref=${IMAGE}:buildcache,mode=max \
            --push \
            -t ${IMAGE}:${VERSION} \
            -t ${IMAGE}:latest \
            -f base-images/python-mlops-base/Dockerfile \
            .

      # ===== python-nlp-base (depende de python-grpc-base) =====
      - name: Build python-nlp-base
        if: contains(steps.images.outputs.images, 'python-nlp-base')
        env:
          OWNER_LC: ${{ github.repository_owner }}
          VERSION_INPUT: ${{ inputs.version }}
        run: |
          OWNER_LOWER=$(echo "${OWNER_LC}" | tr '[:upper:]' '[:lower:]')
          VERSION="${VERSION_INPUT:-1.0.7}"
          IMAGE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-nlp-base"
          GRPC_BASE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-grpc-base"

          echo "=== Building python-nlp-base (depends on: python-grpc-base) ==="
          echo "Verifying base image availability..."
          docker pull ${GRPC_BASE}:latest || echo "Warning: Could not pull base image"

          docker buildx build \
            --build-arg REGISTRY=${{ env.GHCR_REGISTRY }}/${OWNER_LOWER} \
            --build-arg VERSION=${VERSION} \
            --cache-from=type=registry,ref=${IMAGE}:buildcache \
            --cache-to=type=registry,ref=${IMAGE}:buildcache,mode=max \
            --push \
            -t ${IMAGE}:${VERSION} \
            -t ${IMAGE}:latest \
            -f base-images/python-nlp-base/Dockerfile \
            .

      # ===== python-specialist-base (depende de python-nlp-base) =====
      - name: Build python-specialist-base
        if: contains(steps.images.outputs.images, 'python-specialist-base')
        env:
          OWNER_LC: ${{ github.repository_owner }}
          VERSION_INPUT: ${{ inputs.version }}
        run: |
          OWNER_LOWER=$(echo "${OWNER_LC}" | tr '[:upper:]' '[:lower:]')
          VERSION="${VERSION_INPUT:-1.0.7}"
          IMAGE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-specialist-base"
          NLP_BASE="${{ env.GHCR_REGISTRY }}/${OWNER_LOWER}/neural-hive-mind/python-nlp-base"

          echo "=== Building python-specialist-base (depends on: python-nlp-base) ==="
          echo "Verifying base image availability..."
          docker pull ${NLP_BASE}:latest || echo "Warning: Could not pull base image"

          docker buildx build \
            --build-arg REGISTRY=${{ env.GHCR_REGISTRY }}/${OWNER_LOWER} \
            --build-arg VERSION=${VERSION} \
            --cache-from=type=registry,ref=${IMAGE}:buildcache \
            --cache-to=type=registry,ref=${IMAGE}:buildcache,mode=max \
            --push \
            -t ${IMAGE}:${VERSION} \
            -t ${IMAGE}:latest \
            -f base-images/python-specialist-base/Dockerfile \
            .

      - name: Resumo
        run: |
          echo "## Build Base Images Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GHCR (${{ env.GHCR_REGISTRY }})" >> $GITHUB_STEP_SUMMARY
          echo "| Imagem | Tags |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| python-ml-base | ${{ inputs.version || '1.0.7' }}, latest |" >> $GITHUB_STEP_SUMMARY
          echo "| python-observability-base | 1.2.6, latest |" >> $GITHUB_STEP_SUMMARY
          echo "| python-grpc-base | ${{ inputs.version || '1.0.7' }}, latest |" >> $GITHUB_STEP_SUMMARY
          echo "| python-mlops-base | ${{ inputs.version || '1.0.7' }}, latest |" >> $GITHUB_STEP_SUMMARY
          echo "| python-nlp-base | ${{ inputs.version || '1.0.7' }}, latest |" >> $GITHUB_STEP_SUMMARY
          echo "| python-specialist-base | ${{ inputs.version || '1.0.7' }}, latest |" >> $GITHUB_STEP_SUMMARY
