name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *"

jobs:
  # =============================================================================
  # ML Integration Tests - Required Gate Before Deploy
  # =============================================================================
  ml-integration-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ml-${{ hashFiles('tests/requirements-test.txt', 'services/orchestrator-dynamic/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-ml-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r tests/requirements-test.txt
          # Instalar bibliotecas locais na ordem correta de depend√™ncias
          pip install -e libraries/python/neural_hive_resilience
          pip install -e libraries/security
          pip install -e libraries/python/neural_hive_ml
          pip install -e libraries/neural_hive_integration
          # Instalar requirements filtrando paths absolutos do Docker
          grep -v '^/libraries' services/orchestrator-dynamic/requirements.txt | pip install -r /dev/stdin
          pip install scikit-learn pandas numpy mlflow pytest-asyncio motor

      - name: Verify MongoDB connection
        run: |
          pip install pymongo
          python -c "from pymongo import MongoClient; c = MongoClient('mongodb://localhost:27017'); c.admin.command('ping'); print('MongoDB conectado')"

      - name: Run ML Integration Tests (Staging Gate)
        env:
          MONGODB_URI: mongodb://localhost:27017
          MLFLOW_TRACKING_URI: file:///tmp/mlflow_test
          PYTHONPATH: services/orchestrator-dynamic/src
        run: |
          echo "üîí Running ML Integration Tests as Staging Gate..."
          pytest tests/integration/ml/ \
            -v \
            --tb=short \
            -m "ml_integration" \
            --junit-xml=tests/results/ml-staging-gate-junit.xml \
            --cov=services/orchestrator-dynamic/src/ml \
            --cov-report=xml:tests/results/ml-staging-gate-coverage.xml \
            --log-cli-level=INFO \
            --strict-markers
        timeout-minutes: 20

      - name: Upload ML Integration Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ml-staging-gate-results
          path: tests/results/ml-staging-gate-*.xml

      - name: ML Staging Gate Summary
        if: always()
        run: |
          echo "## üîí ML Integration Tests - Staging Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "tests/results/ml-staging-gate-junit.xml" ]; then
            echo "‚úÖ ML Integration Tests PASSED - Deploy gate approved" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå ML Integration Tests FAILED - Deploy gate BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Production deployment is blocked until ML integration tests pass." >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # E2E Tests - Requires ML Integration Gate
  # Nota: Timeout aumentado para 180 minutos conforme suite E2E atualizada
  # (120-170 min documentado em tests/e2e/README.md)
  # =============================================================================
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    needs: ml-integration-gate  # Requires ML tests to pass first

    services:
      localstack:
        image: localstack/localstack:2.3.2
        ports:
          - 4566:4566
        env:
          SERVICES: s3
        options: >-
          --health-cmd="curl -sf http://localhost:4566/_localstack/health || exit 1"
          --health-interval=5s
          --health-timeout=10s
          --health-retries=20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Setup Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: neural-hive-e2e
          config: tests/e2e/kind-config.yaml

      - name: Install dependencies
        run: |
          pip install -r tests/requirements-test.txt

          # Instalar bibliotecas locais na ordem correta de depend√™ncias
          pip install -e libraries/python/neural_hive_resilience
          pip install -e libraries/security
          pip install -e libraries/neural_hive_integration

          # Depend√™ncia adicional para testes E2E
          pip install aiohttp

      - name: Install External Security Tools
        run: |
          # Install Snyk CLI
          curl -o /usr/local/bin/snyk https://static.snyk.io/cli/latest/snyk-linux
          chmod +x /usr/local/bin/snyk

          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.45.0

          # Verify installations
          snyk --version || echo "Snyk not available (token required)"
          trivy --version

      - name: Setup LocalStack S3 bucket
        run: |
          pip install awscli-local
          awslocal s3 mb s3://code-forge-artifacts-test
          awslocal s3api put-bucket-versioning \
            --bucket code-forge-artifacts-test \
            --versioning-configuration Status=Enabled
          echo "‚úÖ LocalStack S3 bucket created"

      - name: Run Code Forge Integration Tests
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SONARQUBE_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd services/code-forge
          pip install -r requirements.txt
          pytest tests/test_snyk_client_integration.py tests/test_trivy_client_integration.py tests/test_git_client_integration.py -v --tb=short || true

      - name: Run Code Forge S3 Integration Tests
        env:
          ARTIFACTS_S3_ENDPOINT: http://localhost:4566
          ARTIFACTS_S3_BUCKET: code-forge-artifacts-test
          ARTIFACTS_S3_REGION: us-east-1
          LOCALSTACK_AVAILABLE: "true"
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
        run: |
          cd services/code-forge
          pytest tests/integration/test_s3_sbom_upload.py -v --tb=short -m integration

      - name: Run MCP Tool Catalog Stdio Transport Tests
        run: |
          cd services/mcp-tool-catalog
          pip install -r requirements.txt
          pytest tests/test_mcp_server_client.py::TestStdioTransport -v --tb=short
          pytest tests/e2e/test_mcp_stdio_real.py -v --tb=short --log-cli-level=INFO

      - name: Deploy infrastructure to Kind
        run: |
          # Aplicar namespaces primeiro
          kubectl apply -f k8s/infrastructure/ || true
          kubectl apply -f k8s/bootstrap/namespaces.yaml || true

          # Criar namespaces adicionais que faltam
          kubectl create namespace clickhouse --dry-run=client -o yaml | kubectl apply -f - || true
          kubectl create namespace keycloak --dry-run=client -o yaml | kubectl apply -f - || true
          kubectl create namespace mlflow --dry-run=client -o yaml | kubectl apply -f - || true

          # Aplicar apenas manifests K8s v√°lidos (excluindo JSON, values.yaml, e recursos que requerem CRDs)
          for f in k8s/*.yaml; do
            # Pular ficheiros que n√£o s√£o manifests K8s ou requerem CRDs ausentes
            case "$f" in
              *values.yaml|*-local.yaml|*kafka*.yaml|*clickhouse-ml-schema.yaml)
                echo "‚è≠Ô∏è  Skipping $f (requires CRDs or is not for E2E)"
                continue
                ;;
            esac
            echo "üì¶ Applying $f"
            kubectl apply -f "$f" 2>&1 | grep -v "ServiceMonitor\|Probe\|ensure CRDs" || true
          done

          # Aguardar pods ficarem ready (com timeout e ignorando falhas)
          echo "‚è≥ Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod --all --all-namespaces --timeout=120s 2>/dev/null || echo "‚ö†Ô∏è Some pods not ready, continuing..."

      - name: Run Phase 1 E2E Tests
        continue-on-error: true  # E2E tests require full infrastructure not available in CI
        run: ./tests/run-tests.sh --type e2e --phase 1 --report --coverage

      - name: Run Avro Flow E2E Tests
        continue-on-error: true  # Requires Schema Registry and Kafka
        run: |
          pytest tests/e2e/test_avro_flow_complete.py \
            -v \
            --tb=short \
            --junit-xml=tests/results/avro-flow-junit.xml \
            --cov=services/semantic-translation-engine \
            --cov=services/consensus-engine \
            --cov-report=xml:tests/results/avro-flow-coverage.xml \
            --log-cli-level=INFO
        timeout-minutes: 15

      - name: Run Approval Flow E2E Tests
        continue-on-error: true  # Requires full infrastructure
        run: |
          cd services/semantic-translation-engine
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true
          pytest tests/e2e/test_approval_flow.py \
            -v \
            --tb=short \
            -m "e2e and approval_flow and not slow" \
            --junit-xml=../../tests/results/approval-flow-junit.xml \
            --cov=src \
            --cov-report=xml:../../tests/results/approval-flow-coverage.xml \
            --log-cli-level=INFO
        timeout-minutes: 10

      - name: Upload Approval Flow Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: approval-flow-test-results
          path: tests/results/approval-flow-*.xml

      - name: Upload Avro Flow Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: avro-flow-test-results
          path: tests/results/avro-flow-*.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: tests/results/

      - name: Verify coverage files exist
        if: always()
        run: |
          echo "üìä Verificando arquivos de cobertura..."
          ls -la tests/results/ || echo "Diret√≥rio tests/results/ n√£o existe"
          if [ -f "tests/results/avro-flow-coverage.xml" ]; then
            echo "‚úÖ Arquivo avro-flow-coverage.xml encontrado"
          else
            echo "‚ö†Ô∏è Arquivo avro-flow-coverage.xml n√£o encontrado"
          fi

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: tests/results/avro-flow-coverage.xml,tests/results/approval-flow-coverage.xml
          flags: e2e,avro-flow,approval-flow
          fail_ci_if_error: false

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name neural-hive-e2e
