name: Validate Infrastructure
# NOTA: Este workflow mantém validações diretas (Terraform/Helm/OPA) por serem melhores práticas específicas do domínio.

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'infrastructure/**'
      - 'helm-charts/**'
      - 'policies/**'
      - 'k8s/**'
      - 'environments/**'
      - '.github/workflows/validate-infrastructure.yml'
  workflow_dispatch:

env:
  TF_VERSION: "1.5"
  GOLANG_VERSION: "1.21"
  HELM_VERSION: "v3.12.0"

jobs:
  select-runner:
    name: Select Runner with Auto Fallback
    uses: ./.github/workflows/_runner-select.yml
    secrets: inherit

  terraform-validate:
    name: Terraform Validation
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Cache Terraform
        uses: actions/cache@v3
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/.terraform
          key: ${{ runner.os }}-terraform-${{ hashFiles('infrastructure/terraform/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Terraform Format Check
        working-directory: infrastructure/terraform
        run: terraform fmt -check -recursive

      - name: Terraform Init (Root)
        working-directory: infrastructure/terraform
        run: terraform init -backend=false

      - name: Terraform Validate (Root)
        working-directory: infrastructure/terraform
        run: terraform validate

      - name: Terraform Init (Network Module)
        working-directory: infrastructure/terraform/modules/network
        run: terraform init -backend=false

      - name: Terraform Validate (Network Module)
        working-directory: infrastructure/terraform/modules/network
        run: terraform validate

      - name: Terraform Init (K8s Cluster Module)
        working-directory: infrastructure/terraform/modules/k8s-cluster
        run: terraform init -backend=false

      - name: Terraform Validate (K8s Cluster Module)
        working-directory: infrastructure/terraform/modules/k8s-cluster
        run: terraform validate

      - name: Terraform Init (Container Registry Module)
        working-directory: infrastructure/terraform/modules/container-registry
        run: terraform init -backend=false

      - name: Terraform Validate (Container Registry Module)
        working-directory: infrastructure/terraform/modules/container-registry
        run: terraform validate

  tflint:
    name: TFLint
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache TFLint plugin dir
        uses: actions/cache@v3
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.48.0

      - name: Show TFLint version
        run: tflint --version

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint (Root)
        working-directory: infrastructure/terraform
        run: tflint --format compact

      - name: Run TFLint (Network Module)
        working-directory: infrastructure/terraform/modules/network
        run: tflint --format compact

      - name: Run TFLint (K8s Cluster Module)
        working-directory: infrastructure/terraform/modules/k8s-cluster
        run: tflint --format compact

      - name: Run TFLint (Container Registry Module)
        working-directory: infrastructure/terraform/modules/container-registry
        run: tflint --format compact

  checkov-security:
    name: Checkov Security Scan
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Checkov action
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infrastructure/terraform
          framework: terraform
          output_format: sarif
          output_file_path: reports/results.sarif
          soft_fail: true

      - name: Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/results.sarif

  helm-lint:
    name: Helm Lint
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Lint Istio Base Chart
        run: helm lint helm-charts/istio-base

      - name: Lint OPA Gatekeeper Chart
        run: helm lint helm-charts/opa-gatekeeper

      - name: Template Istio Base Chart (Dev)
        run: |
          helm template istio-base helm-charts/istio-base \
            --values environments/dev/helm-values/istio-values.yaml \
            --namespace istio-system

      - name: Template OPA Gatekeeper Chart
        run: |
          helm template opa-gatekeeper helm-charts/opa-gatekeeper \
            --namespace gatekeeper-system

  opa-test:
    name: OPA Policy Testing
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GOLANG_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.57.0/opa_linux_amd64_static
          chmod 755 ./opa
          sudo mv opa /usr/local/bin

      - name: Validate Rego Policies
        run: |
          for policy in policies/rego/*.rego; do
            echo "Validating $policy"
            opa fmt --diff "$policy"
            opa test "$policy" || echo "No tests found for $policy"
          done

      - name: Test Constraint Templates
        run: |
          for template in policies/constraint-templates/*.yaml; do
            echo "Testing constraint template: $template"
            opa fmt --diff "$template" || echo "No rego code in $template"
          done

  yaml-lint:
    name: YAML Lint
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint k8s/
          yamllint helm-charts/
          yamllint policies/
          yamllint environments/

  validate-image-tags:
    name: Validate Image Tags
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for :latest tags
        run: |
          echo "Checking for :latest tags in Kubernetes manifests..."

          FOUND_LATEST=false

          for dir in k8s helm-charts ml_pipelines/k8s; do
            if [ -d "$dir" ]; then
              if grep -rn "image:.*:latest" "$dir" --include="*.yaml" --include="*.yml" 2>/dev/null; then
                FOUND_LATEST=true
              fi
            fi
          done

          if [ -f "orchestrator-dynamic-deploy.yaml" ]; then
            if grep -n "image:.*:latest" orchestrator-dynamic-deploy.yaml 2>/dev/null; then
              FOUND_LATEST=true
            fi
          fi

          if [ "$FOUND_LATEST" = true ]; then
            echo ""
            echo "ERROR: Found :latest tags in manifests!"
            echo "All images must use semantic version tags."
            echo "See docs/IMAGE_VERSIONING.md for details."
            exit 1
          fi

          echo "All images use semantic version tags"

      - name: Validate image existence in registries
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          echo "Validating that configured image tags exist in registries..."
          echo ""

          VALIDATION_FAILED=false

          # Expected images list - update this when introducing new versions
          # Format: REGISTRY_TYPE|REPOSITORY|TAG
          # REGISTRY_TYPE: dockerhub, ecr, internal
          EXPECTED_IMAGES=(
            "dockerhub|curlimages/curl|8.5.0"
            "ecr|neural-hive-mind/pipelines|1.0.7"
            "ecr|neural-hive-ml-training|1.0.7"
            "ecr|neural-hive-ml-monitoring|1.0.7"
          )

          validate_dockerhub_image() {
            local repo="$1"
            local tag="$2"
            echo "Checking Docker Hub: ${repo}:${tag}"
            if docker manifest inspect "docker.io/${repo}:${tag}" > /dev/null 2>&1; then
              echo "  ✓ Image exists"
              return 0
            else
              echo "  ✗ Image NOT found: docker.io/${repo}:${tag}"
              return 1
            fi
          }

          validate_ecr_image() {
            local repo="$1"
            local tag="$2"
            echo "Checking ECR: ${repo}:${tag}"

            # Skip ECR validation if AWS credentials are not configured
            if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
              echo "  ⚠ Skipping ECR validation (AWS credentials not configured)"
              return 0
            fi

            if aws ecr describe-images \
              --repository-name "${repo}" \
              --region us-east-1 \
              --image-ids imageTag="${tag}" > /dev/null 2>&1; then
              echo "  ✓ Image exists"
              return 0
            else
              echo "  ✗ Image NOT found in ECR: ${repo}:${tag}"
              return 1
            fi
          }

          for image_entry in "${EXPECTED_IMAGES[@]}"; do
            IFS='|' read -r registry_type repo tag <<< "$image_entry"

            case "$registry_type" in
              dockerhub)
                if ! validate_dockerhub_image "$repo" "$tag"; then
                  VALIDATION_FAILED=true
                fi
                ;;
              ecr)
                if ! validate_ecr_image "$repo" "$tag"; then
                  VALIDATION_FAILED=true
                fi
                ;;
              internal)
                echo "Checking internal registry: ${repo}:${tag}"
                echo "  ⚠ Skipping internal registry validation in CI"
                ;;
              *)
                echo "Unknown registry type: $registry_type"
                ;;
            esac
            echo ""
          done

          if [ "$VALIDATION_FAILED" = true ]; then
            echo ""
            echo "ERROR: One or more expected images do not exist in their registries!"
            echo "Please ensure all images are built and pushed before deployment."
            echo "See docs/IMAGE_VERSIONING.md for updating the expected images list."
            exit 1
          fi

          echo "All expected images validated successfully"

  # ===========================================================================
  # Kafka Topics Configuration Validation
  # ===========================================================================
  validate-kafka-topics:
    name: Validate Kafka Topics Configuration
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Kafka topics naming conventions
        run: |
          echo "Validating Kafka topics configuration..."

          KAFKA_VALUES="helm-charts/kafka-topics/values.yaml"

          if [[ -f "$KAFKA_VALUES" ]]; then
            # Check for required intention topics with dot notation
            REQUIRED_TOPICS=(
              "intentions.business"
              "intentions.technical"
              "intentions.infrastructure"
              "intentions.security"
            )

            echo "Checking for required topics..."
            MISSING_TOPICS=()

            for topic in "${REQUIRED_TOPICS[@]}"; do
              if grep -q "$topic" "$KAFKA_VALUES"; then
                echo "  ✓ Found topic: $topic"
              else
                echo "  ✗ Missing topic: $topic"
                MISSING_TOPICS+=("$topic")
              fi
            done

            # Check for incorrect naming convention (hyphen instead of dot)
            echo ""
            echo "Checking naming conventions..."
            if grep -q "intentions-" "$KAFKA_VALUES"; then
              echo "  ✗ ERROR: Found topics with incorrect naming (using hyphen instead of dot)"
              grep "intentions-" "$KAFKA_VALUES" | head -5
              exit 1
            else
              echo "  ✓ All topics use correct dot notation"
            fi

            # Check partition and replication settings
            echo ""
            echo "Checking topic configurations..."

            # Verify minimum partitions (at least 3 for production workloads)
            MIN_PARTITIONS=$(grep -A5 "intentions\." "$KAFKA_VALUES" | grep "partitions:" | awk '{print $2}' | sort -n | head -1)
            if [[ -n "$MIN_PARTITIONS" ]] && [[ "$MIN_PARTITIONS" -lt 3 ]]; then
              echo "  ⚠ Warning: Some topics have fewer than 3 partitions (found: $MIN_PARTITIONS)"
            fi

            # Verify replication factor (at least 2 for fault tolerance)
            MIN_REPLICATION=$(grep -A5 "intentions\." "$KAFKA_VALUES" | grep "replicationFactor:" | awk '{print $2}' | sort -n | head -1)
            if [[ -n "$MIN_REPLICATION" ]] && [[ "$MIN_REPLICATION" -lt 2 ]]; then
              echo "  ⚠ Warning: Some topics have replication factor less than 2 (found: $MIN_REPLICATION)"
            fi

            if [[ ${#MISSING_TOPICS[@]} -gt 0 ]]; then
              echo ""
              echo "ERROR: Missing required topics: ${MISSING_TOPICS[*]}"
              exit 1
            fi

            echo ""
            echo "✓ Kafka topics configuration is valid"
          else
            echo "⚠ Kafka topics values file not found at $KAFKA_VALUES"
          fi

      - name: Validate Avro schemas for Kafka topics
        run: |
          echo "Validating Avro schemas for Kafka topics..."

          SCHEMA_DIR="schemas"

          if [[ -d "$SCHEMA_DIR" ]]; then
            for schema_dir in "$SCHEMA_DIR"/*/; do
              schema_name=$(basename "$schema_dir")
              avsc_file="${schema_dir}${schema_name}.avsc"

              if [[ -f "$avsc_file" ]]; then
                echo "Validating: $avsc_file"

                # Check JSON validity
                if ! jq empty "$avsc_file" 2>/dev/null; then
                  echo "  ✗ Invalid JSON in $avsc_file"
                  exit 1
                fi

                # Check required fields for Avro schema
                schema_type=$(jq -r '.type // empty' "$avsc_file")
                if [[ "$schema_type" != "record" ]]; then
                  echo "  ⚠ Unexpected schema type: $schema_type"
                fi

                schema_namespace=$(jq -r '.namespace // empty' "$avsc_file")
                if [[ -z "$schema_namespace" ]]; then
                  echo "  ⚠ Missing namespace in schema"
                fi

                echo "  ✓ Schema is valid"
              fi
            done
          fi

  # ===========================================================================
  # ClickHouse Schema Validation
  # ===========================================================================
  validate-clickhouse-schema:
    name: Validate ClickHouse Schema
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate ClickHouse schema SQL
        run: |
          echo "Validating ClickHouse schema configuration..."

          SCHEMA_FILE="k8s/clickhouse-ml-schema.yaml"

          if [[ -f "$SCHEMA_FILE" ]]; then
            echo "Checking schema file: $SCHEMA_FILE"

            # Extract and validate SQL from ConfigMap
            SQL_CONTENT=$(yq -r '.data["init-schema.sql"] // empty' "$SCHEMA_FILE" 2>/dev/null || echo "")

            if [[ -z "$SQL_CONTENT" ]]; then
              # Try alternative extraction
              SQL_CONTENT=$(grep -A1000 "init-schema.sql:" "$SCHEMA_FILE" | tail -n +2 | head -100)
            fi

            # Check for required tables
            EXPECTED_TABLES=(
              "execution_logs"
              "telemetry_metrics"
              "worker_utilization"
              "queue_snapshots"
              "ml_model_performance"
              "scheduling_decisions"
            )

            echo ""
            echo "Checking for required tables in schema..."

            for table in "${EXPECTED_TABLES[@]}"; do
              if grep -qi "CREATE TABLE.*$table" "$SCHEMA_FILE" || grep -qi "CREATE TABLE IF NOT EXISTS.*neural_hive\.$table" "$SCHEMA_FILE"; then
                echo "  ✓ Found table definition: $table"
              else
                echo "  ✗ Missing table definition: $table"
              fi
            done

            # Check for required views
            EXPECTED_VIEWS=(
              "hourly_ticket_volume"
              "daily_worker_stats"
            )

            echo ""
            echo "Checking for materialized views..."

            for view in "${EXPECTED_VIEWS[@]}"; do
              if grep -qi "CREATE MATERIALIZED VIEW.*$view" "$SCHEMA_FILE"; then
                echo "  ✓ Found view definition: $view"
              else
                echo "  ⚠ View not found (may be optional): $view"
              fi
            done

            echo ""
            echo "✓ ClickHouse schema validation complete"
          else
            echo "⚠ ClickHouse schema file not found at $SCHEMA_FILE"
          fi

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

  # ===========================================================================
  # OTEL/Observability Configuration Validation
  # ===========================================================================
  validate-observability-config:
    name: Validate Observability Configuration
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate OTEL Collector configuration
        run: |
          echo "Validating OTEL Collector configuration..."

          # Check for OTEL configs in various locations
          OTEL_CONFIGS=(
            "k8s/observability/otel-collector-config.yaml"
            "helm-charts/observability/templates/otel-collector-config.yaml"
            "infrastructure/observability/otel-config.yaml"
          )

          FOUND_CONFIG=false

          for config in "${OTEL_CONFIGS[@]}"; do
            if [[ -f "$config" ]]; then
              echo "Found OTEL config: $config"
              FOUND_CONFIG=true

              # Validate YAML syntax
              if ! yq empty "$config" 2>/dev/null; then
                echo "  ✗ Invalid YAML in $config"
                exit 1
              fi

              echo "  ✓ YAML syntax valid"
            fi
          done

          if [[ "$FOUND_CONFIG" == "false" ]]; then
            echo "⚠ No OTEL Collector configuration found (may be inline in deployment)"
          fi

      - name: Validate Prometheus alerts for diagnostic infrastructure
        run: |
          echo "Validating Prometheus diagnostic alerts..."

          ALERTS_FILE="monitoring/alerts/diagnostic-infrastructure-alerts.yaml"

          if [[ -f "$ALERTS_FILE" ]]; then
            echo "Checking alerts file: $ALERTS_FILE"

            # Validate YAML syntax
            if ! yq empty "$ALERTS_FILE" 2>/dev/null; then
              echo "  ✗ Invalid YAML in alerts file"
              exit 1
            fi

            # Check for required alert groups
            REQUIRED_GROUPS=(
              "neural-hive.kafka.diagnostics"
              "neural-hive.clickhouse.diagnostics"
              "neural-hive.observability.diagnostics"
            )

            for group in "${REQUIRED_GROUPS[@]}"; do
              if grep -q "$group" "$ALERTS_FILE"; then
                echo "  ✓ Found alert group: $group"
              else
                echo "  ⚠ Missing alert group: $group"
              fi
            done

            # Check for critical alerts
            CRITICAL_ALERTS=(
              "KafkaTopicMissing"
              "ClickHouseSchemaIncomplete"
              "OTELCollectorDown"
            )

            echo ""
            echo "Checking for critical alerts..."

            for alert in "${CRITICAL_ALERTS[@]}"; do
              if grep -q "alert: $alert" "$ALERTS_FILE"; then
                echo "  ✓ Found critical alert: $alert"
              else
                echo "  ⚠ Missing critical alert: $alert"
              fi
            done

            echo ""
            echo "✓ Prometheus alerts validation complete"
          else
            echo "⚠ Diagnostic alerts file not found at $ALERTS_FILE"
          fi

      - name: Validate Grafana dashboard
        run: |
          echo "Validating Grafana diagnostic dashboard..."

          DASHBOARD_FILE="monitoring/dashboards/neural-hive-diagnostic-dashboard.json"

          if [[ -f "$DASHBOARD_FILE" ]]; then
            echo "Checking dashboard: $DASHBOARD_FILE"

            # Validate JSON syntax
            if ! jq empty "$DASHBOARD_FILE" 2>/dev/null; then
              echo "  ✗ Invalid JSON in dashboard file"
              exit 1
            fi

            # Check for required panels/rows
            PANEL_COUNT=$(jq '.panels | length' "$DASHBOARD_FILE" 2>/dev/null || echo "0")
            echo "  Found $PANEL_COUNT panels"

            # Check for required row titles
            REQUIRED_ROWS=(
              "Kafka"
              "ClickHouse"
              "OTEL"
            )

            for row in "${REQUIRED_ROWS[@]}"; do
              if jq -e ".panels[] | select(.title | contains(\"$row\"))" "$DASHBOARD_FILE" > /dev/null 2>&1; then
                echo "  ✓ Found row/panel for: $row"
              else
                echo "  ⚠ Missing row/panel for: $row"
              fi
            done

            echo ""
            echo "✓ Grafana dashboard validation complete"
          else
            echo "⚠ Diagnostic dashboard not found at $DASHBOARD_FILE"
          fi

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

  # ===========================================================================
  # Python Observability Library Validation
  # ===========================================================================
  validate-observability-library:
    name: Validate Observability Library
    needs: select-runner
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install library
        working-directory: libraries/python/neural_hive_observability
        run: |
          pip install -e ".[dev]" || pip install -e .

      - name: Verify health check exports
        run: |
          echo "Verifying health check class exports..."

          python -c "
          from neural_hive_observability import (
              ClickHouseSchemaHealthCheck,
              OTELPipelineHealthCheck,
              HealthChecker,
              HealthStatus
          )
          print('✓ ClickHouseSchemaHealthCheck exported')
          print('✓ OTELPipelineHealthCheck exported')
          print('✓ HealthChecker exported')
          print('✓ HealthStatus exported')

          # Verify health check inheritance
          from neural_hive_observability.health import HealthCheck
          from neural_hive_observability.health_checks.clickhouse import ClickHouseSchemaHealthCheck as CH
          from neural_hive_observability.health_checks.otel import OTELPipelineHealthCheck as OTEL

          assert issubclass(CH, HealthCheck), 'ClickHouseSchemaHealthCheck must inherit from HealthCheck'
          assert issubclass(OTEL, HealthCheck), 'OTELPipelineHealthCheck must inherit from HealthCheck'

          print('✓ All health checks properly inherit from HealthCheck base class')
          "

      - name: Run health check unit tests
        working-directory: libraries/python/neural_hive_observability
        run: |
          pip install pytest pytest-asyncio
          pytest tests/ -v --ignore=tests/integration || echo "Tests completed (some may require running infrastructure)"

  summary:
    name: Validation Summary
    needs: [select-runner, terraform-validate, tflint, checkov-security, helm-lint, opa-test, yaml-lint, validate-image-tags, validate-kafka-topics, validate-clickhouse-schema, validate-observability-config, validate-observability-library]
    runs-on: ${{ needs.select-runner.outputs.selected-runner }}
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Validation Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Validation**: ${{ needs.terraform-validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **TFLint**: ${{ needs.tflint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Checkov Security**: ${{ needs.checkov-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Helm Lint**: ${{ needs.helm-lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OPA Test**: ${{ needs.opa-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **YAML Lint**: ${{ needs.yaml-lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tags**: ${{ needs.validate-image-tags.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Diagnostic Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **Kafka Topics Config**: ${{ needs.validate-kafka-topics.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ClickHouse Schema**: ${{ needs.validate-clickhouse-schema.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Observability Config**: ${{ needs.validate-observability-config.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Observability Library**: ${{ needs.validate-observability-library.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: contains(needs.*.result, 'failure')
        run: exit 1
