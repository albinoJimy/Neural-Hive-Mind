name: Validate Infrastructure
# NOTA: Este workflow mantém validações diretas (Terraform/Helm/OPA) por serem melhores práticas específicas do domínio.

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'infrastructure/**'
      - 'helm-charts/**'
      - 'policies/**'
      - 'k8s/**'
      - 'environments/**'
      - '.github/workflows/validate-infrastructure.yml'
  workflow_dispatch:

env:
  TF_VERSION: "1.5"
  GOLANG_VERSION: "1.21"
  HELM_VERSION: "v3.12.0"

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Cache Terraform
        uses: actions/cache@v3
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/.terraform
          key: ${{ runner.os }}-terraform-${{ hashFiles('infrastructure/terraform/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Terraform Format Check
        working-directory: infrastructure/terraform
        run: terraform fmt -check -recursive

      - name: Terraform Init (Root)
        working-directory: infrastructure/terraform
        run: terraform init -backend=false

      - name: Terraform Validate (Root)
        working-directory: infrastructure/terraform
        run: terraform validate

      - name: Terraform Init (Network Module)
        working-directory: infrastructure/terraform/modules/network
        run: terraform init -backend=false

      - name: Terraform Validate (Network Module)
        working-directory: infrastructure/terraform/modules/network
        run: terraform validate

      - name: Terraform Init (K8s Cluster Module)
        working-directory: infrastructure/terraform/modules/k8s-cluster
        run: terraform init -backend=false

      - name: Terraform Validate (K8s Cluster Module)
        working-directory: infrastructure/terraform/modules/k8s-cluster
        run: terraform validate

      - name: Terraform Init (Container Registry Module)
        working-directory: infrastructure/terraform/modules/container-registry
        run: terraform init -backend=false

      - name: Terraform Validate (Container Registry Module)
        working-directory: infrastructure/terraform/modules/container-registry
        run: terraform validate

  tflint:
    name: TFLint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache TFLint plugin dir
        uses: actions/cache@v3
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.48.0

      - name: Show TFLint version
        run: tflint --version

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint (Root)
        working-directory: infrastructure/terraform
        run: tflint --format compact

      - name: Run TFLint (Network Module)
        working-directory: infrastructure/terraform/modules/network
        run: tflint --format compact

      - name: Run TFLint (K8s Cluster Module)
        working-directory: infrastructure/terraform/modules/k8s-cluster
        run: tflint --format compact

      - name: Run TFLint (Container Registry Module)
        working-directory: infrastructure/terraform/modules/container-registry
        run: tflint --format compact

  checkov-security:
    name: Checkov Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Checkov action
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infrastructure/terraform
          framework: terraform
          output_format: sarif
          output_file_path: reports/results.sarif
          soft_fail: true

      - name: Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/results.sarif

  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Lint Istio Base Chart
        run: helm lint helm-charts/istio-base

      - name: Lint OPA Gatekeeper Chart
        run: helm lint helm-charts/opa-gatekeeper

      - name: Template Istio Base Chart (Dev)
        run: |
          helm template istio-base helm-charts/istio-base \
            --values environments/dev/helm-values/istio-values.yaml \
            --namespace istio-system

      - name: Template OPA Gatekeeper Chart
        run: |
          helm template opa-gatekeeper helm-charts/opa-gatekeeper \
            --namespace gatekeeper-system

  opa-test:
    name: OPA Policy Testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GOLANG_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.57.0/opa_linux_amd64_static
          chmod 755 ./opa
          sudo mv opa /usr/local/bin

      - name: Validate Rego Policies
        run: |
          for policy in policies/rego/*.rego; do
            echo "Validating $policy"
            opa fmt --diff "$policy"
            opa test "$policy" || echo "No tests found for $policy"
          done

      - name: Test Constraint Templates
        run: |
          for template in policies/constraint-templates/*.yaml; do
            echo "Testing constraint template: $template"
            opa fmt --diff "$template" || echo "No rego code in $template"
          done

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint k8s/
          yamllint helm-charts/
          yamllint policies/
          yamllint environments/

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [terraform-validate, tflint, checkov-security, helm-lint, opa-test, yaml-lint]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Validation Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Validation**: ${{ needs.terraform-validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **TFLint**: ${{ needs.tflint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Checkov Security**: ${{ needs.checkov-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Helm Lint**: ${{ needs.helm-lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OPA Test**: ${{ needs.opa-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **YAML Lint**: ${{ needs.yaml-lint.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: contains(needs.*.result, 'failure')
        run: exit 1
