name: Setup Local Self-Hosted Runner

on:
  workflow_dispatch:  # Permite execuÃ§Ã£o manual via UI
    inputs:
      ssh_host:
        description: 'IP/Hostname da mÃ¡quina local'
        required: true
        type: string
      ssh_user:
        description: 'UsuÃ¡rio SSH'
        required: true
        type: string
      runner_name:
        description: 'Nome do runner (default: local-neural-hive-runner)'
        required: false
        type: string
        default: 'local-neural-hive-runner'

jobs:
  setup-runner:
    name: Setup Local Runner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Runner via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.ssh_host }}
          username: ${{ inputs.ssh_user }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -e

            echo "ðŸš€ Configurando GitHub Actions Runner na mÃ¡quina local..."
            echo ""

            # Instalar Docker se nÃ£o existe
            if ! command -v docker &> /dev/null; then
              echo "ðŸ“¦ Instalando Docker..."
              curl -fsSL https://get.docker.com | sh
              sudo usermod -aG docker $USER
              echo "   âœ… Docker instalado"
              echo "   âš ï¸  FaÃ§a logout e login novamente para aplicar grupo docker"
            else
              echo "   âœ… Docker jÃ¡ instalado"
            fi

            # Criar diretÃ³rio do runner
            RUNNER_DIR="$HOME/actions-runner"
            mkdir -p "$RUNNER_DIR"
            cd "$RUNNER_DIR"

            # Baixar runner se nÃ£o existe
            if [ ! -f "./config.sh" ]; then
              echo "ðŸ“¥ Baixando GitHub Actions Runner v2.319.1..."
              curl -o actions-runner-linux.tar.gz -LH \
                https://github.com/actions/runner/releases/download/v2.319.1/actions-runner-linux-x64-2.319.1.tar.gz
              tar xzf ./actions-runner-linux.tar.gz
              rm ./actions-runner-linux.tar.gz
              echo "   âœ… Runner baixado"
            else
              echo "   âœ… Runner jÃ¡ baixado"
            fi

            # Configurar runner
            RUNNER_NAME="${{ inputs.runner_name }}"
            REPO_URL="https://github.com/jimysoares76/Neural-Hive-Mind"
            LABELS="neural-hive"

            echo ""
            echo "ðŸ”§ Configurando runner..."
            echo "   Nome: $RUNNER_NAME"
            echo "   Labels: $LABELS"

            ./config.sh \
              --url "$REPO_URL" \
              --token "$GITHUB_TOKEN" \
              --labels "$LABELS" \
              --name "$RUNNER_NAME" \
              --work "$RUNNER_DIR/_work" \
              --replace

            echo ""
            echo "ðŸŽ¯ Instalando como serviÃ§o..."

            # Instalar serviÃ§o
            sudo ./svc.sh install > /dev/null 2>&1
            sudo ./svc.sh start

            echo ""
            echo "âœ… Runner configurado e iniciado!"
            echo ""
            echo "Para verificar:"
            echo "  1. VÃ¡ para: https://github.com/jimysoares76/Neural-Hive-Mind/settings/actions/runners"
            echo "  2. Procure por: $RUNNER_NAME"
            echo ""
            echo "Status do serviÃ§o:"
            sudo ./svc.sh status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
