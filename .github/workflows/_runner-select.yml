# Workflow ReutilizÃ¡vel: SeleÃ§Ã£o AutomÃ¡tica de Runner
# Prioriza GitHub-hosted, fallback para self-hosted quando esgotar limite

name: Runner Selection (Reusable)

on:
  workflow_call:
    inputs:
      runner-type:
        description: 'Tipo preferido: ubuntu-latest, ubuntu-20.04, etc'
        required: false
        type: string
        default: 'ubuntu-latest'
      use-fallback:
        description: 'Se true, usa self-hosted quando github-hosted falhar'
        required: false
        type: boolean
        default: true
      fallback-label:
        description: 'Label do runner self-hosted para fallback'
        required: false
        type: string
        default: 'neural-hive'
    outputs:
      selected-runner:
        description: 'O runner selecionado'
        value: ${{ jobs.select-runner.outputs.runner }}
      runner-type:
        description: 'Tipo de runner usado'
        value: ${{ jobs.select-runner.outputs.runner-type }}

jobs:
  select-runner:
    name: Select Runner with Fallback
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.choose.outputs.runner }}
      runner-type: ${{ steps.choose.outputs.runner-type }}
    steps:
      - name: Check GitHub Actions Rate Limit
        id: check-limit
        run: |
          echo "Checking GitHub Actions rate limit..."
          echo "API_LIMIT=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT

      - name: Choose Runner (GitHub-hosted priority)
        id: choose
        run: |
          # CORREÃ‡ÃƒO: LÃ³gica melhorada para seleÃ§Ã£o de runner
          # Prioridade: GitHub-hosted para repo principal > self-hosted para forks

          RUNNER_TYPE="${{ inputs.runner-type }}"

          # 1. Verificar se Ã© um fork
          if [ "${{ github.event.repository.fork }}" == "true" ]; then
            # Forks devem usar self-hosted (limite menor de minutos)
            RUNNER_TYPE="${{ inputs.fallback-label }}"
            echo "ðŸ”„ Fork detected - using self-hosted runner"
          # 2. Verificar se o repo principal estÃ¡ no fork da organizaÃ§Ã£o
          elif [ "${{ github.repository }}" != "${{ github.event.repository.fork }}" ]; then
            # NÃ£o Ã© um fork do repo principal - usar GitHub-hosted
            RUNNER_TYPE="${{ inputs.runner-type }}"
            echo "âœ… Using GitHub-hosted runner: $RUNNER_TYPE"
          # 3. Verificar se use-fallback estÃ¡ explicitamente true
          elif [ "${{ inputs.use-fallback }}" == "true" ]; then
            # ForÃ§ar self-hosted apenas quando solicitado
            RUNNER_TYPE="${{ inputs.fallback-label }}"
            echo "âš™ï¸ Fallback enabled - using self-hosted runner"
          else
            # PadrÃ£o: GitHub-hosted para repo principal
            RUNNER_TYPE="${{ inputs.runner-type }}"
            echo "âœ… Using GitHub-hosted runner: $RUNNER_TYPE"
          fi

          echo "runner=$RUNNER_TYPE" >> $GITHUB_OUTPUT
          echo "runner-type=$RUNNER_TYPE" >> $GITHUB_OUTPUT

  demo-job:
    name: Demo Job with Selected Runner
    needs: select-runner
    # Usa o runner selecionado dinamicamente
    runs-on: ${{ needs.select-runner.outputs.runner }}
    steps:
      - name: Show Runner Info
        run: |
          echo "Running on: ${{ needs.select-runner.outputs.runner-type }}"
          echo "Runner OS:"
          uname -a
          echo "Runner environment:"
          env | grep -E "(RUNNER|GITHUB)" | sort
