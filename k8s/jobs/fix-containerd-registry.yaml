apiVersion: v1
kind: Pod
metadata:
  name: fix-containerd-worker1
  namespace: kube-system
spec:
  nodeName: vmi2911680
  hostPID: true
  hostNetwork: true
  containers:
  - name: fix
    image: alpine:3.18
    command:
    - /bin/sh
    - -c
    - |
      apk add --no-cache util-linux
      nsenter -t 1 -m -u -n -i -- /bin/bash -c '
        # Criar diretório de config de registos
        mkdir -p /etc/containerd/certs.d/37.60.241.150:30500

        # Criar hosts.toml
        cat > /etc/containerd/certs.d/37.60.241.150:30500/hosts.toml << EOL
server = "http://37.60.241.150:30500"

[host."http://37.60.241.150:30500"]
  capabilities = ["pull", "resolve"]
  skip_verify = true
EOL

        # Verificar e configurar config.toml para usar certs.d
        if ! grep -q "config_path" /etc/containerd/config.toml; then
          # Adicionar config_path ao registry section
          if grep -q "\[plugins.*containerd.*registry\]" /etc/containerd/config.toml; then
            sed -i "/\[plugins.*containerd.*registry\]/a\      config_path = \"/etc/containerd/certs.d\"" /etc/containerd/config.toml
          else
            # Containerd 2.x format - adicionar diretamente
            cat >> /etc/containerd/config.toml << EOL

[plugins."io.containerd.cri.v1.registry"]
  config_path = "/etc/containerd/certs.d"
EOL
          fi
        fi

        # Reiniciar containerd
        systemctl restart containerd
        echo "Containerd configured and restarted"
        cat /etc/containerd/certs.d/37.60.241.150:30500/hosts.toml
      '
      sleep 60
    securityContext:
      privileged: true
  restartPolicy: Never
  tolerations:
  - operator: Exists
---
apiVersion: v1
kind: Pod
metadata:
  name: fix-containerd-worker2
  namespace: kube-system
spec:
  nodeName: vmi2911681
  hostPID: true
  hostNetwork: true
  containers:
  - name: fix
    image: alpine:3.18
    command:
    - /bin/sh
    - -c
    - |
      apk add --no-cache util-linux
      nsenter -t 1 -m -u -n -i -- /bin/bash -c '
        # Criar diretório de config de registos
        mkdir -p /etc/containerd/certs.d/37.60.241.150:30500

        # Criar hosts.toml
        cat > /etc/containerd/certs.d/37.60.241.150:30500/hosts.toml << EOL
server = "http://37.60.241.150:30500"

[host."http://37.60.241.150:30500"]
  capabilities = ["pull", "resolve"]
  skip_verify = true
EOL

        # Verificar e configurar config.toml para usar certs.d
        if ! grep -q "config_path" /etc/containerd/config.toml; then
          # Adicionar config_path ao registry section
          if grep -q "\[plugins.*containerd.*registry\]" /etc/containerd/config.toml; then
            sed -i "/\[plugins.*containerd.*registry\]/a\      config_path = \"/etc/containerd/certs.d\"" /etc/containerd/config.toml
          else
            # Containerd 2.x format - adicionar diretamente
            cat >> /etc/containerd/config.toml << EOL

[plugins."io.containerd.cri.v1.registry"]
  config_path = "/etc/containerd/certs.d"
EOL
          fi
        fi

        # Reiniciar containerd
        systemctl restart containerd
        echo "Containerd configured and restarted"
        cat /etc/containerd/certs.d/37.60.241.150:30500/hosts.toml
      '
      sleep 60
    securityContext:
      privileged: true
  restartPolicy: Never
  tolerations:
  - operator: Exists
