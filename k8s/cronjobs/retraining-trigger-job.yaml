apiVersion: batch/v1
kind: CronJob
metadata:
  name: retraining-trigger-checker
  namespace: neural-hive-mind
  labels:
    app: neural-hive
    component: retraining-trigger
    layer: ml-ops
spec:
  # Executar semanalmente Ã s 3h UTC de domingo
  schedule: "0 3 * * 0"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: neural-hive
            component: retraining-trigger
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "8080"
            prometheus.io/path: "/metrics"
        spec:
          restartPolicy: OnFailure
          containers:
            - name: retraining-trigger-checker
              image: 077878370245.dkr.ecr.us-east-1.amazonaws.com/neural-hive-mind/specialist-technical:1.0.7
              imagePullPolicy: IfNotPresent
              command:
                - python
                - -m
                - neural_hive_specialists.scripts.run_retraining_trigger
              args:
                - --verbose
              env:
                - name: MONGODB_URI
                  valueFrom:
                    secretKeyRef:
                      name: mongodb-secret
                      key: uri
                - name: MONGODB_DATABASE
                  value: "neural_hive"
                - name: MLFLOW_TRACKING_URI
                  valueFrom:
                    configMapKeyRef:
                      name: mlflow-config
                      key: tracking-uri
                - name: ENABLE_RETRAINING_TRIGGER
                  value: "true"
                - name: RETRAINING_FEEDBACK_THRESHOLD
                  valueFrom:
                    configMapKeyRef:
                      name: mlflow-config
                      key: retraining-threshold
                - name: RETRAINING_FEEDBACK_WINDOW_DAYS
                  valueFrom:
                    configMapKeyRef:
                      name: mlflow-config
                      key: retraining-window-days
                - name: RETRAINING_MLFLOW_PROJECT_URI
                  value: "./ml_pipelines/training"
                - name: PUSHGATEWAY_URL
                  value: "http://prometheus-pushgateway.observability.svc.cluster.local:9091"
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
