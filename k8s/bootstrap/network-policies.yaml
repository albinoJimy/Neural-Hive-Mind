# NetworkPolicies para isolamento entre namespaces
# Zero Trust - deny all por padrão, permitir apenas necessário

---
# Deny all ingress por padrão em neural-hive-cognition
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: neural-hive-cognition
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Permitir tráfego do orchestration para cognition
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-orchestration
  namespace: neural-hive-cognition
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-orchestration
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090

---
# Permitir tráfego do Istio ingress gateway
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-istio-ingress
  namespace: neural-hive-cognition
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: istio-system
      podSelector:
        matchLabels:
          istio: ingressgateway

---
# Deny all ingress por padrão em neural-hive-orchestration
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: neural-hive-orchestration
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Permitir tráfego do cognition para orchestration
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-cognition
  namespace: neural-hive-orchestration
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-cognition
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090

---
# Permitir tráfego do execution para orchestration
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-execution
  namespace: neural-hive-orchestration
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-execution
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090

---
# Deny all ingress por padrão em neural-hive-execution
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: neural-hive-execution
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Permitir tráfego do orchestration para execution
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-orchestration
  namespace: neural-hive-execution
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-orchestration
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090

---
# Permitir observability coletar métricas de todos os namespaces
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-observability-scraping
  namespace: neural-hive-cognition
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-observability
    ports:
    - protocol: TCP
      port: 15020  # Envoy admin port
    - protocol: TCP
      port: 15090  # Envoy stats
    - protocol: TCP
      port: 9090   # Application metrics

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-observability-scraping
  namespace: neural-hive-orchestration
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-observability
    ports:
    - protocol: TCP
      port: 15020
    - protocol: TCP
      port: 15090
    - protocol: TCP
      port: 9090

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-observability-scraping
  namespace: neural-hive-execution
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-observability
    ports:
    - protocol: TCP
      port: 15020
    - protocol: TCP
      port: 15090
    - protocol: TCP
      port: 9090

---
# Permitir DNS para todos os pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: neural-hive-cognition
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: neural-hive-orchestration
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: neural-hive-execution
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: neural-hive-observability
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Permitir comunicação com Istio control plane
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-istio-control
  namespace: neural-hive-cognition
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: istio-system
    ports:
    - protocol: TCP
      port: 15010  # Pilot xDS
    - protocol: TCP
      port: 15011  # Pilot xDS mTLS
    - protocol: TCP
      port: 15012  # Pilot xDS webhook

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-istio-control
  namespace: neural-hive-orchestration
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: istio-system
    ports:
    - protocol: TCP
      port: 15010
    - protocol: TCP
      port: 15011
    - protocol: TCP
      port: 15012

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-istio-control
  namespace: neural-hive-execution
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: istio-system
    ports:
    - protocol: TCP
      port: 15010
    - protocol: TCP
      port: 15011
    - protocol: TCP
      port: 15012

---
# Security Namespaces Network Policies
# Sigstore Policy Controller namespace policies

# Deny all ingress por padrão em cosign-system
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: cosign-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Permitir tráfego do API server para webhook do Sigstore Policy Controller
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-apiserver-webhook
  namespace: cosign-system
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: policy-controller
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 9443  # Webhook port (allow from any source including API server)

---
# Permitir DNS para cosign-system
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: cosign-system
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Permitir acesso a APIs externas do Sigstore (Rekor/Fulcio)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-sigstore-external-apis
  namespace: cosign-system
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: policy-controller
  policyTypes:
  - Egress
  egress:
  - ports:
    - protocol: TCP
      port: 443  # HTTPS to external APIs

---
# OPA Gatekeeper namespace policies

# Deny all ingress por padrão em gatekeeper-system
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: gatekeeper-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Permitir tráfego do API server para webhook do OPA Gatekeeper
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-apiserver-webhook
  namespace: gatekeeper-system
spec:
  podSelector:
    matchLabels:
      gatekeeper.sh/operation: webhook
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 8443  # Webhook port (allow from any source including API server)

---
# Permitir DNS para gatekeeper-system
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: gatekeeper-system
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Permitir coleta de métricas dos componentes de segurança
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-observability-scraping
  namespace: cosign-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-observability
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
    ports:
    - protocol: TCP
      port: 9090   # Metrics port

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-observability-scraping
  namespace: gatekeeper-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: neural-hive-observability
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
    ports:
    - protocol: TCP
      port: 8888   # Gatekeeper metrics port

---
# Cert-manager namespace policies (se usando cert-manager)

# Deny all ingress por padrão em cert-manager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: cert-manager
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Permitir tráfego do API server para webhook do cert-manager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-apiserver-webhook
  namespace: cert-manager
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: webhook
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 10250  # Webhook port (allow from any source including API server)

---
# Permitir DNS para cert-manager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: cert-manager
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Permitir cert-manager acessar APIs externas para ACME challenges
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-acme
  namespace: cert-manager
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - ports:
    - protocol: TCP
      port: 443  # External ACME servers