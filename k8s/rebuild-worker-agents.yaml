apiVersion: v1
kind: ConfigMap
metadata:
  name: worker-agents-rebuild-script
  namespace: neural-hive
data:
  build.sh: |
    #!/bin/bash
    set -e
    
    echo "=== Building worker-agents image with capabilities fix ==="
    
    cd /workspace
    git fetch origin main
    git checkout main
    git pull origin main
    git log -1 --oneline
    
    # Build usando Docker daemon do host
    IMAGE_TAG="fix-capabilities-$(date +%Y%m%d-%H%M%S)"
    IMAGE_NAME="ghcr.io/albinojimy/neural-hive-mind/worker-agents:$IMAGE_TAG"
    LATEST_TAG="ghcr.io/albinojimy/neural-hive-mind/worker-agents:latest"
    
    echo "Building image: $IMAGE_NAME"
    docker build -t $IMAGE_NAME -f services/worker-agents/Dockerfile services/worker-agents/
    docker tag $IMAGE_NAME $LATEST_TAG
    
    echo "Pushing to registry..."
    docker push $IMAGE_NAME
    docker push $LATEST_TAG
    
    echo "Updating deployment..."
    kubectl set image deployment/worker-agents worker-agents=$LATEST_TAG -n neural-hive
    kubectl rollout status deployment/worker-agents -n neural-hive --timeout=300s
    
    echo "=== Build complete ==="
    echo "Image: $IMAGE_NAME"
    
---
apiVersion: batch/v1
kind: Job
metadata:
  name: rebuild-worker-agents
  namespace: neural-hive
spec:
  template:
    spec:
      serviceAccountName: docker-builder
      restartPolicy: Never
      containers:
      - name: builder
        image: docker:24
        command: ["/bin/bash", "/scripts/build.sh"]
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: docker-sock
          mountPath: /var/run/docker.sock
        env:
        - name: HOME
          value: /root
      volumes:
      - name: scripts
          configMap:
            name: worker-agents-rebuild-script
            defaultMode: 0755
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock
