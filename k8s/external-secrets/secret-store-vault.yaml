# =============================================================================
# SecretStore para HashiCorp Vault
# =============================================================================
#
# Pre-requisitos:
#
# 1. External Secrets Operator instalado
#
# 2. HashiCorp Vault rodando e acessivel:
#    - Self-hosted ou HCP Vault
#    - Autenticacao Kubernetes habilitada
#
# 3. Configurar autenticacao Kubernetes no Vault:
#    vault auth enable kubernetes
#    vault write auth/kubernetes/config \
#      kubernetes_host="https://$KUBERNETES_HOST" \
#      kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
#
# 4. Criar policy e role:
#    vault policy write neural-hive - <<EOF
#    path "secret/data/neural-hive/*" { capabilities = ["read"] }
#    EOF
#    vault write auth/kubernetes/role/external-secrets \
#      bound_service_account_names=external-secrets-sa \
#      bound_service_account_namespaces=mlflow \
#      policies=neural-hive \
#      ttl=1h
#
# 5. Secrets criados no Vault:
#    vault kv put secret/neural-hive/mongodb uri="mongodb://user:pass@host:27017/db"
#
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: hashicorp-vault
  namespace: mlflow
  labels:
    app: neural-hive
    component: external-secrets
spec:
  provider:
    vault:
      # URL do Vault server
      server: "https://vault.example.com:8200"
      # Path do secrets engine (KV v2)
      path: "secret"
      version: "v2"
      auth:
        # Autenticacao via Kubernetes ServiceAccount
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets"
          serviceAccountRef:
            name: external-secrets-sa
        # Alternativa: Token auth (nao recomendado para producao)
        # tokenSecretRef:
        #   name: vault-token
        #   key: token
