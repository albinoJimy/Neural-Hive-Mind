# =============================================================================
# ExternalSecret para Redis Password
# =============================================================================
#
# Este ExternalSecret sincroniza a senha do Redis de um provedor externo
# e cria automaticamente o Secret usado pelo Redis Cluster e servicos.
#
# Usado por:
# - redis-cluster (autenticacao do cluster)
# - service-registry
# - orchestrator-dynamic
# - gateway-intencoes
# - Todos os servicos que conectam ao Redis
#
# Pre-requisitos:
# - External Secrets Operator instalado
# - SecretStore configurado (ver secret-store-*.yaml)
# - Secret criado no provedor externo
#
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-password-external
  namespace: redis-cluster  # Namespace onde o Redis Cluster roda
  labels:
    app: neural-hive
    component: redis
    layer: infrastructure
spec:
  # Intervalo de sincronizacao com provedor externo
  refreshInterval: 1h

  # Referencia ao SecretStore
  # Altere 'name' conforme seu provedor:
  # - aws-secrets-manager (AWS)
  # - azure-key-vault (Azure)
  # - hashicorp-vault (Vault)
  secretStoreRef:
    name: aws-secrets-manager  # ALTERE conforme seu provedor
    kind: SecretStore

  # Secret Kubernetes que sera criado/atualizado
  target:
    name: redis-cluster-auth  # Nome esperado pelo Redis Cluster
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        password: "{{ .password }}"

  # Mapeamento: chave remota -> chave local
  data:
    - secretKey: password
      remoteRef:
        # AWS Secrets Manager: nome do secret
        key: neural-hive/redis/password
        # Azure Key Vault: nome do secret
        # key: redis-password
        # HashiCorp Vault: path/to/secret
        # key: neural-hive/redis
        # property: password

---
# =============================================================================
# ExternalSecret para service-registry (namespace separado)
# =============================================================================
# Se o service-registry rodar em namespace diferente, use este ExternalSecret
# para criar uma copia do secret no namespace correto.

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: service-registry-redis-external
  namespace: neural-hive  # Namespace onde o service-registry roda
  labels:
    app: neural-hive
    component: service-registry
    layer: infrastructure
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: aws-secrets-manager  # ALTERE conforme seu provedor
    kind: SecretStore

  target:
    name: service-registry-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        redis-password: "{{ .password }}"

  data:
    - secretKey: password
      remoteRef:
        key: neural-hive/redis/password

# =============================================================================
# COMANDOS PARA CRIAR SECRET NO PROVEDOR
# =============================================================================
#
# 1. Gerar senha segura:
#    PASSWORD=$(openssl rand -base64 32)
#    echo "Senha gerada: $PASSWORD"
#
# 2. AWS Secrets Manager:
#    aws secretsmanager create-secret \
#      --name neural-hive/redis/password \
#      --secret-string "$PASSWORD"
#
# 3. Azure Key Vault:
#    az keyvault secret set \
#      --vault-name neural-hive-kv \
#      --name redis-password \
#      --value "$PASSWORD"
#
# 4. HashiCorp Vault:
#    vault kv put secret/neural-hive/redis password="$PASSWORD"
#
# =============================================================================
# VERIFICACAO
# =============================================================================
#
# Status dos ExternalSecrets:
#   kubectl get externalsecret -A | grep redis
#
# Detalhes e eventos:
#   kubectl describe externalsecret redis-password-external -n redis-cluster
#   kubectl describe externalsecret service-registry-redis-external -n neural-hive-services
#
# Verificar se Secrets foram criados:
#   kubectl get secret redis-cluster-auth -n redis-cluster
#   kubectl get secret service-registry-secret -n neural-hive-services
#
# Testar conexao com Redis (de dentro do cluster):
#   kubectl run -it --rm redis-test --image=redis:7 --restart=Never -- \
#     redis-cli -h redis-cluster.redis-cluster.svc -a "$PASSWORD" ping
#
# =============================================================================
