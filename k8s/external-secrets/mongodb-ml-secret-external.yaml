# =============================================================================
# ExternalSecret para MongoDB URI (ML Pipelines)
# =============================================================================
#
# Este ExternalSecret sincroniza a URI do MongoDB de um provedor externo
# e cria automaticamente o Secret 'mongodb-secret' no namespace mlflow.
#
# Pre-requisitos:
# - SecretStore configurado (ver secret-store-*.yaml)
# - Secret criado no provedor externo
#
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mongodb-ml-secret
  namespace: mlflow
  labels:
    app: neural-hive
    component: ml-training
    layer: ml-ops
spec:
  # Intervalo de sincronizacao com provedor externo
  refreshInterval: 1h

  # Referencia ao SecretStore
  # Altere 'name' conforme seu provedor:
  # - aws-secrets-manager (AWS)
  # - azure-key-vault (Azure)
  # - hashicorp-vault (Vault)
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore

  # Secret Kubernetes que sera criado/atualizado
  target:
    name: mongodb-secret
    creationPolicy: Owner
    deletionPolicy: Retain

  # Mapeamento: chave remota -> chave local
  data:
    - secretKey: uri
      remoteRef:
        # AWS Secrets Manager: nome do secret
        key: neural-hive/ml/mongodb-uri
        # Azure Key Vault: nome do secret
        # key: mongodb-uri
        # HashiCorp Vault: path/to/secret
        # key: neural-hive/mongodb
        # property: uri

# =============================================================================
# COMANDOS PARA CRIAR SECRET NO PROVEDOR
# =============================================================================
#
# AWS Secrets Manager:
#   aws secretsmanager create-secret \
#     --name neural-hive/ml/mongodb-uri \
#     --secret-string "mongodb://user:password@host:27017/neural_hive?authSource=admin"
#
# Azure Key Vault:
#   az keyvault secret set \
#     --vault-name neural-hive-kv \
#     --name mongodb-uri \
#     --value "mongodb://user:password@host:27017/neural_hive?authSource=admin"
#
# HashiCorp Vault:
#   vault kv put secret/neural-hive/mongodb \
#     uri="mongodb://user:password@host:27017/neural_hive?authSource=admin"
#
# =============================================================================
# VERIFICACAO
# =============================================================================
#
# Status do ExternalSecret:
#   kubectl get externalsecret mongodb-ml-secret -n mlflow
#
# Detalhes e eventos:
#   kubectl describe externalsecret mongodb-ml-secret -n mlflow
#
# Verificar se Secret foi criado:
#   kubectl get secret mongodb-secret -n mlflow
#
# =============================================================================
