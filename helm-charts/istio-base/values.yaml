# Valores padrão para Istio - Neural Hive-Mind
# mTLS STRICT habilitado por padrão com observabilidade nativa

global:
  # Configurações de proxy
  proxy:
    # Resource limits para sidecars
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Configurações de logging
    logLevel: info
    accessLogFile: /dev/stdout
    accessLogFormat: |
      [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
      %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
      %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
      "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"

  # Configurações de telemetria
  telemetry:
    v2:
      prometheus:
        configOverride:
          inboundSidecar:
            disable_host_header_fallback: true
          outboundSidecar:
            disable_host_header_fallback: true
          gateway:
            disable_host_header_fallback: true

  # Configurações de tracing para OpenTelemetry
  tracer:
    zipkin:
      address: "otel-collector.neural-hive-observability:9411"

  # mTLS configuração global
  mtls:
    auto: true

base:
  # Habilitar validação de webhooks
  validateWebhookConfig:
    enabled: true

istiod:
  # Configurações do control plane
  pilot:
    autoscaleEnabled: true
    autoscaleMin: 2
    autoscaleMax: 5
    cpu:
      targetAverageUtilization: 60

    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi

    # Configurações de segurança
    env:
      # Habilitar políticas de segurança rigorosas
      PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION: false
      PILOT_ENABLE_WORKLOAD_ENTRY_HEALTHCHECKS: true
      PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_INBOUND: false
      PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_OUTBOUND: false

      # Configurações de telemetria
      PILOT_TRACE_SAMPLING: "1.0" # 100% em dev/qa, reduzir em prod

      # Configurações de segurança adicionais
      VERIFY_CERTIFICATE_AT_CLIENT: true
      ENABLE_AUTO_MTLS: true

  # Configurações de telemetria v2
  telemetry:
    v2:
      enabled: true
      metadataExchange:
        wasmEnabled: true
      prometheus:
        wasmEnabled: true
        configOverride:
          metric_expiry_duration: 10m
          metric_rotation_interval: 5m

# Configurações de injeção de sidecar
sidecarInjectorWebhook:
  # Namespaces para injeção automática
  enableNamespacesByDefault:
    - neural-hive-cognition
    - neural-hive-orchestration
    - neural-hive-execution
    - neural-hive-observability

  # Configurações de injeção
  injectedAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "15020"
    prometheus.io/path: "/stats/prometheus"

  # Templates de recursos para sidecars
  templates:
    sidecar:
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi

# Configurações de políticas padrão
defaultConfig:
  # Circuit breaker padrão
  proxyStatsMatcher:
    inclusionRegexps:
      - ".*outlier_detection.*"
      - ".*circuit_breakers.*"
      - ".*upstream_rq_retry.*"
      - ".*upstream_rq_timeout.*"

  # Configurações de timeout
  holdApplicationUntilProxyStarts: true
  drainDuration: 30s
  terminationDrainDuration: 5s

  # Configurações de concorrência
  concurrency: 2

# Configurações de mesh
meshConfig:
  # Configurações de acesso
  accessLogFile: /dev/stdout
  defaultConfig:
    proxyStatsMatcher:
      inclusionRegexps:
        - ".*outlier_detection.*"
        - ".*circuit_breakers.*"

  # Configurações de observabilidade
  extensionProviders:
    - name: otel
      envoyOtelAls:
        service: opentelemetry-collector.neural-hive-observability.svc.cluster.local
        port: 4317

    - name: prometheus
      prometheus:
        service: prometheus.neural-hive-observability.svc.cluster.local
        port: 9090

  # Configurações de política de tráfego padrão
  defaultDestinationRulePolicy:
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
        http:
          http2MaxRequests: 100
          maxRequestsPerConnection: 1

      outlierDetection:
        consecutiveErrors: 5
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 50
        minHealthPercent: 30
        splitExternalLocalOriginErrors: true

# Configurações específicas por ambiente (override em values-{env}.yaml)
environment: base