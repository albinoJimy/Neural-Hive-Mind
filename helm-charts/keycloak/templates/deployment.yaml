{{- $ctx := include "keycloak.context" . | fromYaml }}
{{- $checksumConfig := include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
{{- $checksumSecret := include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}

{{/* Construir variáveis de ambiente */}}
{{- $envVars := list }}
{{- $envVars = append $envVars (dict "name" "KEYCLOAK_ADMIN" "valueFrom" (dict "secretKeyRef" (dict "name" (include "keycloak.secretName" .) "key" "admin-user"))) }}
{{- $envVars = append $envVars (dict "name" "KEYCLOAK_ADMIN_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (include "keycloak.secretName" .) "key" "admin-password"))) }}
{{- $envVars = append $envVars (dict "name" "KC_DB_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (include "keycloak.databaseSecretName" .) "key" (include "keycloak.databaseSecretPasswordKey" .)))) }}
{{- $envVars = append $envVars (dict "name" "KC_HEALTH_ENABLED" "value" "true") }}
{{- $envVars = append $envVars (dict "name" "KC_METRICS_ENABLED" "value" (.Values.metrics.enabled | toString)) }}
{{- $envVars = append $envVars (dict "name" "KC_LOG_LEVEL" "value" .Values.logging.level) }}
{{- $javaOpts := printf "%s -Djgroups.dns.query=%s-headless.%s.svc.cluster.local" .Values.javaOpts (include "keycloak.fullname" .) .Release.Namespace }}
{{- $envVars = append $envVars (dict "name" "JAVA_OPTS_APPEND" "value" $javaOpts) }}
{{- range .Values.extraEnv }}
{{- $envVars = append $envVars (dict "name" .name "value" .value) }}
{{- end }}

{{/* Construir volumes */}}
{{- $volumes := list }}
{{- $volumes = append $volumes (dict "name" "keycloak-config" "configMap" (dict "name" (printf "%s-config" (include "keycloak.fullname" .)))) }}
{{- $volumes = append $volumes (dict "name" "realm-import" "configMap" (dict "name" (printf "%s-realm" (include "keycloak.fullname" .)))) }}
{{- if .Values.tls.enabled }}
{{- $volumes = append $volumes (dict "name" "tls-certs" "secret" (dict "secretName" (include "keycloak.tlsSecretName" .))) }}
{{- end }}
{{- range .Values.extraVolumes }}
{{- $volumes = append $volumes . }}
{{- end }}

{{/* Construir volumeMounts */}}
{{- $volumeMounts := list }}
{{- $volumeMounts = append $volumeMounts (dict "name" "keycloak-config" "mountPath" "/opt/keycloak/conf/keycloak.conf" "subPath" "keycloak.conf" "readOnly" true) }}
{{- $volumeMounts = append $volumeMounts (dict "name" "realm-import" "mountPath" "/opt/keycloak/data/import/realm.json" "subPath" "realm.json" "readOnly" true) }}
{{- if .Values.tls.enabled }}
{{- $volumeMounts = append $volumeMounts (dict "name" "tls-certs" "mountPath" "/opt/keycloak/certs" "readOnly" true) }}
{{- end }}
{{- range .Values.extraVolumeMounts }}
{{- $volumeMounts = append $volumeMounts . }}
{{- end }}

{{/* Construir initContainers */}}
{{- $initContainers := list }}
{{- if .Values.postgresql.enabled }}
{{- $waitForDb := dict "name" "wait-for-db" "image" "busybox:1.35" "command" (list "sh" "-c" (printf "until nc -z %s %d; do echo 'Waiting for database...'; sleep 2; done; echo 'Database is ready!'" (include "keycloak.databaseHost" .) (int (.Values.postgresql.primary.service.ports.postgresql | default 5432)))) "securityContext" .Values.securityContext }}
{{- $initContainers = append $initContainers $waitForDb }}
{{- end }}

{{/* Modificar values para o template comum */}}
{{- $modifiedValues := deepCopy .Values }}
{{- $_ := set $modifiedValues "volumes" $volumes }}
{{- $_ := set $modifiedValues "volumeMounts" $volumeMounts }}
{{- $_ := set $modifiedValues "initContainers" $initContainers }}

{{/* Construir probes no formato esperado pelo template comum */}}
{{/* Keycloak 22 serve health endpoints na porta HTTP principal */}}
{{- if .Values.startupProbe.enabled }}
{{- $startupProbe := dict "httpGet" (dict "path" "/health" "port" "http") "initialDelaySeconds" .Values.startupProbe.initialDelaySeconds "periodSeconds" .Values.startupProbe.periodSeconds "timeoutSeconds" .Values.startupProbe.timeoutSeconds "failureThreshold" .Values.startupProbe.failureThreshold }}
{{- $_ := set $modifiedValues "startupProbe" $startupProbe }}
{{- else }}
{{- $_ := unset $modifiedValues "startupProbe" }}
{{- end }}

{{- if .Values.healthcheck.enabled }}
{{- $livenessProbe := dict "httpGet" (dict "path" "/health/live" "port" "http") "initialDelaySeconds" .Values.healthcheck.initialDelaySeconds "periodSeconds" .Values.healthcheck.periodSeconds "timeoutSeconds" .Values.healthcheck.timeoutSeconds "failureThreshold" .Values.healthcheck.failureThreshold }}
{{- $_ := set $modifiedValues "livenessProbe" $livenessProbe }}
{{- else }}
{{- $_ := unset $modifiedValues "livenessProbe" }}
{{- end }}

{{- if .Values.readinessProbe.enabled }}
{{- $readinessProbe := dict "httpGet" (dict "path" "/health/ready" "port" "http") "initialDelaySeconds" .Values.readinessProbe.initialDelaySeconds "periodSeconds" .Values.readinessProbe.periodSeconds "timeoutSeconds" .Values.readinessProbe.timeoutSeconds "failureThreshold" .Values.readinessProbe.failureThreshold }}
{{- $_ := set $modifiedValues "readinessProbe" $readinessProbe }}
{{- else }}
{{- $_ := unset $modifiedValues "readinessProbe" }}
{{- end }}

{{/* Configurar deployment strategy */}}
{{- if not $modifiedValues.deployment }}
{{- $_ := set $modifiedValues "deployment" (dict "strategy" (dict "type" "RollingUpdate" "rollingUpdate" (dict "maxSurge" 1 "maxUnavailable" 0))) }}
{{- end }}

{{/* Configurar autoscaling como desabilitado por padrão */}}
{{- if not $modifiedValues.autoscaling }}
{{- $_ := set $modifiedValues "autoscaling" (dict "enabled" false) }}
{{- end }}

{{/* Configurar istio */}}
{{- if not $modifiedValues.istio }}
{{- $_ := set $modifiedValues "istio" (dict "enabled" .Values.istio.injection) }}
{{- else }}
{{- $_ := set $modifiedValues.istio "enabled" .Values.istio.injection }}
{{- end }}

{{/* Configurar observability */}}
{{- if not $modifiedValues.observability }}
{{- $_ := set $modifiedValues "observability" (dict "prometheus" (dict "enabled" .Values.metrics.enabled)) }}
{{- end }}

{{/* Construir args do container */}}
{{- $containerArgs := list "start" "--import-realm" }}

{{/* Criar config dict */}}
{{- $config := dict "checksumConfig" $checksumConfig "checksumSecret" $checksumSecret "env" $envVars "args" $containerArgs }}

{{/* Gerar deployment usando template comum */}}
{{ include "neural-hive.deployment" (dict "values" $modifiedValues "context" $ctx "config" $config) }}
