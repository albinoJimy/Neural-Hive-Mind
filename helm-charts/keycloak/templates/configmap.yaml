apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "keycloak.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
data:
  keycloak.conf: |
    # Keycloak Configuration
    db=postgres
    db-url-host={{ include "keycloak.databaseHost" . }}
    {{- if .Values.postgresql.enabled }}
    db-url-database={{ .Values.postgresql.auth.database }}
    db-username={{ .Values.postgresql.auth.username }}
    {{- else }}
    db-url-database={{ .Values.externalDatabase.database }}
    db-username={{ .Values.externalDatabase.user }}
    {{- end }}

    # HTTP/HTTPS Configuration
    http-enabled=true
    http-port=8080
    {{- if .Values.tls.enabled }}
    https-port=8443
    https-certificate-file=/opt/keycloak/certs/tls.crt
    https-certificate-key-file=/opt/keycloak/certs/tls.key
    {{- end }}

    # Hostname Configuration
    hostname-strict=false
    hostname-strict-https=false

    # Health & Metrics
    health-enabled=true
    metrics-enabled={{ .Values.metrics.enabled }}

    # Clustering (JGroups via DNS)
    cache=ispn
    cache-stack=kubernetes

    # Logging
    log-level={{ .Values.logging.level }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "keycloak.fullname" . }}-realm
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
data:
  realm.json: |
    {
      "realm": "{{ .Values.realm.name }}",
      "displayName": "{{ .Values.realm.displayName }}",
      "enabled": {{ .Values.realm.enabled }},
      "sslRequired": "external",
      "registrationAllowed": false,
      "loginWithEmailAllowed": true,
      "duplicateEmailsAllowed": false,
      "resetPasswordAllowed": true,
      "editUsernameAllowed": false,
      "bruteForceProtected": true,
      "permanentLockout": false,
      "maxFailureWaitSeconds": 900,
      "minimumQuickLoginWaitSeconds": 60,
      "waitIncrementSeconds": 60,
      "quickLoginCheckMilliSeconds": 1000,
      "maxDeltaTimeSeconds": 43200,
      "failureFactor": 30,
      "accessTokenLifespan": {{ .Values.realm.tokenLifespan }},
      "accessTokenLifespanForImplicitFlow": 900,
      "ssoSessionIdleTimeout": {{ .Values.realm.sessionTimeout }},
      "ssoSessionMaxLifespan": {{ .Values.realm.maxSessionLifespan }},
      "offlineSessionIdleTimeout": 2592000,
      "accessCodeLifespan": 60,
      "accessCodeLifespanUserAction": 300,
      "accessCodeLifespanLogin": 1800,
      "actionTokenGeneratedByAdminLifespan": 43200,
      "actionTokenGeneratedByUserLifespan": 300,
      "passwordPolicy": "{{ .Values.realm.passwordPolicy }}",
      "roles": {
        "realm": [
          {
            "name": "admin",
            "description": "Administrator role"
          },
          {
            "name": "user",
            "description": "Standard user role"
          },
          {
            "name": "service",
            "description": "Service account role"
          }
        ]
      },
      "clients": [
        {{- $first := true }}
        {{- range $key, $client := .Values.realm.clients }}
        {{- if not $first }},{{ end }}
        {{- $first = false }}
        {
          "clientId": "{{ $client.clientId }}",
          "name": "{{ $client.name }}",
          "enabled": {{ $client.enabled }},
          "publicClient": {{ $client.publicClient }},
          "serviceAccountsEnabled": {{ $client.serviceAccountsEnabled }},
          "directAccessGrantsEnabled": {{ $client.directAccessGrantsEnabled }},
          "standardFlowEnabled": {{ $client.standardFlowEnabled }},
          "implicitFlowEnabled": {{ $client.implicitFlowEnabled }},
          "redirectUris": {{ $client.redirectUris | toJson }},
          "webOrigins": {{ $client.webOrigins | toJson }},
          "protocol": "openid-connect",
          "attributes": {
            "backchannel.logout.session.required": "true",
            "backchannel.logout.revoke.offline.tokens": "false"
          },
          "defaultClientScopes": {{ $client.scopes | toJson }}
        }
        {{- end }}
      ],
      "clientScopes": [
        {
          "name": "openid",
          "description": "OpenID Connect scope",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true"
          }
        },
        {
          "name": "profile",
          "description": "Profile scope",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true"
          }
        },
        {
          "name": "email",
          "description": "Email scope",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true"
          }
        },
        {
          "name": "roles",
          "description": "Roles scope",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true"
          }
        }
      ]
    }
