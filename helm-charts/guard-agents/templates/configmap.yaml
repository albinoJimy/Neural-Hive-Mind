apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "guard-agents.fullname" . }}-config
  labels:
    {{- include "guard-agents.labels" . | nindent 4 }}
data:
  SERVICE_NAME: {{ .Values.config.serviceName | quote }}
  SERVICE_VERSION: {{ .Values.image.tag | default .Chart.AppVersion | quote }}
  ENVIRONMENT: {{ .Values.config.environment | default "production" | quote }}
  LOG_LEVEL: {{ .Values.config.observability.logLevel | default "INFO" | quote }}

  KAFKA_BOOTSTRAP_SERVERS: {{ .Values.config.kafka.bootstrapServers | quote }}
  KAFKA_CONSUMER_GROUP: {{ .Values.config.kafka.consumerGroupId | quote }}
  KAFKA_INCIDENTS_TOPIC: {{ .Values.config.kafka.incidentsTopic | quote }}
  KAFKA_ORCHESTRATION_INCIDENTS_TOPIC: {{ .Values.config.kafka.orchestrationIncidentsTopic | quote }}
  KAFKA_REMEDIATION_TOPIC: {{ .Values.config.kafka.remediationTopic | quote }}

  SERVICE_REGISTRY_GRPC_HOST: {{ .Values.config.serviceRegistry.host | quote }}
  SERVICE_REGISTRY_GRPC_PORT: {{ .Values.config.serviceRegistry.port | quote }}
  HEARTBEAT_INTERVAL_SECONDS: {{ .Values.config.serviceRegistry.heartbeatIntervalSeconds | quote }}

  MONGODB_URI: {{ .Values.config.mongodb.uri | quote }}
  MONGODB_DATABASE: {{ .Values.config.mongodb.database | quote }}
  MONGODB_INCIDENTS_COLLECTION: {{ .Values.config.mongodb.incidentsCollection | quote }}
  MONGODB_REMEDIATION_COLLECTION: {{ .Values.config.mongodb.remediationCollection | quote }}
  MONGODB_POSTMORTEMS_COLLECTION: {{ .Values.config.mongodb.postmortemsCollection | default "incident_postmortems" | quote }}

  # Keycloak Admin Config
  KEYCLOAK_URL: {{ .Values.config.keycloak.url | quote }}
  KEYCLOAK_REALM: {{ .Values.config.keycloak.realm | quote }}
  KEYCLOAK_ADMIN_CLIENT_ID: {{ .Values.config.keycloak.adminClientId | quote }}
  KEYCLOAK_ADMIN_TIMEOUT_SECONDS: {{ .Values.config.keycloak.adminTimeoutSeconds | default 10 | quote }}
  KEYCLOAK_TOKEN_CACHE_TTL_SECONDS: {{ .Values.config.keycloak.tokenCacheTtlSeconds | default 300 | quote }}

  REDIS_HOST: {{ .Values.config.redis.host | quote }}
  REDIS_PORT: {{ .Values.config.redis.port | quote }}
  REDIS_DB: {{ .Values.config.redis.db | quote }}

  PROMETHEUS_URL: {{ .Values.config.prometheus.url | quote }}
  PROMETHEUS_QUERY_TIMEOUT_SECONDS: {{ .Values.config.prometheus.queryTimeoutSeconds | quote }}

  ALERTMANAGER_URL: {{ .Values.config.alertmanager.url | quote }}
  ALERTMANAGER_WEBHOOK_ENABLED: {{ .Values.config.alertmanager.webhookEnabled | quote }}

  SELF_HEALING_ENGINE_URL: {{ .Values.config.selfHealingEngine.url | quote }}
  SELF_HEALING_ENGINE_GRPC_HOST: {{ .Values.config.selfHealingEngine.grpcHost | quote }}
  SELF_HEALING_ENGINE_GRPC_PORT: {{ .Values.config.selfHealingEngine.grpcPort | quote }}

  OTEL_EXPORTER_OTLP_ENDPOINT: {{ .Values.config.observability.otelEndpoint | quote }}
  OTEL_SERVICE_NAME: {{ .Values.config.serviceName | quote }}
  OTEL_RESOURCE_ATTRIBUTES: {{ printf "service.version=%s,deployment.environment=%s" (.Values.image.tag | default .Chart.AppVersion) (.Values.config.environment | default "production") | quote }}

  # Anomaly Detector Config
  ANOMALY_DETECTOR_ENABLED: {{ .Values.config.anomalyDetector.enabled | default true | quote }}
  ANOMALY_DETECTOR_MODEL_TYPE: {{ .Values.config.anomalyDetector.modelType | default "isolation_forest" | quote }}
  ANOMALY_DETECTOR_CONTAMINATION: {{ .Values.config.anomalyDetector.contamination | default 0.05 | quote }}
