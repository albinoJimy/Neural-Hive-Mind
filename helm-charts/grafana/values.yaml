nameOverride: ""
fullnameOverride: ""

# Configura√ß√£o global
global:
  domain: neural-hive.local
  environment: production

# Feature flags para datasources opcionais
featureFlags:
  enableLoki: false
  enableTempo: false

# Datasources opcionais (desabilitados por padrao)
aws:
  enabled: false
  region: "us-west-2"

elasticsearch:
  enabled: false
  host: "elasticsearch"
  port: 9200

influxdb:
  enabled: false
  host: "influxdb"
  port: 8086

postgresql:
  enabled: false
  host: "postgresql"
  port: 5432
  database: "grafana"

# Configura√ß√£o de datasources
datasources:
  prometheus:
    service: "prometheus-kube-prometheus-prometheus"
    port: 9090
  jaeger:
    service: "jaeger-query"
    port: 16686
  loki:
    service: "loki-gateway"
    port: 80
  tempo:
    service: "tempo-query-frontend"
    port: 3200

# Configura√ß√£o do Grafana
grafana:
  enabled: true

  # Image
  image:
    repository: grafana/grafana
    tag: "10.2.0"
    pullPolicy: IfNotPresent

  # Replicas for HA
  replicas: 2

  # Admin credentials from secret
  admin:
    existingSecret: grafana-admin-credentials
    userKey: admin-user
    passwordKey: admin-password
    username: admin
    # Password is managed via Kubernetes secret, not stored in values.yaml for security

  # Resources
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi

  # Persistence
  persistence:
    enabled: true
    storageClassName: gp3
    size: 10Gi
    accessModes:
    - ReadWriteOnce

  # Service configuration
  service:
    type: ClusterIP
    port: 80
    targetPort: 3000
    annotations:
      neural.hive/component: "dashboard-visualization"
      neural.hive/layer: "observabilidade"

  # Security Context
  securityContext:
    runAsUser: 472
    runAsGroup: 472
    fsGroup: 472

  # Pod Security Context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 472
    runAsGroup: 472
    fsGroup: 472
    seccompProfile:
      type: RuntimeDefault

  # Anti-affinity para HA
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - grafana
          topologyKey: kubernetes.io/hostname

  # Configura√ß√£o do Grafana
  grafana.ini:
    # Server settings
    server:
      domain: "grafana.neural-hive.local"
      root_url: "https://grafana.neural-hive.local"
      serve_from_sub_path: false
      enable_gzip: true

    # Analytics (desabilitado para privacidade)
    analytics:
      reporting_enabled: false
      check_for_updates: false
      google_analytics_ua_id: ""
      google_tag_manager_id: ""

    # Security
    security:
      disable_gravatar: true
      cookie_secure: true
      cookie_samesite: "strict"
      content_type_protection: true
      x_content_type_options: true
      x_xss_protection: true
      strict_transport_security: true
      strict_transport_security_max_age: 86400
      strict_transport_security_preload: true
      strict_transport_security_subdomains: true
      x_frame_options: "deny"

    # Auth
    auth:
      disable_login_form: false
      disable_signout_menu: false
      oauth_auto_login: false

    # Auth Anonymous (desabilitado)
    auth.anonymous:
      enabled: false

    # LDAP configuration for enterprise
    auth.ldap:
      enabled: false
      config_file: /etc/grafana/ldap.toml
      allow_sign_up: true

    # OIDC configuration for enterprise authentication
    auth.generic_oauth:
      enabled: false
      name: "Neural Hive SSO"
      allow_sign_up: true
      client_id: "${OAUTH_CLIENT_ID}"
      client_secret: "${OAUTH_CLIENT_SECRET}"
      scopes: "openid profile email"
      auth_url: "${OAUTH_AUTH_URL}"
      token_url: "${OAUTH_TOKEN_URL}"
      api_url: "${OAUTH_API_URL}"
      role_attribute_path: "contains(groups[*], 'neural-hive-admin') && 'Admin' || contains(groups[*], 'neural-hive-editor') && 'Editor' || 'Viewer'"
      role_attribute_strict: false
      auto_login: false

    # Logging
    log:
      mode: "console"
      level: "info"
      filters: "rendering:debug"

    # Metrics
    metrics:
      enabled: true
      basic_auth_username: ""
      basic_auth_password: ""

    # Feature toggles
    feature_toggles:
      enable: "alertingPreview,live,publicDashboards,scenes,correlations,datasourceOnboarding,cloudWatchCrossAccountQuerying,libraryPanels,panelTitleSearch,transformationsRedesign,tempoSearch,tempoBackendSearch,prometheusWideSeries,canvasPanelNesting,recordedQueries,publicDashboardsEmailSharing,lokiQuerySplitting,elasticsearchBackendMigration"

    # Library panels para reutiliza√ß√£o
    panels:
      enable_alpha: true
      library_panels: true

    # Public dashboards para stakeholders externos
    public_dashboards:
      enabled: true
      # Configura√ß√£o de seguran√ßa para dashboards p√∫blicos
      annotations_enabled: false
      time_selection_enabled: true

    # Unified alerting nativo do Grafana 10+
    alerting:
      enabled: true
      execute_alerts: true
      error_or_timeout: "alerting"
      nodata_or_nullvalues: "no_data"
      concurrent_render_limit: 5
      max_attempts: 3
      min_interval_seconds: 1
      max_annotation_age: "0s"
      # Configura√ß√£o de notification policies
      notification_timeout_seconds: 30
      max_concurrent_renders: 10
      # Configura√ß√£o de screenshot
      screenshot:
        capture_timeout: 10s
        max_concurrent_screenshots: 5
      # Configura√ß√£o de evalua√ß√£o
      evaluation_timeout_seconds: 30
      max_rule_group_execution_time: 30s
      # Notification policies
      notification_policies:
        - object_matchers:
          - ["severity", "=", "critical"]
          routes:
          - receiver: "neural-hive-critical"
            group_wait: "10s"
            group_interval: "5m"
            repeat_interval: "12h"
        - object_matchers:
          - ["neural_hive_component", "=~", ".*"]
          routes:
          - receiver: "neural-hive-slack"
            group_wait: "30s"
            group_interval: "10m"
            repeat_interval: "1h"

      # Contact points for alerting
      contact_points:
      - name: "neural-hive-critical"
        slack_configs:
        - api_url: "${SLACK_CRITICAL_WEBHOOK}"
          channel: "#neural-hive-critical"
          title: "üö® Critical Alert - Neural Hive-Mind"
          text: |
            Alerta cr√≠tico registrado no cluster Neural Hive-Mind.
            Consulte o Prometheus para detalhes do alerta e acione o runbook correspondente.
      - name: "neural-hive-slack"
        slack_configs:
        - api_url: "${SLACK_GENERAL_WEBHOOK}"
          channel: "#neural-hive-monitoring"
          title: "Alert - Neural Hive-Mind"

    # Live settings
    live:
      allowed_origins: "*"
      max_connections: 100

    # Database (PostgreSQL para produ√ß√£o)
    database:
      type: postgres
      host: "postgresql.observability.svc.cluster.local:5432"
      name: "grafana"
      user: "grafana"
      password: "$__env{GF_DATABASE_PASSWORD}"
      ssl_mode: require
      ca_cert_path: /etc/ssl/certs/ca-certificates.crt
      client_cert_path: ""
      client_key_path: ""
      server_cert_name: ""
      max_idle_conn: 2
      max_open_conn: 0
      conn_max_lifetime: 14400
      log_queries: false
      # Fallback para SQLite em desenvolvimento
      # type: sqlite3
      # path: /var/lib/grafana/grafana.db
      # cache_mode: private

    # Session
    session:
      provider: memory

    # Paths
    paths:
      data: /var/lib/grafana
      logs: /var/log/grafana
      plugins: /var/lib/grafana/plugins
      provisioning: /etc/grafana/provisioning

  # Environment variables
  envFromSecret: grafana-admin-credentials
  env:
    GF_EXPLORE_ENABLED: "true"
    GF_SECURITY_DISABLE_GRAVATAR: "true"
    GF_ANALYTICS_REPORTING_ENABLED: "false"
    GF_FEATURE_TOGGLES_ENABLE: "alertingPreview,live,publicDashboards,libraryPanels"
    # Configura√ß√£o de snapshot autom√°tico
    GF_SNAPSHOTS_EXTERNAL_ENABLED: "true"
    GF_SNAPSHOTS_EXTERNAL_SNAPSHOT_URL: "https://snapshots.neural-hive.local"
    GF_SNAPSHOTS_EXTERNAL_SNAPSHOT_NAME: "Neural Hive Snapshots"
    # Configura√ß√£o de LDAP/OIDC
    GF_AUTH_LDAP_ENABLED: "false"
    GF_AUTH_OAUTH_AUTO_LOGIN: "false"
    # Configura√ß√£o de database
    GF_DATABASE_PASSWORD: "$__env{POSTGRES_PASSWORD}"

  # Configura√ß√£o de sidecar para dashboards autom√°ticos
  sidecar:
    datasources:
      enabled: true
      label: "grafana_datasource"
      labelValue: "1"
      folder: /etc/grafana/provisioning/datasources
      defaultDatasourceEnabled: true
      searchNamespace: ALL
      # Service discovery autom√°tico de datasources
      watchMethod: WATCH
      resource: both
      # Configura√ß√£o de log do sidecar
      logLevel: INFO
      # Intervalo de sincroniza√ß√£o
      skipReload: false
      # Recarregar Grafana ap√≥s mudan√ßas
      enableUniqueFilenames: false

    dashboards:
      enabled: true
      label: "grafana_dashboard"
      labelValue: "1"
      folder: /tmp/dashboards
      folderAnnotation: grafana_folder
      provider:
        name: 'sidecarProvider'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        allowUiUpdates: true
        updateIntervalSeconds: 30
        foldersFromFilesStructure: true
      # Configura√ß√£o de log do sidecar
      watchMethod: WATCH
      resource: both
      logLevel: INFO
      # Intervalo de sincroniza√ß√£o
      skipReload: false
      # Dashboard caching
      enableUniqueFilenames: false

  # Plugins para instalar
  plugins:
  - grafana-piechart-panel
  - grafana-worldmap-panel
  - grafana-clock-panel
  - natel-discrete-panel
  - vonage-status-panel
  - grafana-polystat-panel
  - petrslavotinek-carpetplot-panel
  - briangann-gauge-panel
  - grafana-simple-json-datasource

  # Configura√ß√µes de data sources
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      # Prometheus - primary metrics source
      - name: Prometheus
        type: prometheus
        uid: prometheus
        access: proxy
        url: http://prometheus-kube-prometheus-prometheus:9090
        isDefault: true
        jsonData:
          httpMethod: POST
          # Configura√ß√£o de exemplars para correla√ß√£o
          exemplarTraceIdDestinations:
          - name: trace_id
            datasourceUid: jaeger
            urlDisplayLabel: "View Trace"
          # Configura√ß√£o de custom query parameters
          customQueryParameters: ""
          # Timeout para queries
          timeoutSeconds: 60
          # Query caching
          cacheLevel: "High"
          # Configura√ß√£o de alerts correlation
          prometheusType: "Prometheus"
          prometheusVersion: "2.40.0"
          # Incremental queries para melhor performance
          incrementalQuerying: true
          queryTimeout: "60s"
          # Disable metrics lookup para reduzir lat√™ncia
          disableMetricsLookup: false
        editable: true

      # Jaeger - distributed tracing
      - name: Jaeger
        type: jaeger
        uid: jaeger
        access: proxy
        url: http://jaeger-query:16686
        jsonData:
          nodeGraph:
            enabled: true
        editable: true

      # TestData para desenvolvimento e testes
      - name: TestData
        type: testdata
        uid: testdata
        access: proxy
        editable: true

  # Configura√ß√µes de dashboards
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: 'neural-hive-overview'
        orgId: 1
        folder: 'Neural Hive-Mind'
        type: file
        disableDeletion: false
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards/neural-hive-overview

      - name: 'fluxos-operacionais'
        orgId: 1
        folder: 'Fluxos Operacionais'
        type: file
        disableDeletion: false
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards/fluxos

      - name: 'infrastructure'
        orgId: 1
        folder: 'Infrastructure'
        type: file
        disableDeletion: false
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards/infrastructure

      - name: 'slos'
        orgId: 1
        folder: 'SLOs & Error Budgets'
        type: file
        disableDeletion: false
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards/slos

  # RBAC
  rbac:
    create: true
    pspEnabled: false

  # Service Account
  serviceAccount:
    create: true
    autoMount: true
    annotations: {}

  # Network Policy
  networkPolicy:
    enabled: true
    allowExternal: true
    explicitNamespacesSelector: {}
    ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: observability
      - namespaceSelector:
          matchLabels:
            name: neural-hive
      ports:
      - port: 3000
        protocol: TCP

  # Health checks
  livenessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 30
    failureThreshold: 3
    successThreshold: 1

  readinessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 5
    timeoutSeconds: 10
    failureThreshold: 3
    successThreshold: 1

  # Ingress configuration
  # Formato compativel com Grafana chart 7.0.3
  ingress:
    enabled: true
    ingressClassName: "nginx"
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    path: /
    pathType: Prefix
    hosts:
      - "grafana.neural-hive.local"
    tls:
      - secretName: grafana-tls
        hosts:
          - "grafana.neural-hive.local"

  # Monitoring
  serviceMonitor:
    enabled: true
    labels:
      neural.hive/metrics: "enabled"
    interval: 30s
    scrapeTimeout: 10s
    path: /metrics

# Configura√ß√µes de alerting
alerting:
  enabled: true

  # Configuracao de notificacoes
  slack:
    webhookUrl: ""  # Preencher com URL do webhook Slack
    channel: "#neural-hive-alerts"

  teams:
    webhookUrl: ""  # Preencher com URL do webhook Microsoft Teams

  pagerduty:
    integrationKey: ""  # Preencher com chave de integracao PagerDuty

  email:
    addresses: []  # Lista de emails para alertas

  # Rules espec√≠ficas para Grafana
  rules:
  - alert: GrafanaDown
    expr: up{job="grafana"} == 0
    for: 5m
    labels:
      severity: critical
      neural_hive_component: grafana
      neural_hive_layer: observabilidade
    annotations:
      summary: "Grafana est√° down"
      description: "Grafana n√£o est√° respondendo por mais de 5 minutos"

  - alert: GrafanaHighMemoryUsage
    expr: process_resident_memory_bytes{job="grafana"} / 1024 / 1024 > 1500
    for: 10m
    labels:
      severity: warning
      neural_hive_component: grafana
      neural_hive_layer: observabilidade
    annotations:
      summary: "Grafana usando muita mem√≥ria"
      description: "Grafana acima do limite de mem√≥ria configurado"

# Backup configuration
backup:
  enabled: true
  schedule: "0 2 * * *"  # Daily at 2 AM
  retention: 30  # Days
  storage:
    type: s3
    bucket: neural-hive-backups
    prefix: grafana
    region: us-west-2

# Configura√ß√µes espec√≠ficas por ambiente
environments:
  development:
    grafana:
      replicas: 1
      persistence:
        size: 5Gi
      plugins:
      - grafana-piechart-panel
      - grafana-clock-panel

  staging:
    grafana:
      replicas: 1
      persistence:
        size: 8Gi

  production:
    grafana:
      replicas: 2
      persistence:
        size: 10Gi
      ingress:
        enabled: true
        className: "nginx"
