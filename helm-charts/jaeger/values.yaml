nameOverride: "neural-hive-jaeger"
fullnameOverride: ""

global:
  domain: neural-hive.local
  environment: production

# Configuration for the upstream Jaeger chart
jaeger:
  enabled: true

  # Use production deployment strategy
  allInOne:
    enabled: false

  collector:
    enabled: true
    replicaCount: 3

    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi

    service:
      type: ClusterIP
      grpc:
        name: collector-grpc
        port: 14250
      http:
        name: collector-http
        port: 14268
      admin:
        name: collector-admin
        port: 14269
      otlp:
        grpc:
          name: otlp-grpc
          port: 4317
        http:
          name: otlp-http
          port: 4318

    # OTLP receivers e configurações avançadas
    extraEnv:
      - name: COLLECTOR_OTLP_ENABLED
        value: "true"
      - name: SPAN_STORAGE_TYPE
        value: "elasticsearch"
      - name: ES_SERVER_URLS
        value: "http://elasticsearch:9200"
      - name: ES_INDEX_PREFIX
        value: "neural-hive-jaeger"
      # Configurações de performance
      - name: COLLECTOR_QUEUE_SIZE
        value: "2000"
      - name: COLLECTOR_NUM_WORKERS
        value: "50"
      - name: COLLECTOR_WRITE_CACHE_TTL
        value: "2s"

    cmdlineParams:
      es.server-urls: "http://elasticsearch:9200"
      es.index-prefix: "neural-hive-jaeger"
      es.num-shards: "5"
      es.num-replicas: "1"
      es.bulk.size: "5000000"
      es.bulk.workers: "3"
      es.bulk.flush-interval: "200ms"
      collector.otlp.grpc.host-port: "0.0.0.0:4317"
      collector.otlp.http.host-port: "0.0.0.0:4318"
      collector.grpc-server.max-message-size: "4194304"
      collector.grpc-server.max-connection-age: "2m"
      collector.http-server.host-port: "0.0.0.0:14268"
      collector.grpc-server.host-port: "0.0.0.0:14250"
      # Sampling strategies endpoint
      sampling.strategies-file: "/etc/jaeger/sampling/strategies.json"
      # Health check
      admin.http.host-port: "0.0.0.0:14269"

    extraConfigmapMounts:
      - name: sampling-strategies
        mountPath: /etc/jaeger/sampling
        configMap: jaeger-sampling-strategies
        readOnly: true

    # Anti-affinity para alta disponibilidade
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                - jaeger-collector
            topologyKey: kubernetes.io/hostname

  query:
    enabled: true
    replicaCount: 2

    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 500m
        memory: 512Mi

    service:
      type: ClusterIP
      port: 16686
      targetPort: 16686
      annotations:
        neural.hive/component: "jaeger-query"
        neural.hive/layer: "observabilidade"

    ingress:
      enabled: false

    cmdlineParams:
      es.server-urls: "http://elasticsearch:9200"
      es.index-prefix: "neural-hive-jaeger"
      query.ui-config: "/etc/jaeger/ui-config/ui-config.json"
      # Otimizações de query
      query.max-clock-skew-adjustment: "0s"
      query.timeout: "30s"
      # Configuração de traces
      query.max-trace-duration: "2h"
      # Archive storage para traces antigos
      es.archive.enabled: "true"
      es.archive.index-prefix: "neural-hive-jaeger-archive"
      es.archive.max-span-age: "72h"

    # UI Customizada para Neural Hive-Mind
    extraConfigmapMounts:
      - name: jaeger-ui-config
        mountPath: /etc/jaeger/ui-config
        configMap: jaeger-ui-config
        readOnly: true

    # Health checks otimizados
    livenessProbe:
      httpGet:
        path: /
        port: 16686
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 10
      failureThreshold: 3

    readinessProbe:
      httpGet:
        path: /
        port: 16686
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 5
      failureThreshold: 3

  agent:
    enabled: false

  # Storage configurado por ambiente
  storage:
    type: elasticsearch
    elasticsearch:
      host: elasticsearch.observability.svc.cluster.local
      port: 9200
      scheme: http
      indexPrefix: neural-hive-jaeger
      username: ""
      password: ""
      # Configurações avançadas de storage
      numShards: 5
      numReplicas: 1
      maxSpanAge: 168h  # 7 dias
      # ILM (Index Lifecycle Management)
      useILM: true
      createIndexTemplate: true
      version: 7
      # Otimizações de performance
      bulkSize: 5000000
      bulkWorkers: 3
      bulkActions: 1000
      bulkFlushInterval: 200ms
      sniffing: false
      # Timeout settings
      timeout: 0s
      readTimeout: 0s
      writeTimeout: 0s
      # TLS settings
      tls:
        enabled: false
        skipHostVerify: false
        serverName: ""
        caPath: ""
        certPath: ""
        keyPath: ""

  # Sampling strategies são carregadas via ConfigMap dedicado (templates/configmap-sampling.yaml)
  sampling: {}

  # ServiceMonitor for Prometheus scraping
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
    additionalLabels:
      neural.hive/component: distributed-tracing

  # Metrics collection do próprio Jaeger
  metricsStorage:
    type: prometheus
    prometheus:
      server-url: http://prometheus-kube-prometheus-prometheus:9090

  # Configuração de archive storage para traces de longo prazo
  archiveStorage:
    enabled: true
    type: elasticsearch
    elasticsearch:
      host: elasticsearch.observability.svc.cluster.local
      port: 9200
      indexPrefix: neural-hive-jaeger-archive
      maxSpanAge: 2160h  # 90 dias no archive
      numShards: 3
      numReplicas: 1

# Configuração de UI customizada
uiConfig:
  enabled: true
  config: |
    {
      "monitor": {
        "menuEnabled": true
      },
      "dependencies": {
        "menuEnabled": true
      },
      "archiveEnabled": true,
      "tracking": {
        "gaID": "",
        "trackErrors": false
      },
      "menu": [
        {
          "label": "Neural Hive Docs",
          "url": "https://docs.neural-hive.local",
          "newTab": true
        },
        {
          "label": "Grafana",
          "url": "https://grafana.neural-hive.local",
          "newTab": true
        }
      ],
      "linkPatterns": [
        {
          "type": "process",
          "key": "neural.hive.intent.id",
          "url": "https://grafana.neural-hive.local/d/intents?var-intent_id=#{neural.hive.intent.id}",
          "text": "View Intent Dashboard"
        },
        {
          "type": "process",
          "key": "neural.hive.plan.id",
          "url": "https://grafana.neural-hive.local/d/plans?var-plan_id=#{neural.hive.plan.id}",
          "text": "View Plan Dashboard"
        }
      ]
    }

# Environment specific configs
environments:
  development:
    jaeger:
      allInOne:
        enabled: true
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 250m
            memory: 512Mi
        extraEnv:
          - name: COLLECTOR_OTLP_ENABLED
            value: "true"
        cmdlineParams:
          collector.otlp.grpc.host-port: "0.0.0.0:4317"
          collector.otlp.http.host-port: "0.0.0.0:4318"
          query.ui-config: "/etc/jaeger/ui-config/ui-config.json"
      collector:
        enabled: false
        replicaCount: 1
      query:
        enabled: false
        replicaCount: 1
      storage:
        type: memory
      sampling:
        strategies: |
          {
            "default_strategy": {
              "type": "probabilistic",
              "param": 1.0
            },
            "max_traces_per_second": 1000
          }

  staging:
    jaeger:
      collector:
        replicaCount: 2
      query:
        replicaCount: 1
      sampling:
        strategies: |
          {
            "default_strategy": {
              "type": "probabilistic",
              "param": 0.5
            }
          }

  production:
    jaeger:
      collector:
        replicaCount: 3
      query:
        replicaCount: 2
