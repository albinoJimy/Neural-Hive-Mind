{{- $ctx := include "service-registry.context" . | fromYaml }}

{{- $env := list }}
{{- $env = append $env (dict "name" "SERVICE_NAME" "value" .Values.config.serviceName) }}
{{- $env = append $env (dict "name" "SERVICE_VERSION" "value" .Values.config.serviceVersion) }}
{{- $env = append $env (dict "name" "ENVIRONMENT" "value" .Values.config.environment) }}
{{- $env = append $env (dict "name" "LOG_LEVEL" "value" .Values.config.logLevel) }}
{{- $env = append $env (dict "name" "GRPC_PORT" "value" "50051") }}
{{- $env = append $env (dict "name" "METRICS_PORT" "value" "9090") }}
{{- $env = append $env (dict "name" "ETCD_ENDPOINTS" "value" (.Values.config.etcd.endpoints | toJson)) }}
{{- $env = append $env (dict "name" "ETCD_PREFIX" "value" .Values.config.etcd.prefix) }}
{{- $env = append $env (dict "name" "ETCD_TIMEOUT_SECONDS" "value" (printf "%d" (int .Values.config.etcd.timeoutSeconds))) }}
{{- $env = append $env (dict "name" "HEALTH_CHECK_INTERVAL_SECONDS" "value" (printf "%d" (int .Values.config.healthCheck.intervalSeconds))) }}
{{- $env = append $env (dict "name" "HEARTBEAT_TIMEOUT_SECONDS" "value" (printf "%d" (int .Values.config.heartbeat.timeoutSeconds))) }}
{{- $env = append $env (dict "name" "REDIS_CLUSTER_NODES" "value" (.Values.config.redis.clusterNodes | toJson)) }}
{{- $env = append $env (dict "name" "REDIS_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (printf "%s-secret" (include "service-registry.fullname" .)) "key" "redis-password"))) }}
{{- $env = append $env (dict "name" "OTEL_EXPORTER_ENDPOINT" "value" .Values.config.otel.exporterEndpoint) }}

{{/* SPIFFE environment variables */}}
{{- if .Values.config.spiffe.enabled }}
{{- $env = append $env (dict "name" "SPIFFE_ENABLED" "value" "true") }}
{{- $env = append $env (dict "name" "SPIFFE_SOCKET_PATH" "value" .Values.config.spiffe.socketPath) }}
{{- $env = append $env (dict "name" "SPIFFE_TRUST_DOMAIN" "value" .Values.config.spiffe.trustDomain) }}
{{- $env = append $env (dict "name" "SPIFFE_ENABLE_X509" "value" (printf "%t" .Values.config.spiffe.enableX509)) }}
{{- $env = append $env (dict "name" "SPIFFE_VERIFY_PEER" "value" (printf "%t" .Values.config.spiffe.verifyPeer)) }}
{{- end }}

{{/* Construir volumes dinamicamente (incluindo SPIFFE se habilitado) */}}
{{- $volumes := list }}
{{- if .Values.config.spiffe.enabled }}
{{- $volumes = append $volumes (dict "name" "spire-agent-socket" "hostPath" (dict "path" "/run/spire/sockets" "type" "Directory")) }}
{{- end }}

{{/* Construir volumeMounts dinamicamente (incluindo SPIFFE se habilitado) */}}
{{- $volumeMounts := list }}
{{- if .Values.config.spiffe.enabled }}
{{- $volumeMounts = append $volumeMounts (dict "name" "spire-agent-socket" "mountPath" "/run/spire/sockets" "readOnly" true) }}
{{- end }}

{{/* Construir extraContainers para SPIRE Agent sidecar (se habilitado) */}}
{{- $extraContainers := list }}
{{- if .Values.config.spiffe.enabled }}
{{- $spireAgent := dict
    "name" "spire-agent"
    "image" (printf "%s:%s" (.Values.config.spiffe.agentImage | default "ghcr.io/spiffe/spire-agent") (.Values.config.spiffe.agentTag | default "1.9.0"))
    "imagePullPolicy" "IfNotPresent"
    "args" (list "-config" "/run/spire/config/agent.conf")
    "env" (list
        (dict "name" "MY_NODE_NAME" "valueFrom" (dict "fieldRef" (dict "fieldPath" "spec.nodeName")))
    )
    "volumeMounts" (list
        (dict "name" "spire-agent-socket" "mountPath" "/run/spire/sockets")
        (dict "name" "spire-agent-config" "mountPath" "/run/spire/config" "readOnly" true)
    )
    "resources" (dict
        "requests" (dict "cpu" "50m" "memory" "64Mi")
        "limits" (dict "cpu" "200m" "memory" "128Mi")
    )
    "securityContext" (dict "runAsNonRoot" true "allowPrivilegeEscalation" false)
}}
{{- $extraContainers = append $extraContainers $spireAgent }}
{{/* Add SPIRE Agent config volume */}}
{{- $volumes = append $volumes (dict "name" "spire-agent-config" "configMap" (dict "name" (printf "%s-spire-agent-config" (include "service-registry.fullname" .)))) }}
{{- end }}

{{/* Construir valores modificados com overrides */}}
{{- $modifiedValues := deepCopy .Values }}
{{- $_ := set $modifiedValues "volumes" $volumes }}
{{- $_ := set $modifiedValues "volumeMounts" $volumeMounts }}
{{- $_ := set $modifiedValues "extraContainers" $extraContainers }}

{{- $config := dict "env" $env }}

{{- include "neural-hive.deployment" (dict "values" $modifiedValues "context" $ctx "config" $config) }}
