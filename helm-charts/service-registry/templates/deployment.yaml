{{- $ctx := include "service-registry.context" . | fromYaml }}

{{- $env := list }}
{{- $env = append $env (dict "name" "SERVICE_NAME" "value" .Values.config.serviceName) }}
{{- $env = append $env (dict "name" "SERVICE_VERSION" "value" .Values.config.serviceVersion) }}
{{- $env = append $env (dict "name" "ENVIRONMENT" "value" .Values.config.environment) }}
{{- $env = append $env (dict "name" "LOG_LEVEL" "value" .Values.config.logLevel) }}
{{- $env = append $env (dict "name" "GRPC_PORT" "value" "50051") }}
{{- $env = append $env (dict "name" "METRICS_PORT" "value" "9090") }}
{{- $env = append $env (dict "name" "ETCD_ENDPOINTS" "value" (.Values.config.etcd.endpoints | toJson)) }}
{{- $env = append $env (dict "name" "ETCD_PREFIX" "value" .Values.config.etcd.prefix) }}
{{- $env = append $env (dict "name" "ETCD_TIMEOUT_SECONDS" "value" (printf "%d" (int .Values.config.etcd.timeoutSeconds))) }}
{{- $env = append $env (dict "name" "HEALTH_CHECK_INTERVAL_SECONDS" "value" (printf "%d" (int .Values.config.healthCheck.intervalSeconds))) }}
{{- $env = append $env (dict "name" "HEARTBEAT_TIMEOUT_SECONDS" "value" (printf "%d" (int .Values.config.heartbeat.timeoutSeconds))) }}
{{- $env = append $env (dict "name" "REDIS_CLUSTER_NODES" "value" (.Values.config.redis.clusterNodes | toJson)) }}
{{- $env = append $env (dict "name" "REDIS_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (printf "%s-secret" (include "service-registry.fullname" .)) "key" "redis-password"))) }}
{{- $env = append $env (dict "name" "OTEL_EXPORTER_ENDPOINT" "value" .Values.config.otel.exporterEndpoint) }}

{{- $config := dict "env" $env }}

{{- include "neural-hive.deployment" (dict "values" .Values "context" $ctx "config" $config) }}
