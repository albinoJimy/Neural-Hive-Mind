{{- if .Values.syncConsumer.enabled }}
{{- $fullname := include "memory-layer-api.fullname" . }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $fullname }}-sync-consumer
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ $fullname }}-sync-consumer
    app.kubernetes.io/component: sync-consumer
    app.kubernetes.io/part-of: memory-layer-api
    neural-hive.io/component: memory-sync-consumer
    neural-hive.io/layer: conhecimento-dados
spec:
  replicas: {{ .Values.syncConsumer.replicaCount | default 2 }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ $fullname }}-sync-consumer
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $fullname }}-sync-consumer
        app.kubernetes.io/component: sync-consumer
        neural-hive.io/component: memory-sync-consumer
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}
    spec:
      serviceAccountName: {{ .Values.serviceAccount.name | default "default" }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: sync-consumer
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - python
            - -m
            - src.consumers.sync_event_consumer
          env:
            # Configurações Kafka
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: kafka_bootstrap_servers
            - name: KAFKA_SYNC_TOPIC
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: kafka_sync_topic
            - name: KAFKA_CONSUMER_GROUP
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: kafka_consumer_group
            - name: KAFKA_SECURITY_PROTOCOL
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: kafka_security_protocol
            - name: ENABLE_REALTIME_SYNC
              value: "true"
            # ClickHouse
            - name: CLICKHOUSE_HOST
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: clickhouse_host
            - name: CLICKHOUSE_PORT
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: clickhouse_port
            - name: CLICKHOUSE_USER
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: clickhouse_user
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $fullname }}-secrets
                  key: clickhouse_password
            - name: CLICKHOUSE_DATABASE
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: clickhouse_database
            # Observabilidade
            - name: OTEL_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: otel_endpoint
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: {{ $fullname }}-config
                  key: log_level
          resources:
            {{- toYaml .Values.syncConsumer.resources | nindent 12 }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - "import sys; sys.exit(0)"
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            exec:
              command:
                - python
                - -c
                - "import sys; sys.exit(0)"
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - {{ $fullname }}-sync-consumer
                topologyKey: topology.kubernetes.io/zone
{{- end }}
