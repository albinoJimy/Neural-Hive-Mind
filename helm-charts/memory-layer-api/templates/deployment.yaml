{{- $ctx := include "memory-layer-api.context" . | fromYaml }}
{{- $checksumConfig := include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
{{- $checksumSecret := include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}

{{- $env := list }}
{{- $env = append $env (dict "name" "ENVIRONMENT" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "environment"))) }}
{{- $env = append $env (dict "name" "LOG_LEVEL" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "log_level"))) }}
{{- $env = append $env (dict "name" "DEBUG" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "debug"))) }}
{{- $env = append $env (dict "name" "REDIS_CLUSTER_NODES" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "redis_cluster_nodes"))) }}
{{- $env = append $env (dict "name" "REDIS_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (printf "%s-secrets" (include "memory-layer-api.fullname" .)) "key" "redis_password"))) }}
{{- $env = append $env (dict "name" "REDIS_SSL_ENABLED" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "redis_ssl_enabled"))) }}
{{- $env = append $env (dict "name" "REDIS_DEFAULT_TTL" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "redis_default_ttl"))) }}
{{- $env = append $env (dict "name" "MONGODB_URI" "valueFrom" (dict "secretKeyRef" (dict "name" (printf "%s-secrets" (include "memory-layer-api.fullname" .)) "key" "mongodb_uri"))) }}
{{- $env = append $env (dict "name" "MONGODB_DATABASE" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "mongodb_database"))) }}
{{- $env = append $env (dict "name" "MONGODB_RETENTION_DAYS" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "mongodb_retention_days"))) }}
{{- $env = append $env (dict "name" "NEO4J_URI" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "neo4j_uri"))) }}
{{- $env = append $env (dict "name" "NEO4J_USER" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "neo4j_user"))) }}
{{- $env = append $env (dict "name" "NEO4J_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (printf "%s-secrets" (include "memory-layer-api.fullname" .)) "key" "neo4j_password"))) }}
{{- $env = append $env (dict "name" "NEO4J_DATABASE" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "neo4j_database"))) }}
{{- $env = append $env (dict "name" "CLICKHOUSE_HOST" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "clickhouse_host"))) }}
{{- $env = append $env (dict "name" "CLICKHOUSE_PORT" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "clickhouse_port"))) }}
{{- $env = append $env (dict "name" "CLICKHOUSE_USER" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "clickhouse_user"))) }}
{{- $env = append $env (dict "name" "CLICKHOUSE_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (printf "%s-secrets" (include "memory-layer-api.fullname" .)) "key" "clickhouse_password"))) }}
{{- $env = append $env (dict "name" "CLICKHOUSE_DATABASE" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "clickhouse_database"))) }}
{{- $env = append $env (dict "name" "CLICKHOUSE_RETENTION_MONTHS" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "clickhouse_retention_months"))) }}
{{- $env = append $env (dict "name" "OTEL_ENDPOINT" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "otel_endpoint"))) }}
{{- $env = append $env (dict "name" "PROMETHEUS_PORT" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "prometheus_port"))) }}
{{- $env = append $env (dict "name" "ENABLE_CACHE" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "enable_cache"))) }}
{{- $env = append $env (dict "name" "ENABLE_LINEAGE_TRACKING" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "enable_lineage_tracking"))) }}
{{- $env = append $env (dict "name" "ENABLE_QUALITY_MONITORING" "valueFrom" (dict "configMapKeyRef" (dict "name" (printf "%s-config" (include "memory-layer-api.fullname" .)) "key" "enable_quality_monitoring"))) }}

{{- $config := dict "checksumConfig" $checksumConfig "checksumSecret" $checksumSecret "env" $env }}

{{- include "neural-hive.deployment" (dict "values" .Values "context" $ctx "config" $config) }}
