apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "memory-layer-api.fullname" . }}
  labels:
    {{- include "memory-layer-api.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "memory-layer-api.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}
        {{- if .Values.istio.enabled }}
        sidecar.istio.io/inject: "{{ .Values.istio.sidecar.inject }}"
        {{- end }}
      labels:
        {{- include "memory-layer-api.selectorLabels" . | nindent 8 }}
        neural-hive-mind.org/component: memory-layer-api
        neural-hive-mind.org/layer: conhecimento-dados
    spec:
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}

      containers:
      - name: {{ .Chart.Name }}
        securityContext:
          {{- toYaml .Values.securityContext | nindent 10 }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}

        ports:
        - name: http
          containerPort: 8000
          protocol: TCP
        - name: metrics
          containerPort: 8080
          protocol: TCP

        livenessProbe:
          {{- toYaml .Values.livenessProbe | nindent 10 }}

        readinessProbe:
          {{- toYaml .Values.readinessProbe | nindent 10 }}

        resources:
          {{- toYaml .Values.resources | nindent 10 }}

        env:
        # Application
        - name: ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: environment
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: log_level
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: debug

        # Redis
        - name: REDIS_CLUSTER_NODES
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: redis_cluster_nodes
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-secrets
              key: redis_password
        - name: REDIS_SSL_ENABLED
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: redis_ssl_enabled
        - name: REDIS_DEFAULT_TTL
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: redis_default_ttl

        # MongoDB
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-secrets
              key: mongodb_uri
        - name: MONGODB_DATABASE
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: mongodb_database
        - name: MONGODB_RETENTION_DAYS
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: mongodb_retention_days

        # Neo4j
        - name: NEO4J_URI
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: neo4j_uri
        - name: NEO4J_USER
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: neo4j_user
        - name: NEO4J_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-secrets
              key: neo4j_password
        - name: NEO4J_DATABASE
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: neo4j_database

        # ClickHouse
        - name: CLICKHOUSE_HOST
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: clickhouse_host
        - name: CLICKHOUSE_PORT
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: clickhouse_port
        - name: CLICKHOUSE_USER
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: clickhouse_user
        - name: CLICKHOUSE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-secrets
              key: clickhouse_password
        - name: CLICKHOUSE_DATABASE
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: clickhouse_database
        - name: CLICKHOUSE_RETENTION_MONTHS
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: clickhouse_retention_months

        # Observability
        - name: OTEL_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: otel_endpoint

        # Feature Flags
        - name: ENABLE_CACHE
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: enable_cache
        - name: ENABLE_LINEAGE_TRACKING
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: enable_lineage_tracking
        - name: ENABLE_QUALITY_MONITORING
          valueFrom:
            configMapKeyRef:
              name: {{ include "memory-layer-api.fullname" . }}-config
              key: enable_quality_monitoring

      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
