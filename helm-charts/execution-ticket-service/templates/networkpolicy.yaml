{{- if .Values.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "execution-ticket-service.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "execution-ticket-service.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "execution-ticket-service.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow Prometheus scraping
  - from:
    - namespaceSelector:
        matchLabels:
          name: observability
    ports:
    - protocol: TCP
      port: 9090
  # Allow HTTP traffic from neural-hive-services
  - from:
    - namespaceSelector:
        matchLabels:
          name: neural-hive-services
    ports:
    - protocol: TCP
      port: 8000
  # Allow gRPC traffic from neural-hive-services
  - from:
    - namespaceSelector:
        matchLabels:
          name: neural-hive-services
    ports:
    - protocol: TCP
      port: 50052
  # Allow Istio sidecar traffic
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow PostgreSQL
  - to:
    - namespaceSelector:
        matchLabels:
          name: data-stores
    ports:
    - protocol: TCP
      port: 5432
  # Allow MongoDB
  - to:
    - namespaceSelector:
        matchLabels:
          name: mongodb-cluster
    ports:
    - protocol: TCP
      port: 27017
  # Allow Kafka
  - to:
    - namespaceSelector:
        matchLabels:
          name: kafka
    ports:
    - protocol: TCP
      port: 9092
  # Allow OTEL Collector
  - to:
    - namespaceSelector:
        matchLabels:
          name: observability
    ports:
    - protocol: TCP
      port: 4317
  # Allow external webhooks (all egress for webhook functionality)
  - to:
    - namespaceSelector: {}
{{- end }}
