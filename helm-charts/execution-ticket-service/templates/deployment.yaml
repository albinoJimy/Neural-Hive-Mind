{{- $ctx := include "execution-ticket-service.context" . | fromYaml }}
{{- $checksumConfig := "" }}
{{- if .Values.config.enabled }}
{{- $checksumConfig = include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
{{- end }}

{{- $env := list }}
{{- $env = append $env (dict "name" "POSTGRES_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (ternary (include "execution-ticket-service.secretName" .) .Values.secrets.existingSecret .Values.secrets.create) "key" (default "postgres-password" .Values.secrets.postgresPasswordKey)))) }}
{{- $env = append $env (dict "name" "MONGODB_URI" "valueFrom" (dict "secretKeyRef" (dict "name" (ternary (include "execution-ticket-service.secretName" .) .Values.secrets.existingSecret .Values.secrets.create) "key" (default "mongodb-uri" .Values.secrets.mongodbUriKey)))) }}
{{- $env = append $env (dict "name" "JWT_SECRET_KEY" "valueFrom" (dict "secretKeyRef" (dict "name" (ternary (include "execution-ticket-service.secretName" .) .Values.secrets.existingSecret .Values.secrets.create) "key" (default "jwt-secret-key" .Values.secrets.jwtSecretKeyKey)))) }}

{{- $envFrom := list }}
{{- if .Values.config.enabled }}
{{- $envFrom = append $envFrom (dict "configMapRef" (dict "name" (include "execution-ticket-service.configMapName" .))) }}
{{- end }}

{{- $config := dict "checksumConfig" $checksumConfig "env" $env "envFrom" $envFrom }}

{{- include "neural-hive.deployment" (dict "values" .Values "context" $ctx "config" $config) }}
