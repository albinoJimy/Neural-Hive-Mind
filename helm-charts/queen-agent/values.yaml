component: "queen-agent"
layer: "coordination"

replicaCount: 1

nameOverride: ""
fullnameOverride: ""

image:
  repository: ghcr.io/albinojimy/neural-hive-mind/queen-agent
  tag: "1.2.1"
  pullPolicy: Always

imagePullSecrets:
  - name: ghcr-secret

serviceAccount:
  create: true
  name: ""

service:
  type: ClusterIP
  ports:
    http:
      port: 8000
      targetPort: 8000
      protocol: TCP
    grpc:
      port: 50053
      targetPort: 50053
      protocol: TCP
    metrics:
      port: 9090
      targetPort: 9090
      protocol: TCP

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"

resources:
  requests:
    cpu: 100m  # Reduced from 300m - actual usage ~20m
    memory: 256Mi  # Reduced from 512Mi
  limits:
    cpu: 400m  # Reduced from 1000m
    memory: 512Mi  # Reduced from 1Gi

config:
  serviceName: queen-agent
  serviceVersion: "1.0.0"
  environment: production
  logLevel: INFO
  corsOrigins:
    - "*"

  fastapi:
    host: 0.0.0.0
    port: 8000

  grpc:
    port: 50053
    maxWorkers: 10

  kafka:
    bootstrapServers: neural-hive-kafka-kafka-bootstrap.kafka.svc.cluster.local:9092
    consumerGroup: queen-agent-group
    autoOffsetReset: earliest
    securityProtocol: SASL_SSL
    saslMechanism: SCRAM-SHA-512
    topics:
      consensus: plans.consensus
      telemetry: telemetry.aggregated
      incidents: incidents.critical
      strategic: strategic.decisions

  mongodb:
    # Password injected via Secret (MONGODB_PASSWORD env var)
    uri: mongodb://root@mongodb.mongodb-cluster.svc.cluster.local:27017
    database: neural_hive
    ledgerCollection: strategic_decisions_ledger
    exceptionsCollection: exception_approvals
    maxPoolSize: 100
    minPoolSize: 10

  redis:
    clusterNodes: neural-hive-cache.redis-cluster.svc.cluster.local:6379
    # Password injected via Secret (REDIS_PASSWORD env var)
    sslEnabled: false
    pheromonePrefix: "pheromone:strategic:"
    cacheTtlSeconds: 300

  neo4j:
    uri: bolt://neo4j.neo4j.svc.cluster.local:7687
    user: neo4j
    # Password injected via Secret (NEO4J_PASSWORD env var)
    database: neo4j
    maxConnectionPoolSize: 50

  prometheus:
    url: http://prometheus-server.monitoring.svc.cluster.local:9090
    queryTimeoutSeconds: 30

  orchestrator:
    grpcHost: orchestrator-dynamic.neural-hive.svc.cluster.local
    grpcPort: 50053
    grpcTimeout: 10

  serviceRegistry:
    grpcHost: service-registry.neural-hive.svc.cluster.local
    grpcPort: 50051

  # SPIFFE/SPIRE mTLS para comunicação segura com Orchestrator
  spiffe:
    enabled: false  # Habilitar em produção para mTLS
    socketPath: unix:///run/spire/sockets/agent.sock
    trustDomain: neural-hive.local
    enableX509: true

  # Circuit Breaker para resiliência
  circuitBreaker:
    enabled: true
    failMax: 5
    timeoutSeconds: 60
    recoveryTimeoutSeconds: 30

  # OPA Policy Engine
  opa:
    enabled: true
    url: http://opa.neural-hive-governance.svc.cluster.local:8181
    timeoutSeconds: 5
    failOpen: false  # Fail closed em produção

  observability:
    # OpenTelemetry Collector endpoint (gRPC)
    otelExporterEndpoint: http://otel-collector.observability.svc.cluster.local:4317
    # Prometheus metrics port
    prometheusPort: 9090

serviceMonitor:
  enabled: true
  interval: 30s

deployment:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

observability:
  prometheus:
    enabled: true
  # TLS Configuration para OpenTelemetry Exporter
  tls:
    enabled: false  # Habilitar em produção
    certSecret: "neural-hive-otel-client-certs"
    mountPath: "/etc/otel-tls"

istio:
  enabled: true
  mtls:
    mode: STRICT

livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 30

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 15

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5

# Secrets - credenciais injetadas como variáveis de ambiente
# Em produção, usar External Secrets Operator ou Vault
secrets:
  mongodbPassword: ""
  redisPassword: ""
  neo4jPassword: ""
  kafkaSaslPassword: ""

# Segurança do pod
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true

# Startup probe para aguardar dependências
startupProbe:
  httpGet:
    path: /health
    port: 8000
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 18
  successThreshold: 1

# Network policy
networkPolicy:
  enabled: true

# Pod Disruption Budget
pdb:
  enabled: true
  minAvailable: 1
