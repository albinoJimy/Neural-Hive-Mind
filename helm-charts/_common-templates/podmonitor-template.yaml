# Template padrão para PodMonitor do Neural Hive-Mind
# Para uso quando monitoramento direto de pods é necessário (ex: DaemonSets, Jobs)

{{- define "neural-hive.podmonitor" -}}
{{- $component := .component }}
{{- $layer := .layer }}
{{- $values := .values }}
{{- $context := .context }}
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: {{ $context.fullname }}-pods
  namespace: {{ $context.namespace }}
  labels:
    # Labels básicos do Helm
    {{- with $context.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    # Labels padrão Neural Hive-Mind para descoberta do Prometheus
    neural.hive/metrics: "enabled"
    neural.hive/component: {{ $component | quote }}
    neural.hive/layer: {{ $layer | quote }}
    neural.hive/monitor-type: "pod"
    # Label para seletor do Prometheus Operator
    release: prometheus
    {{- with $values.podMonitor.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    neural.hive/scrape-config: "pod-direct"
    neural.hive/metrics-path: {{ $values.podMonitor.path | default "/metrics" | quote }}
    neural.hive/scrape-interval: {{ $values.podMonitor.interval | default "30s" | quote }}
    neural.hive/component-version: {{ $context.version | quote }}
spec:
  selector:
    matchLabels:
      {{- with $context.selectorLabels }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
      {{- with $values.podMonitor.additionalSelector }}
      {{- toYaml . | nindent 6 }}
      {{- end }}

  podMetricsEndpoints:
  - port: {{ $values.podMonitor.portName | default "http" }}
    path: {{ $values.podMonitor.path | default "/metrics" }}
    interval: {{ $values.podMonitor.interval | default "30s" }}
    scrapeTimeout: {{ $values.podMonitor.scrapeTimeout | default "10s" }}

    # Configurações de segurança para autenticação
    {{- if $values.podMonitor.basicAuth }}
    basicAuth:
      username:
        name: {{ $values.podMonitor.basicAuth.secretName }}
        key: {{ $values.podMonitor.basicAuth.usernameKey }}
      password:
        name: {{ $values.podMonitor.basicAuth.secretName }}
        key: {{ $values.podMonitor.basicAuth.passwordKey }}
    {{- end }}

    {{- if $values.podMonitor.tlsConfig }}
    tlsConfig:
      {{- toYaml $values.podMonitor.tlsConfig | nindent 6 }}
    {{- end }}

    # Relabeling para adicionar metadados padrão do Neural Hive-Mind
    relabelings:
    # Metadados Kubernetes específicos de pods
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: kubernetes_pod_name
    - sourceLabels: [__meta_kubernetes_pod_namespace]
      targetLabel: kubernetes_namespace
    - sourceLabels: [__meta_kubernetes_pod_container_name]
      targetLabel: kubernetes_container_name
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      targetLabel: kubernetes_node_name
    - sourceLabels: [__meta_kubernetes_pod_host_ip]
      targetLabel: kubernetes_host_ip
    - sourceLabels: [__meta_kubernetes_pod_ip]
      targetLabel: kubernetes_pod_ip
    # Labels padrão Neural Hive-Mind
    - targetLabel: neural_hive_component
      replacement: {{ $component }}
    - targetLabel: neural_hive_layer
      replacement: {{ $layer }}
    - targetLabel: cluster
      replacement: {{ $context.cluster | default "neural-hive-main" }}
    - targetLabel: environment
      replacement: {{ $context.environment | default "production" }}
    # Informações específicas de pod
    - targetLabel: monitoring_type
      replacement: pod
    # Labels adicionais específicos do serviço
    {{- range $key, $value := $values.podMonitor.additionalLabels }}
    - targetLabel: {{ $key }}
      replacement: {{ $value }}
    {{- end }}

    # Metric relabeling para padronização Neural Hive-Mind
    metricRelabelings:
    # Garantir que métricas têm o prefixo neural_hive_
    - sourceLabels: [__name__]
      regex: "neural_hive_(.+)"
      targetLabel: __name__
      replacement: "neural_hive_${1}"
    # Adicionar labels padrão a métricas Neural Hive-Mind
    - sourceLabels: [__name__]
      regex: "neural_hive_.*"
      targetLabel: neural_hive_component
      replacement: {{ $component }}
    - sourceLabels: [__name__]
      regex: "neural_hive_.*"
      targetLabel: neural_hive_layer
      replacement: {{ $layer }}
    # Preservar correlation IDs importantes
    - sourceLabels: [neural_hive_intent_id]
      targetLabel: intent_id
    - sourceLabels: [neural_hive_plan_id]
      targetLabel: plan_id
    # Adicionar informações de instância para pods
    - sourceLabels: [kubernetes_pod_name]
      targetLabel: instance_name
    - targetLabel: component_version
      replacement: {{ $context.version }}
    # Relabelings personalizados por serviço
    {{- with $values.podMonitor.metricRelabelings }}
    {{- toYaml . | nindent 4 }}
    {{- end }}

  # Configuração de namespace
  {{- if $values.podMonitor.namespaceSelector }}
  namespaceSelector:
    {{- toYaml $values.podMonitor.namespaceSelector | nindent 4 }}
  {{- else }}
  namespaceSelector:
    matchNames:
    - {{ $context.namespace }}
  {{- end }}

  # Configurações de limite para controle de cardinalidade
  {{- if $values.podMonitor.sampleLimit }}
  sampleLimit: {{ $values.podMonitor.sampleLimit }}
  {{- end }}

  {{- if $values.podMonitor.targetLimit }}
  targetLimit: {{ $values.podMonitor.targetLimit }}
  {{- end }}

  # Configuração de honorLabels para preservar labels do pod
  honorLabels: {{ $values.podMonitor.honorLabels | default false }}

  # Configuração de honorTimestamps
  honorTimestamps: {{ $values.podMonitor.honorTimestamps | default true }}

{{- end -}}