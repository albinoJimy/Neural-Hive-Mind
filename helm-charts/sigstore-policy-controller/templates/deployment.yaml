{{- $ctx := include "sigstore-policy-controller.context" . | fromYaml }}

{{/*
Construir env vars específicas do policy-controller
*/}}
{{- $env := list }}
{{- $env = append $env (dict "name" "SYSTEM_NAMESPACE" "valueFrom" (dict "fieldRef" (dict "fieldPath" "metadata.namespace"))) }}
{{- $env = append $env (dict "name" "CONFIG_LOGGING_NAME" "value" "config-logging") }}
{{- $env = append $env (dict "name" "CONFIG_OBSERVABILITY_NAME" "value" "config-observability") }}
{{- $env = append $env (dict "name" "METRICS_DOMAIN" "value" "sigstore.dev/policy-controller") }}
{{- $env = append $env (dict "name" "WEBHOOK_NAME" "value" .Values.webhook.name) }}
{{- if .Values.cosign.rekorURL }}
{{- $env = append $env (dict "name" "REKOR_URL" "value" .Values.cosign.rekorURL) }}
{{- end }}
{{- if .Values.cosign.fulcioURL }}
{{- $env = append $env (dict "name" "FULCIO_URL" "value" .Values.cosign.fulcioURL) }}
{{- end }}

{{/*
Construir volumes e volumeMounts para webhook-certs
*/}}
{{- $volumes := list }}
{{- $volumes = append $volumes (dict "name" "webhook-certs" "secret" (dict "secretName" .Values.tls.secretName)) }}

{{- $volumeMounts := list }}
{{- $volumeMounts = append $volumeMounts (dict "name" "webhook-certs" "mountPath" "/etc/ssl/certs" "readOnly" true) }}

{{/*
Construir valores modificados para o template comum
*/}}
{{- $modifiedValues := deepCopy .Values }}
{{- $_ := set $modifiedValues "volumeMounts" $volumeMounts }}
{{- $_ := set $modifiedValues "volumes" $volumes }}

{{/*
Configuração para o template
*/}}
{{- $config := dict "env" $env }}

{{- include "neural-hive.deployment" (dict "values" $modifiedValues "context" $ctx "config" $config) }}
