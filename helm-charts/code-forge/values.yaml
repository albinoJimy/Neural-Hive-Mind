component: "code-forge"
layer: "execution"

replicaCount: 2

# Disable Kubernetes service links to prevent env var collisions with pydantic settings
enableServiceLinks: false

image:
  repository: 37.60.241.150:30500/code-forge
  tag: "1.2.1"
  pullPolicy: IfNotPresent

deployment:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

service:
  type: ClusterIP
  annotations: {}
  ports:
    http:
      port: 8080
      targetPort: 8080
      protocol: TCP
    grpc:
      port: 50051
      targetPort: 50051
      protocol: TCP
    metrics:
      port: 9090
      targetPort: 9090
      protocol: TCP

resources:
  # Git clone + template rendering bursts demand but average utilization stays <600m CPU.
  # Keep higher request (800m) than other services to accommodate build phases while trimming
  # previous 2 vCPU / 4Gi upper bound down to 2.2 vCPU / 3.5Gi.
  requests:
    cpu: 800m
    memory: 1536Mi
  limits:
    cpu: 2200m
    memory: 3584Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

podDisruptionBudget:
  minAvailable: 1

serviceAccount:
  create: true
  name: code-forge
  annotations: {}
    # eks.amazonaws.com/role-arn: ""  # ARN do IRSA role para S3

# Configuração S3 para artefatos e SBOMs
s3:
  enabled: false
  bucket: ""
  region: "us-east-1"
  endpoint: ""  # Para MinIO/LocalStack

serviceMonitor:
  enabled: true

observability:
  prometheus:
    enabled: true
  # TLS Configuration para OpenTelemetry Exporter
  tls:
    enabled: false  # Habilitar em produção
    certSecret: "neural-hive-otel-client-certs"
    mountPath: "/etc/otel-tls"

istio:
  enabled: true
  mtls:
    mode: STRICT

config:
  SERVICE_NAME: code-forge
  NAMESPACE: neural-hive-execution
  CLUSTER: production

  # Kafka
  KAFKA_BOOTSTRAP_SERVERS: neural-hive-kafka-kafka-bootstrap.kafka.svc.cluster.local:9092
  KAFKA_TICKETS_TOPIC: execution.tickets
  KAFKA_RESULTS_TOPIC: code-forge.results
  KAFKA_CONSUMER_GROUP_ID: code-forge

  # PostgreSQL
  POSTGRES_HOST: postgresql.postgresql.svc.cluster.local
  POSTGRES_PORT: 5432
  POSTGRES_DB: code_forge

  # MongoDB
  MONGODB_HOST: mongodb.mongodb-cluster.svc.cluster.local
  MONGODB_PORT: 27017
  MONGODB_DB: code_forge

  # Redis
  REDIS_HOST: neural-hive-cache.redis-cluster.svc.cluster.local
  REDIS_PORT: 6379

  # Service Registry
  SERVICE_REGISTRY_HOST: service-registry
  SERVICE_REGISTRY_PORT: 50051

  # Execution Ticket Service
  EXECUTION_TICKET_SERVICE_URL: http://execution-ticket-service:8080

  # Templates
  TEMPLATES_GIT_REPO: https://github.com/neural-hive/templates.git
  TEMPLATES_GIT_BRANCH: main
  TEMPLATES_LOCAL_PATH: /app/templates

  # Pipeline
  MAX_CONCURRENT_PIPELINES: 3
  PIPELINE_TIMEOUT_SECONDS: 3600
  AUTO_APPROVAL_THRESHOLD: 0.9
  MIN_QUALITY_SCORE: 0.5
  MIN_TEST_COVERAGE: 0.8

  # Observability
  OTEL_EXPORTER_ENDPOINT: http://otel-collector:4317
  LOG_LEVEL: INFO
  LOG_FORMAT: json

secrets:
  # Use existingSecret para referenciar secrets criados pelo create-phase2-secrets.sh
  # Os Helm charts usam secretKeyRef para ler valores diretamente dos secrets K8s
  existingSecret: "code-forge-secrets"
  # Mapeamento de chaves do secret para variáveis de ambiente
  postgresUserKey: POSTGRES_USER
  postgresPasswordKey: POSTGRES_PASSWORD
  mongodbUriKey: MONGODB_URI
  redisPasswordKey: REDIS_PASSWORD
  kafkaSaslUsernameKey: KAFKA_SASL_USERNAME
  kafkaSaslPasswordKey: KAFKA_SASL_PASSWORD
  gitUsernameKey: GIT_USERNAME
  gitTokenKey: GIT_TOKEN
  openaiApiKeyKey: OPENAI_API_KEY
  anthropicApiKeyKey: ANTHROPIC_API_KEY

networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: istio-system
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - podSelector:
            matchLabels:
              neural-hive-mind.org/code-forge-access: "enabled"
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kafka
      ports:
        - protocol: TCP
          port: 9092
    - to:
        - namespaceSelector:
            matchLabels:
              name: postgres
      ports:
        - protocol: TCP
          port: 5432
    - to:
        - namespaceSelector:
            matchLabels:
              name: mongodb
      ports:
        - protocol: TCP
          port: 27017
    - to:
        - namespaceSelector:
            matchLabels:
              name: redis
      ports:
        - protocol: TCP
          port: 6379
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: service-registry
      ports:
        - protocol: TCP
          port: 50051
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: execution-ticket-service
      ports:
        - protocol: TCP
          port: 8080
    - to: []  # DNS
      ports:
        - protocol: UDP
          port: 53
    - to: []  # HTTPS para Git
      ports:
        - protocol: TCP
          port: 443

startupProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 25  # Até 4.1min para clonar templates privados antes de expor readiness
  successThreshold: 1

livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - code-forge
          topologyKey: topology.kubernetes.io/zone

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: code-forge
