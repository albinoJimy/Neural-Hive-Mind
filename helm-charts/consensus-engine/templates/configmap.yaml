apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "consensus-engine.configMapName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "consensus-engine.labels" . | nindent 4 }}
data:
  ENVIRONMENT: {{ .Values.config.environment | quote }}
  LOG_LEVEL: {{ .Values.config.logLevel | quote }}

  # Kafka Configuration
  KAFKA_BOOTSTRAP_SERVERS: {{ .Values.config.kafka.bootstrapServers | quote }}
  KAFKA_CONSUMER_GROUP_ID: {{ .Values.config.kafka.consumerGroupId | quote }}
  KAFKA_PLANS_TOPIC_CONSUME: {{ .Values.config.kafka.plansTopicConsume | quote }}
  KAFKA_CONSENSUS_TOPIC_PRODUCE: {{ .Values.config.kafka.consensusTopicProduce | quote }}
  KAFKA_SECURITY_PROTOCOL: {{ .Values.config.kafka.securityProtocol | quote }}
  KAFKA_SASL_MECHANISM: {{ .Values.config.kafka.saslMechanism | quote }}
  SCHEMA_REGISTRY_URL: {{ .Values.config.kafka.schemaRegistryUrl | quote }}

  # Specialist Configuration
  SPECIALIST_BUSINESS_ENDPOINT: {{ .Values.config.specialists.businessEndpoint | quote }}
  SPECIALIST_TECHNICAL_ENDPOINT: {{ .Values.config.specialists.technicalEndpoint | quote }}
  SPECIALIST_BEHAVIOR_ENDPOINT: {{ .Values.config.specialists.behaviorEndpoint | quote }}
  SPECIALIST_EVOLUTION_ENDPOINT: {{ .Values.config.specialists.evolutionEndpoint | quote }}
  SPECIALIST_ARCHITECTURE_ENDPOINT: {{ .Values.config.specialists.architectureEndpoint | quote }}
  # NOTA: Pydantic Settings espera GRPC_TIMEOUT_MS (sem prefixo SPECIALIST_)
  # devido ao mapeamento autom√°tico de field names em Settings class.
  # Timeout increased to 120000ms (120 seconds) to accommodate specialist
  # processing time of 49-66 seconds for ML inference.
  GRPC_TIMEOUT_MS: {{ .Values.config.specialists.grpcTimeoutMs | quote }}
  GRPC_MAX_RETRIES: {{ .Values.config.specialists.grpcMaxRetries | quote }}

  # Queen Agent gRPC Configuration
  {{- if .Values.config.queenAgent }}
  QUEEN_AGENT_GRPC_HOST: {{ .Values.config.queenAgent.grpcHost | quote }}
  QUEEN_AGENT_GRPC_PORT: {{ .Values.config.queenAgent.grpcPort | quote }}
  {{- end }}

  # SPIFFE/mTLS Configuration
  {{- if .Values.config.spiffe }}
  SPIFFE_ENABLED: {{ .Values.config.spiffe.enabled | quote }}
  SPIFFE_ENABLE_X509: {{ .Values.config.spiffe.enableX509 | quote }}
  SPIFFE_SOCKET_PATH: {{ .Values.config.spiffe.socketPath | quote }}
  SPIFFE_TRUST_DOMAIN: {{ .Values.config.spiffe.trustDomain | quote }}
  SPIFFE_JWT_AUDIENCE: {{ .Values.config.spiffe.jwtAudience | quote }}
  SPIFFE_JWT_TTL_SECONDS: {{ .Values.config.spiffe.jwtTtlSeconds | quote }}
  {{- end }}

  # MongoDB Configuration
  MONGODB_URI: {{ .Values.config.mongodb.uri | quote }}
  MONGODB_DATABASE: {{ .Values.config.mongodb.database | quote }}
  MONGODB_CONSENSUS_COLLECTION: {{ .Values.config.mongodb.consensusCollection | quote }}

  # Redis Configuration
  REDIS_CLUSTER_NODES: {{ .Values.config.redis.clusterNodes | quote }}
  REDIS_SSL_ENABLED: {{ .Values.config.redis.sslEnabled | quote }}
  REDIS_PHEROMONE_TTL: {{ .Values.config.redis.pheromoneTtl | quote }}
  REDIS_PHEROMONE_DECAY_RATE: {{ .Values.config.redis.pheromoneDecayRate | quote }}

  # OpenTelemetry Configuration
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ .Values.config.openTelemetry.endpoint | quote }}
  OTEL_SAMPLING_RATE: {{ .Values.config.openTelemetry.samplingRate | quote }}

  # Consensus Configuration
  CONSENSUS_MIN_CONFIDENCE_SCORE: {{ .Values.config.consensus.minConfidenceScore | quote }}
  CONSENSUS_MAX_DIVERGENCE_THRESHOLD: {{ .Values.config.consensus.maxDivergenceThreshold | quote }}
  CONSENSUS_HIGH_RISK_THRESHOLD: {{ .Values.config.consensus.highRiskThreshold | quote }}
  CONSENSUS_CRITICAL_RISK_THRESHOLD: {{ .Values.config.consensus.criticalRiskThreshold | quote }}
  CONSENSUS_BAYESIAN_PRIOR_WEIGHT: {{ .Values.config.consensus.bayesianPriorWeight | quote }}
  CONSENSUS_VOTING_WEIGHT_DECAY: {{ .Values.config.consensus.votingWeightDecay | quote }}
  CONSENSUS_REQUIRE_UNANIMOUS_FOR_CRITICAL: {{ .Values.config.consensus.requireUnanimousForCritical | quote }}
  CONSENSUS_FALLBACK_TO_DETERMINISTIC: {{ .Values.config.consensus.fallbackToDeterministic | quote }}

  # Feature Flags
  ENABLE_BAYESIAN_AVERAGING: {{ .Values.config.features.enableBayesianAveraging | quote }}
  ENABLE_PHEROMONES: {{ .Values.config.features.enablePheromones | quote }}
  ENABLE_FALLBACK: {{ .Values.config.features.enableFallback | quote }}
  ENABLE_PARALLEL_INVOCATION: {{ .Values.config.features.enableParallelInvocation | quote }}
  ENABLE_TRACING: {{ .Values.config.features.enableTracing | default "true" | quote }}
