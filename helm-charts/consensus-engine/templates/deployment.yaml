{{- $ctx := include "consensus-engine.context" . | fromYaml }}
{{- $checksumConfig := include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
{{- $checksumSecret := include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}

{{/*
Construir envFrom para o deployment
*/}}
{{- $envFrom := list }}
{{- $envFrom = append $envFrom (dict "configMapRef" (dict "name" (include "consensus-engine.configMapName" .))) }}
{{- $envFrom = append $envFrom (dict "secretRef" (dict "name" (include "consensus-engine.secretName" .))) }}

{{/*
Construir volumes e volumeMounts
*/}}
{{- $volumes := list }}
{{- $volumes = append $volumes (dict "name" "tmp" "emptyDir" (dict)) }}
{{- $volumes = append $volumes (dict "name" "logs" "emptyDir" (dict)) }}
{{- if and .Values.config.spiffe .Values.config.spiffe.enabled }}
{{- $volumes = append $volumes (dict "name" "spire-agent-socket" "hostPath" (dict "path" "/run/spire/sockets" "type" "DirectoryOrCreate")) }}
{{- end }}

{{- $volumeMounts := list }}
{{- $volumeMounts = append $volumeMounts (dict "name" "tmp" "mountPath" "/tmp") }}
{{- $volumeMounts = append $volumeMounts (dict "name" "logs" "mountPath" "/app/logs") }}
{{- if and .Values.config.spiffe .Values.config.spiffe.enabled }}
{{- $volumeMounts = append $volumeMounts (dict "name" "spire-agent-socket" "mountPath" "/run/spire/sockets" "readOnly" true) }}
{{- end }}

{{/*
Construir valores modificados para o template comum
*/}}
{{- $modifiedValues := deepCopy .Values }}
{{- $_ := set $modifiedValues "volumeMounts" $volumeMounts }}
{{- $_ := set $modifiedValues "volumes" $volumes }}

{{/*
Configuração para o template
*/}}
{{- $config := dict "checksumConfig" $checksumConfig "checksumSecret" $checksumSecret "envFrom" $envFrom }}

{{- include "neural-hive.deployment" (dict "values" $modifiedValues "context" $ctx "config" $config) }}
