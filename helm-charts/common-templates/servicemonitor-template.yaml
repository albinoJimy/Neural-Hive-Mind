# Template padrão para ServiceMonitor do Neural Hive-Mind
# Para usar este template, copie e ajuste os valores conforme necessário

{{- define "neural-hive.servicemonitor" -}}
{{- $component := .component }}
{{- $layer := .layer }}
{{- $values := .values }}
{{- $context := .context }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ $context.fullname }}-metrics
  namespace: {{ $context.namespace }}
  labels:
    # Labels básicos do Helm
    {{- with $context.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    # Labels padrão Neural Hive-Mind para descoberta do Prometheus
    neural.hive/metrics: "enabled"
    neural.hive/component: {{ $component | quote }}
    neural.hive/layer: {{ $layer | quote }}
    # Label para seletor do Prometheus Operator
    release: prometheus
    {{- with $values.serviceMonitor.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    neural.hive/scrape-config: "standard"
    neural.hive/metrics-path: {{ $values.serviceMonitor.path | default "/metrics" | quote }}
    neural.hive/scrape-interval: {{ $values.serviceMonitor.interval | default "30s" | quote }}
    neural.hive/component-version: {{ $context.version | quote }}
spec:
  selector:
    matchLabels:
      {{- with $context.selectorLabels }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
      # Label específico para identificar serviços com métricas
      component: metrics

  endpoints:
  - port: {{ $values.serviceMonitor.portName | default "http" }}
    path: {{ $values.serviceMonitor.path | default "/metrics" }}
    interval: {{ $values.serviceMonitor.interval | default "30s" }}
    scrapeTimeout: {{ $values.serviceMonitor.scrapeTimeout | default "10s" }}

    # Configurações de segurança para autenticação
    {{- if $values.serviceMonitor.basicAuth }}
    basicAuth:
      username:
        name: {{ $values.serviceMonitor.basicAuth.secretName }}
        key: {{ $values.serviceMonitor.basicAuth.usernameKey }}
      password:
        name: {{ $values.serviceMonitor.basicAuth.secretName }}
        key: {{ $values.serviceMonitor.basicAuth.passwordKey }}
    {{- end }}

    {{- if $values.serviceMonitor.tlsConfig }}
    tlsConfig:
      {{- toYaml $values.serviceMonitor.tlsConfig | nindent 6 }}
    {{- end }}

    # Relabeling para adicionar metadados padrão do Neural Hive-Mind
    relabelings:
    # Metadados Kubernetes
    - sourceLabels: [__meta_kubernetes_service_name]
      targetLabel: service_name
    - sourceLabels: [__meta_kubernetes_namespace]
      targetLabel: kubernetes_namespace
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: kubernetes_pod_name
    - sourceLabels: [__meta_kubernetes_pod_container_name]
      targetLabel: kubernetes_container_name
    # Labels padrão Neural Hive-Mind
    - targetLabel: neural_hive_component
      replacement: {{ $component }}
    - targetLabel: neural_hive_layer
      replacement: {{ $layer }}
    - targetLabel: cluster
      replacement: {{ $context.cluster | default "neural-hive-main" }}
    - targetLabel: environment
      replacement: {{ $context.environment | default "production" }}
    # Labels adicionais específicos do serviço
    {{- range $key, $value := $values.serviceMonitor.additionalLabels }}
    - targetLabel: {{ $key }}
      replacement: {{ $value }}
    {{- end }}

    # Metric relabeling para padronização Neural Hive-Mind
    metricRelabelings:
    # Garantir que métricas têm o prefixo neural_hive_
    - sourceLabels: [__name__]
      regex: "neural_hive_(.+)"
      targetLabel: __name__
      replacement: "neural_hive_${1}"
    # Adicionar labels padrão a métricas Neural Hive-Mind
    - sourceLabels: [__name__]
      regex: "neural_hive_.*"
      targetLabel: neural_hive_component
      replacement: {{ $component }}
    - sourceLabels: [__name__]
      regex: "neural_hive_.*"
      targetLabel: neural_hive_layer
      replacement: {{ $layer }}
    # Preservar correlation IDs importantes
    - sourceLabels: [neural_hive_intent_id]
      targetLabel: intent_id
    - sourceLabels: [neural_hive_plan_id]
      targetLabel: plan_id
    # Adicionar informações de instância
    - targetLabel: service_name
      replacement: {{ $context.fullname }}
    - targetLabel: component_version
      replacement: {{ $context.version }}
    # Relabelings personalizados por serviço
    {{- with $values.serviceMonitor.metricRelabelings }}
    {{- toYaml . | nindent 4 }}
    {{- end }}

  # Configuração de namespace
  {{- if $values.serviceMonitor.namespaceSelector }}
  namespaceSelector:
    {{- toYaml $values.serviceMonitor.namespaceSelector | nindent 4 }}
  {{- else }}
  namespaceSelector:
    matchNames:
    - {{ $context.namespace }}
  {{- end }}

  # Configurações de limite para controle de cardinalidade
  {{- if $values.serviceMonitor.sampleLimit }}
  sampleLimit: {{ $values.serviceMonitor.sampleLimit }}
  {{- end }}

  {{- if $values.serviceMonitor.targetLimit }}
  targetLimit: {{ $values.serviceMonitor.targetLimit }}
  {{- end }}

  # Configuração de honorLabels para preservar labels do serviço
  honorLabels: {{ $values.serviceMonitor.honorLabels | default false }}

  # Configuração de honorTimestamps
  honorTimestamps: {{ $values.serviceMonitor.honorTimestamps | default true }}

{{- end -}}