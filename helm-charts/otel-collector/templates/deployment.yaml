{{- $ctx := include "neural-hive-otel-collector.context" . | fromYaml }}
{{- $checksumConfig := include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}

{{/*
Construir env vars específicas do otel-collector
*/}}
{{- $env := list }}
{{- $env = append $env (dict "name" "MY_POD_IP" "valueFrom" (dict "fieldRef" (dict "apiVersion" "v1" "fieldPath" "status.podIP"))) }}
{{- $env = append $env (dict "name" "MY_POD_NAME" "valueFrom" (dict "fieldRef" (dict "apiVersion" "v1" "fieldPath" "metadata.name"))) }}
{{- $env = append $env (dict "name" "MY_NAMESPACE" "valueFrom" (dict "fieldRef" (dict "apiVersion" "v1" "fieldPath" "metadata.namespace"))) }}
{{- $env = append $env (dict "name" "GOMEMLIMIT" "value" (.Values.resources.limits.memory | regexReplaceAll "Gi" "GiB")) }}
{{- $env = append $env (dict "name" "GOGC" "value" "80") }}

{{/*
Construir volumes e volumeMounts para config
*/}}
{{- $volumes := list }}
{{- $volumes = append $volumes (dict "name" "config" "configMap" (dict "name" (printf "%s-config" $ctx.fullname) "items" (list (dict "key" "otelcol.yaml" "path" "otelcol.yaml")))) }}
{{- if .Values.tls.enabled }}
{{- $volumes = append $volumes (dict "name" "otel-tls-certs" "secret" (dict "secretName" .Values.tls.certSecret "items" (list (dict "key" "tls.crt" "path" "tls.crt") (dict "key" "tls.key" "path" "tls.key") (dict "key" "ca.crt" "path" "ca.crt")))) }}
{{- end }}

{{- $volumeMounts := list }}
{{- $volumeMounts = append $volumeMounts (dict "name" "config" "mountPath" "/conf" "readOnly" true) }}
{{- if .Values.tls.enabled }}
{{- $volumeMounts = append $volumeMounts (dict "name" "otel-tls-certs" "mountPath" .Values.tls.mountPath "readOnly" true) }}
{{- end }}

{{/*
Construir valores modificados para o template comum
*/}}
{{- $modifiedValues := deepCopy .Values }}
{{- $_ := set $modifiedValues "volumeMounts" $volumeMounts }}
{{- $_ := set $modifiedValues "volumes" $volumes }}

{{/*
Configuração para o template
*/}}
{{- $config := dict "checksumConfig" $checksumConfig "env" $env }}

{{- include "neural-hive.deployment" (dict "values" $modifiedValues "context" $ctx "config" $config) }}
