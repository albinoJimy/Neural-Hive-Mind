apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "neural-hive-otel-collector.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neural-hive-otel-collector.labels" . | nindent 4 }}
    neural.hive/component: configuration
data:
  otelcol.yaml: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      pprof:
        endpoint: 0.0.0.0:1777
      zpages:
        endpoint: 0.0.0.0:55679
      memory_ballast:
        size_mib: {{ .Values.collector.config.extensions.memory_ballast.size_mib | default 683 }}

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
            max_recv_msg_size: 4194304
          http:
            endpoint: 0.0.0.0:4318

      # Prometheus receiver para scraping de métricas
      prometheus:
        config:
          global:
            scrape_interval: 15s
            evaluation_interval: 15s
          scrape_configs:
          - job_name: 'neural-hive-services'
            kubernetes_sd_configs:
            - role: pod
              namespaces:
                names:
                - default
                - neural-hive
                - gateway
                - {{ .Release.Namespace }}
            relabel_configs:
            # Manter apenas pods com annotation neural.hive/metrics=enabled
            - source_labels: [__meta_kubernetes_pod_annotation_neural_hive_metrics]
              action: keep
              regex: enabled
            # Usar path customizado se especificado
            - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
              action: replace
              target_label: __metrics_path__
              regex: (.+)
            # Usar porta customizada se especificada
            - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
              action: replace
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              target_label: __address__
            # Mapear labels do Kubernetes para métricas
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            # Adicionar labels específicos do Neural Hive-Mind
            - source_labels: [__meta_kubernetes_pod_label_neural_hive_component]
              target_label: neural_hive_component
            - source_labels: [__meta_kubernetes_pod_label_neural_hive_layer]
              target_label: neural_hive_layer
            - source_labels: [__meta_kubernetes_pod_label_neural_hive_domain]
              target_label: neural_hive_domain

          # Scrape específico para Gateway de Intenções
          - job_name: 'neural-hive-gateway'
            static_configs:
            - targets: ['gateway-intencoes-service:8000']
            metrics_path: '/metrics'
            scrape_interval: 10s
            static_labels:
              neural_hive_component: 'gateway'
              neural_hive_layer: 'experiencia'

          # Scrape para componentes Istio
          - job_name: 'istio-mesh'
            kubernetes_sd_configs:
            - role: endpoints
              namespaces:
                names:
                - istio-system
            relabel_configs:
            - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
              action: keep
              regex: istio-proxy;http-monitoring

      # Jaeger receiver para traces
      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_http:
            endpoint: 0.0.0.0:14268

      # Zipkin receiver (compatibilidade)
      zipkin:
        endpoint: 0.0.0.0:9411

    processors:
      # Memory limiter crítico para evitar OOM
      memory_limiter:
        check_interval: 1s
        limit_mib: {{ .Values.collector.resources.limits.memory | regexReplaceAll "Gi" "" | mul 1024 | mul 0.8 | int }}
        spike_limit_mib: {{ .Values.collector.resources.limits.memory | regexReplaceAll "Gi" "" | mul 1024 | mul 0.2 | int }}

      # Batch processor otimizado para throughput
      batch:
        send_batch_size: 1024
        timeout: 10s
        send_batch_max_size: 2048

      # Resource detection e enriquecimento
      resource:
        attributes:
        - key: deployment.environment
          value: {{ .Values.global.environment }}
          action: upsert
        - key: service.namespace
          from_attribute: k8s.namespace.name
          action: insert
        - key: neural.hive.cluster
          value: {{ .Values.global.domain | replace "." "-" }}
          action: upsert
        - key: k8s.cluster.name
          value: neural-hive-main
          action: upsert
        - key: telemetry.sdk.name
          value: opentelemetry
          action: upsert
        - key: telemetry.sdk.version
          value: {{ .Chart.AppVersion }}
          action: upsert

      # Baggage processor para extrair correlation IDs
      baggage/span:
        # Extract baggage items to span attributes
        include: ["neural.hive.intent.id", "neural.hive.plan.id", "neural.hive.domain", "neural.hive.user.id"]

      # Processor específico para correlação Neural Hive-Mind
      attributes/neural_hive:
        actions:
        # Extrair correlation IDs de headers HTTP (priority)
        - key: neural.hive.intent.id
          from_attribute: http.request.header.x-neural-hive-intent-id
          action: upsert
        - key: neural.hive.plan.id
          from_attribute: http.request.header.x-neural-hive-plan-id
          action: upsert
        - key: neural.hive.domain
          from_attribute: http.request.header.x-neural-hive-domain
          action: upsert
        - key: neural.hive.user.id
          from_attribute: http.request.header.x-neural-hive-user-id
          action: upsert
        # Extrair de baggage se não estiver em headers
        - key: neural.hive.intent.id
          from_attribute: baggage.neural.hive.intent.id
          action: insert
        - key: neural.hive.plan.id
          from_attribute: baggage.neural.hive.plan.id
          action: insert
        # Normalize empty values to avoid clutter
        - key: neural.hive.intent.id
          action: delete
          from_attribute: neural.hive.intent.id
          value: ""
        - key: neural.hive.plan.id
          action: delete
          from_attribute: neural.hive.plan.id
          value: ""

      # Processor to add trace exemplars (no high cardinality labels)
      attributes/exemplars:
        actions:
        # Add coarse-grained labels for exemplars
        - key: neural.hive.plan.class
          from_attribute: neural.hive.intent.id
          action: upsert
          # Extract plan class from intent ID pattern (e.g., intent-123 -> class-a)
        - key: neural.hive.channel
          from_attribute: http.request.header.x-neural-hive-channel
          action: upsert

      # Tail sampling otimizado para Neural Hive-Mind
      tail_sampling:
        decision_wait: 30s
        num_traces: 50000
        expected_new_traces_per_sec: 100
        policies:
        # Sempre amostrar errors
        - name: neural_hive_errors
          type: status_code
          status_code:
            status_codes: [ERROR]
        # Sempre amostrar alta latência
        - name: neural_hive_high_latency
          type: latency
          latency:
            threshold_ms: 1000
        # Alta taxa para traces com intent_id (70%)
        - name: neural_hive_intent_traces_high
          type: and
          and:
            and_sub_policies:
            - name: has_intent_id
              type: string_attribute
              string_attribute:
                key: neural.hive.intent.id
                values: [".+"]
                enabled_regex_matching: true
            - name: intent_sampling_high
              type: probabilistic
              probabilistic:
                sampling_percentage: 70
        # Alta taxa para traces com plan_id (60%)
        - name: neural_hive_plan_traces_high
          type: and
          and:
            and_sub_policies:
            - name: has_plan_id
              type: string_attribute
              string_attribute:
                key: neural.hive.plan.id
                values: [".+"]
                enabled_regex_matching: true
            - name: plan_sampling_high
              type: probabilistic
              probabilistic:
                sampling_percentage: 60
        # Operações críticas 100%
        - name: neural_hive_critical_operations
          type: string_attribute
          string_attribute:
            key: operation
            values: ["captura_intencao", "geracao_plano", "execucao_acao", "consensus", "evaluate_plan"]
            enabled_regex_matching: true
        # Gateway sampling 30%
        - name: neural_hive_gateway_sampling
          type: and
          and:
            and_sub_policies:
            - name: is_gateway
              type: string_attribute
              string_attribute:
                key: service.name
                values: ["gateway-intencoes"]
            - name: gateway_rate
              type: probabilistic
              probabilistic:
                sampling_percentage: 30
        # Health checks 1%
        - name: neural_hive_health_checks
          type: and
          and:
            and_sub_policies:
            - name: is_health_check
              type: string_attribute
              string_attribute:
                key: http.target
                values: ["/health", "/ready", "/metrics", "/healthz"]
            - name: health_rate
              type: probabilistic
              probabilistic:
                sampling_percentage: 1
        # Sampling probabilístico padrão
        - name: neural_hive_general_sampling
          type: probabilistic
          probabilistic:
            sampling_percentage: {{ if eq .Values.global.environment "production" }}5{{ else if eq .Values.global.environment "staging" }}25{{ else }}100{{ end }}

      # Filter processor para reduzir ruído
      filter/drop_metrics:
        metrics:
          exclude:
            match_type: regexp
            metric_names:
            # Permitir histogramas essenciais para SLOs, descartar apenas não-críticos
            - "go_gc_.*_bucket$"              # Histogramas GC específicos
            - "go_memstats_.*_bucket$"        # Histogramas memória Go específicos
            - "process_.*_bucket$"            # Histogramas de processo
            - "promhttp_.*_bucket$"           # Histogramas Prometheus internos
            # Manter neural_hive_.*_bucket para SLOs
            - "go_.*"                         # Outras métricas internas do Go
            - "process_.*"                    # Métricas de processo
            - "promhttp_.*"                   # Métricas Prometheus internas

    exporters:
      # Prometheus exporter para métricas
      prometheus:
        endpoint: "0.0.0.0:8888"
        const_labels:
          cluster: neural-hive-main
          environment: {{ .Values.global.environment }}
        send_timestamps: true
        metric_expiration: 180m
        enable_open_metrics: true
        resource_to_telemetry_conversion:
          enabled: true

      # Jaeger exporter para traces
      jaeger:
        endpoint: jaeger-collector.{{ .Release.Namespace }}.svc.cluster.local:14250
        tls:
          insecure: true
        sending_queue:
          enabled: true
          num_consumers: 2
          queue_size: 100
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 30s
          max_elapsed_time: 300s

      # OTLP exporter para traces (backup)
      otlp/traces:
        endpoint: jaeger-collector.{{ .Release.Namespace }}.svc.cluster.local:4317
        tls:
          insecure: true
        headers:
          X-Neural-Hive-Source: "otel-collector"
          X-Neural-Hive-Environment: {{ .Values.global.environment }}

      # Logging exporter para debugging
      {{- if ne .Values.global.environment "production" }}
      logging:
        loglevel: info
        sampling_initial: 5
        sampling_thereafter: 200
      {{- end }}

    service:
      extensions: [health_check, pprof, zpages, memory_ballast]
      pipelines:
        traces:
          receivers: [otlp, jaeger, zipkin]
          processors: [memory_limiter, resource, baggage/span, attributes/neural_hive, attributes/exemplars, tail_sampling, batch]
          exporters:
          - jaeger
          - otlp/traces
          {{- if ne .Values.global.environment "production" }}
          - logging
          {{- end }}

        metrics:
          receivers: [otlp, prometheus]
          processors: [memory_limiter, resource, attributes/neural_hive, filter/drop_metrics, batch]
          exporters: [prometheus]

        logs:
          receivers: [otlp]
          processors: [memory_limiter, resource, baggage/span, attributes/neural_hive, batch]
          exporters:
          {{- if ne .Values.global.environment "production" }}
          - logging
          {{- end }}

      telemetry:
        logs:
          level: {{ if eq .Values.global.environment "production" }}"warn"{{ else }}"info"{{ end }}
        metrics:
          level: detailed
          address: 0.0.0.0:8888
