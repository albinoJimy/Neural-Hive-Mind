image:
  repository: 37.60.241.150:30500/worker-agents
  tag: "1.0.0"
  pullPolicy: IfNotPresent

replicaCount: 3

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

resources:
  # Workers pull Temporal/Kafka tasks but idle frequently; profiling shows 250-300m CPU steady state.
  # Right-size to 400m CPU / 640Mi requests with burst cap 1.5 CPU / 1.5Gi for parallel job spikes.
  requests:
    cpu: 400m
    memory: 640Mi
  limits:
    cpu: 1500m
    memory: 1536Mi

config:
  serviceName: worker-agents
  namespace: neural-hive-execution
  cluster: production
  supportedTaskTypes:
    - BUILD
    - DEPLOY
    - TEST
    - VALIDATE
    - EXECUTE
  maxConcurrentTasks: 5

  kafka:
    bootstrapServers: kafka-bootstrap.kafka.svc.cluster.local:9092
    ticketsTopic: execution.tickets
    resultsTopic: execution.results
    consumerGroupId: worker-agents
    schemaRegistryUrl: http://schema-registry.neural-hive-kafka.svc.cluster.local:8081
    securityProtocol: PLAINTEXT
    saslMechanism: SCRAM-SHA-512
    saslUsername: ""
    saslPassword: ""
    sslCaLocation: ""
    sslCertificateLocation: ""
    sslKeyLocation: ""
    schemasBasePath: /app/schemas

  serviceRegistry:
    host: service-registry.neural-hive-registry.svc.cluster.local
    port: 50051
    heartbeatIntervalSeconds: 30

  executionTicketService:
    url: http://execution-ticket-service.neural-hive-orchestration.svc.cluster.local:8080

  temporal:
    enabled: false
    host: temporal-frontend.temporal.svc.cluster.local
    port: 7233
    namespace: neural-hive-mind
    taskQueue: worker-tasks

  observability:
    otelEndpoint: http://otel-collector:4317
    prometheusPort: 9090
    httpPort: 8080
    logLevel: INFO

  codeForge:
    url: http://code-forge.neural-hive-execution.svc.cluster.local:8000
    enabled: true
    timeoutSeconds: 14400  # 4 hours

  argocd:
    url: ""  # e.g., https://argocd.example.com
    enabled: false
    token: ""  # Será movido para Secret
    tokenSecretName: argocd-token
    tokenSecretKey: token

  opa:
    url: http://opa.neural-hive-governance.svc.cluster.local:8181
    enabled: true

  trivy:
    enabled: true
    timeoutSeconds: 300

  testExecution:
    timeoutSeconds: 600
    allowedCommands:
      - pytest
      - npm test
      - go test
      - mvn test
      - jest
      - cargo test

  vault:
    enabled: false
    address: http://vault.vault.svc.cluster.local:8200
    namespace: ""
    authMethod: kubernetes
    kubernetesRole: worker-agents
    tokenPath: /vault/secrets/token
    mountKv: secret
    mountDatabase: database
    timeoutSeconds: 5
    maxRetries: 3
    failOpen: true

  spiffe:
    enabled: false
    socketPath: unix:///run/spire/sockets/agent.sock
    trustDomain: neural-hive.local
    jwtAudience: vault.neural-hive.local
    enableX509: false
    fallbackAllowed: false

  githubActions:
    enabled: false
    apiUrl: https://api.github.com
    tokenSecretName: github-token

  validation:
    opa:
      enabled: true
      url: http://opa.neural-hive-governance.svc.cluster.local:8181
    trivy:
      enabled: true
      timeout: 300
    sonarqube:
      enabled: false
      url: https://sonarqube.example.com
      tokenSecretName: sonarqube-token
    snyk:
      enabled: false
      tokenSecretName: snyk-token
    checkov:
      enabled: false

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  readOnlyRootFilesystem: true

istio:
  enabled: true
  mtls:
    mode: STRICT

serviceMonitor:
  enabled: true
  interval: 30s

startupProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 20  # Dá 3.3min para registrar tasks no Service Registry/Temporal
  successThreshold: 1

livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

pdb:
  enabled: true
  minAvailable: 1

networkPolicy:
  enabled: true

secrets:
  kafkaSaslUsername: ""
  kafkaSaslPassword: ""
  argoCdToken: ""  # ArgoCD API token (base64 encoded in production)

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - worker-agents
          topologyKey: topology.kubernetes.io/zone

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: worker-agents
