{{- $ctx := include "worker-agents.context" . | fromYaml }}
{{- $checksumConfig := include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}

{{- $envFrom := list }}
{{- $envFrom = append $envFrom (dict "configMapRef" (dict "name" (include "worker-agents.fullname" .))) }}
{{- if or .Values.secrets.kafkaSaslUsername .Values.secrets.kafkaSaslPassword }}
{{- $envFrom = append $envFrom (dict "secretRef" (dict "name" (include "worker-agents.secretName" .))) }}
{{- end }}

{{- $env := list }}
{{- $env = append $env (dict "name" "POD_NAME" "valueFrom" (dict "fieldRef" (dict "fieldPath" "metadata.name"))) }}
{{- $env = append $env (dict "name" "POD_NAMESPACE" "valueFrom" (dict "fieldRef" (dict "fieldPath" "metadata.namespace"))) }}
{{- $env = append $env (dict "name" "NODE_NAME" "valueFrom" (dict "fieldRef" (dict "fieldPath" "spec.nodeName"))) }}

{{- $volumes := list }}
{{- $volumes = append $volumes (dict "name" "tmp" "emptyDir" (dict)) }}
{{- if .Values.config.spiffe.enabled }}
{{- $volumes = append $volumes (dict "name" "spire-agent-socket" "hostPath" (dict "path" "/run/spire/sockets" "type" "Directory")) }}
{{- end }}

{{- $volumeMounts := list }}
{{- $volumeMounts = append $volumeMounts (dict "name" "tmp" "mountPath" "/tmp") }}
{{- if .Values.config.spiffe.enabled }}
{{- $volumeMounts = append $volumeMounts (dict "name" "spire-agent-socket" "mountPath" "/run/spire/sockets" "readOnly" true) }}
{{- end }}

{{- $modifiedValues := deepCopy .Values }}
{{- $_ := set $modifiedValues "volumeMounts" $volumeMounts }}
{{- $_ := set $modifiedValues "volumes" $volumes }}

{{- $podAnnotations := dict }}
{{- if .Values.config.vault.enabled }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject" "true" }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/role" .Values.config.vault.kubernetesRole }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-secret-kafka" (printf "%s/data/worker/kafka" .Values.config.vault.mountKv) }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-template-kafka" (printf "{{`{{- with secret`}} \"%s/data/worker/kafka\" {{`-}}\nexport KAFKA_SASL_USERNAME=\"{{ .Data.data.username }}\"\nexport KAFKA_SASL_PASSWORD=\"{{ .Data.data.password }}\"\n{{- end }}`}}" .Values.config.vault.mountKv) }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-secret-execution" (printf "%s/data/worker/execution" .Values.config.vault.mountKv) }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-template-execution" (printf "{{`{{- with secret`}} \"%s/data/worker/execution\" {{`-}}\nexport EXECUTION_CREDENTIALS=\"{{ .Data.data | toJSON }}\"\n{{- end }}`}}" .Values.config.vault.mountKv) }}
{{- end }}
{{- $_ := set $modifiedValues "podAnnotations" $podAnnotations }}

{{- $config := dict "checksumConfig" $checksumConfig "envFrom" $envFrom "env" $env }}

{{- include "neural-hive.deployment" (dict "values" $modifiedValues "context" $ctx "config" $config) }}
