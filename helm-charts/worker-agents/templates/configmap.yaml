apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "worker-agents.fullname" . }}
  labels:
    {{- include "worker-agents.labels" . | nindent 4 }}
data:
  SERVICE_NAME: {{ .Values.config.serviceName | quote }}
  NAMESPACE: {{ .Values.config.namespace | quote }}
  CLUSTER: {{ .Values.config.cluster | quote }}
  SUPPORTED_TASK_TYPES: '{{ .Values.config.supportedTaskTypes | toJson }}'
  MAX_CONCURRENT_TASKS: {{ .Values.config.maxConcurrentTasks | quote }}

  # Backpressure Control
  MAX_CONCURRENT_TICKETS: {{ .Values.config.maxConcurrentTickets | quote }}
  CONSUMER_PAUSE_THRESHOLD: {{ .Values.config.consumerPauseThreshold | quote }}
  CONSUMER_RESUME_THRESHOLD: {{ .Values.config.consumerResumeThreshold | quote }}

  KAFKA_BOOTSTRAP_SERVERS: {{ .Values.config.kafka.bootstrapServers | quote }}
  KAFKA_TICKETS_TOPIC: {{ .Values.config.kafka.ticketsTopic | quote }}
  KAFKA_RESULTS_TOPIC: {{ .Values.config.kafka.resultsTopic | quote }}
  KAFKA_CONSUMER_GROUP_ID: {{ .Values.config.kafka.consumerGroupId | quote }}
  KAFKA_SECURITY_PROTOCOL: {{ .Values.config.kafka.securityProtocol | quote }}
  KAFKA_SASL_MECHANISM: {{ .Values.config.kafka.saslMechanism | quote }}
  KAFKA_SASL_USERNAME: {{ .Values.config.kafka.saslUsername | quote }}
  KAFKA_SASL_PASSWORD: {{ .Values.config.kafka.saslPassword | quote }}
  KAFKA_SSL_CA_LOCATION: {{ .Values.config.kafka.sslCaLocation | quote }}
  KAFKA_SSL_CERTIFICATE_LOCATION: {{ .Values.config.kafka.sslCertificateLocation | quote }}
  KAFKA_SSL_KEY_LOCATION: {{ .Values.config.kafka.sslKeyLocation | quote }}
  KAFKA_SCHEMA_REGISTRY_URL: {{ .Values.config.kafka.schemaRegistryUrl | quote }}
  SCHEMAS_BASE_PATH: {{ .Values.config.kafka.schemasBasePath | quote }}

  # Dead Letter Queue (DLQ)
  {{- if .Values.config.kafka.dlq }}
  KAFKA_DLQ_ENABLED: {{ .Values.config.kafka.dlq.enabled | quote }}
  KAFKA_DLQ_TOPIC: {{ .Values.config.kafka.dlq.topic | quote }}
  KAFKA_MAX_RETRIES_BEFORE_DLQ: {{ .Values.config.kafka.dlq.maxRetriesBeforeDLQ | quote }}
  {{- end }}

  SERVICE_REGISTRY_HOST: {{ .Values.config.serviceRegistry.host | quote }}
  SERVICE_REGISTRY_PORT: {{ .Values.config.serviceRegistry.port | quote }}
  HEARTBEAT_INTERVAL_SECONDS: {{ .Values.config.serviceRegistry.heartbeatIntervalSeconds | quote }}

  EXECUTION_TICKET_SERVICE_URL: {{ .Values.config.executionTicketService.url | quote }}

  ENABLE_TEMPORAL_ACTIVITIES: {{ .Values.config.temporal.enabled | quote }}
  {{- if .Values.config.temporal.enabled }}
  TEMPORAL_HOST: {{ .Values.config.temporal.host | quote }}
  TEMPORAL_PORT: {{ .Values.config.temporal.port | quote }}
  TEMPORAL_NAMESPACE: {{ .Values.config.temporal.namespace | quote }}
  TEMPORAL_TASK_QUEUE: {{ .Values.config.temporal.taskQueue | quote }}
  {{- end }}

  OTEL_EXPORTER_OTLP_ENDPOINT: {{ .Values.config.observability.otelEndpoint | quote }}
  PROMETHEUS_PORT: {{ .Values.config.observability.prometheusPort | quote }}
  HTTP_PORT: {{ .Values.config.observability.httpPort | quote }}
  LOG_LEVEL: {{ .Values.config.observability.logLevel | quote }}

  # Code Forge Configuration
  CODE_FORGE_URL: {{ .Values.config.codeForge.url | quote }}
  CODE_FORGE_ENABLED: {{ .Values.config.codeForge.enabled | quote }}
  CODE_FORGE_TIMEOUT_SECONDS: {{ .Values.config.codeForge.timeoutSeconds | quote }}

  # ArgoCD Configuration
  {{- if .Values.config.argocd.url }}
  ARGOCD_URL: {{ .Values.config.argocd.url | quote }}
  {{- end }}
  ARGOCD_ENABLED: {{ .Values.config.argocd.enabled | quote }}
  {{- if .Values.config.argocd.timeoutSeconds }}
  ARGOCD_TIMEOUT_SECONDS: {{ .Values.config.argocd.timeoutSeconds | quote }}
  {{- end }}

  # Flux CD Configuration
  FLUX_ENABLED: {{ .Values.config.flux.enabled | quote }}
  FLUX_NAMESPACE: {{ .Values.config.flux.namespace | quote }}
  {{- if .Values.config.flux.kubeconfigPath }}
  FLUX_KUBECONFIG_PATH: {{ .Values.config.flux.kubeconfigPath | quote }}
  {{- end }}
  FLUX_TIMEOUT_SECONDS: {{ .Values.config.flux.timeoutSeconds | quote }}

  # OPA Configuration
  OPA_URL: {{ .Values.config.opa.url | quote }}
  OPA_ENABLED: {{ .Values.config.opa.enabled | quote }}
  OPA_TIMEOUT_SECONDS: {{ .Values.config.opa.timeoutSeconds | quote }}
  OPA_VERIFY_SSL: {{ .Values.config.opa.verifySsl | quote }}
  OPA_RETRY_ATTEMPTS: {{ .Values.config.opa.retryAttempts | quote }}
  OPA_RETRY_BACKOFF_BASE_SECONDS: {{ .Values.config.opa.retryBackoffBaseSeconds | quote }}
  OPA_RETRY_BACKOFF_MAX_SECONDS: {{ .Values.config.opa.retryBackoffMaxSeconds | quote }}
  OPA_POLL_INTERVAL_SECONDS: {{ .Values.config.opa.pollIntervalSeconds | quote }}
  OPA_POLL_TIMEOUT_SECONDS: {{ .Values.config.opa.pollTimeoutSeconds | quote }}

  # Trivy Configuration
  TRIVY_ENABLED: {{ .Values.config.trivy.enabled | quote }}
  TRIVY_TIMEOUT_SECONDS: {{ .Values.config.trivy.timeoutSeconds | quote }}

  # Test Execution Configuration
  TEST_EXECUTION_TIMEOUT_SECONDS: {{ .Values.config.testExecution.timeoutSeconds | quote }}
  ALLOWED_TEST_COMMANDS: '{{ .Values.config.testExecution.allowedCommands | toJson }}'

  # GitHub Actions
  GITHUB_ACTIONS_ENABLED: {{ .Values.config.githubActions.enabled | quote }}
  GITHUB_API_URL: {{ .Values.config.githubActions.apiUrl | quote }}

  # Validation tools
  SONARQUBE_ENABLED: {{ .Values.config.validation.sonarqube.enabled | quote }}
  SONARQUBE_URL: {{ .Values.config.validation.sonarqube.url | quote }}
  SNYK_ENABLED: {{ .Values.config.validation.snyk.enabled | quote }}
  CHECKOV_ENABLED: {{ .Values.config.validation.checkov.enabled | quote }}

  # Docker Runtime
  {{- if .Values.config.runtimes }}
  DOCKER_ENABLED: {{ .Values.config.runtimes.docker.enabled | quote }}
  DOCKER_BASE_URL: {{ .Values.config.runtimes.docker.baseUrl | quote }}
  DOCKER_TIMEOUT_SECONDS: {{ .Values.config.runtimes.docker.timeoutSeconds | quote }}
  DOCKER_VERIFY_SSL: {{ .Values.config.runtimes.docker.verifySsl | quote }}
  DOCKER_DEFAULT_CPU_LIMIT: {{ .Values.config.runtimes.docker.defaultCpuLimit | quote }}
  DOCKER_DEFAULT_MEMORY_LIMIT: {{ .Values.config.runtimes.docker.defaultMemoryLimit | quote }}
  DOCKER_NETWORK_MODE: {{ .Values.config.runtimes.docker.networkMode | quote }}
  DOCKER_CLEANUP_CONTAINERS: {{ .Values.config.runtimes.docker.cleanupContainers | quote }}

  # Kubernetes Jobs Runtime
  K8S_JOBS_ENABLED: {{ .Values.config.runtimes.k8s.enabled | quote }}
  K8S_JOBS_NAMESPACE: {{ .Values.config.runtimes.k8s.namespace | quote }}
  {{- if .Values.config.runtimes.k8s.kubeconfigPath }}
  K8S_JOBS_KUBECONFIG_PATH: {{ .Values.config.runtimes.k8s.kubeconfigPath | quote }}
  {{- end }}
  K8S_JOBS_TIMEOUT_SECONDS: {{ .Values.config.runtimes.k8s.timeoutSeconds | quote }}
  K8S_JOBS_POLL_INTERVAL_SECONDS: {{ .Values.config.runtimes.k8s.pollIntervalSeconds | quote }}
  K8S_JOBS_CLEANUP: {{ .Values.config.runtimes.k8s.cleanup | quote }}
  K8S_JOBS_SERVICE_ACCOUNT: {{ .Values.config.runtimes.k8s.serviceAccount | quote }}
  K8S_JOBS_DEFAULT_CPU_REQUEST: {{ .Values.config.runtimes.k8s.defaultCpuRequest | quote }}
  K8S_JOBS_DEFAULT_CPU_LIMIT: {{ .Values.config.runtimes.k8s.defaultCpuLimit | quote }}
  K8S_JOBS_DEFAULT_MEMORY_REQUEST: {{ .Values.config.runtimes.k8s.defaultMemoryRequest | quote }}
  K8S_JOBS_DEFAULT_MEMORY_LIMIT: {{ .Values.config.runtimes.k8s.defaultMemoryLimit | quote }}
  K8S_JOBS_BACKOFF_LIMIT: {{ .Values.config.runtimes.k8s.backoffLimit | quote }}

  # AWS Lambda Runtime
  LAMBDA_ENABLED: {{ .Values.config.runtimes.lambda.enabled | quote }}
  LAMBDA_REGION: {{ .Values.config.runtimes.lambda.region | quote }}
  LAMBDA_FUNCTION_NAME: {{ .Values.config.runtimes.lambda.functionName | quote }}
  LAMBDA_TIMEOUT_SECONDS: {{ .Values.config.runtimes.lambda.timeoutSeconds | quote }}

  # Local Runtime
  LOCAL_RUNTIME_ENABLED: {{ .Values.config.runtimes.local.enabled | quote }}
  LOCAL_RUNTIME_TIMEOUT_SECONDS: {{ .Values.config.runtimes.local.timeoutSeconds | quote }}
  LOCAL_RUNTIME_ENABLE_SANDBOX: {{ .Values.config.runtimes.local.enableSandbox | quote }}
  LOCAL_RUNTIME_ALLOWED_COMMANDS: '{{ .Values.config.runtimes.local.allowedCommands | toJson }}'
  LOCAL_RUNTIME_WORKING_DIR: {{ .Values.config.runtimes.local.workingDir | quote }}

  # Runtime Selection
  DEFAULT_RUNTIME: {{ .Values.config.runtimes.defaultRuntime | quote }}
  RUNTIME_FALLBACK_CHAIN: '{{ .Values.config.runtimes.fallbackChain | toJson }}'
  {{- end }}

  # SPIFFE/SPIRE Configuration
  {{- if .Values.config.spiffe.enabled }}
  SPIFFE_ENABLED: {{ .Values.config.spiffe.enabled | quote }}
  SPIFFE_SOCKET_PATH: {{ .Values.config.spiffe.socketPath | quote }}
  SPIFFE_TRUST_DOMAIN: {{ .Values.config.spiffe.trustDomain | quote }}
  SPIFFE_JWT_AUDIENCE: {{ .Values.config.spiffe.jwtAudience | quote }}
  SPIFFE_JWT_TTL_SECONDS: {{ .Values.config.spiffe.jwtTtlSeconds | quote }}
  SPIFFE_ENABLE_X509: {{ .Values.config.spiffe.enableX509 | quote }}
  SPIFFE_FALLBACK_ALLOWED: {{ .Values.config.spiffe.fallbackAllowed | quote }}
  {{- end }}

  # Scheduler Preemption (aceitar chamadas de preempção do orchestrator)
  SCHEDULER_ENABLE_PREEMPTION: {{ .Values.config.scheduler.enablePreemption | default false | quote }}
