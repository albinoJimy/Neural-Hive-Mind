apiVersion: v1
kind: ConfigMap
metadata:
  name: spire-server-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "spire.labels" . | nindent 4 }}
data:
  server.conf: |
    server {
      bind_address = "0.0.0.0"
      bind_port = "8081"
      trust_domain = "{{ .Values.global.trustDomain }}"
      data_dir = "{{ .Values.server.config.dataDir }}"
      log_level = "{{ .Values.server.config.logLevel }}"
    }

    plugins {
      DataStore "sql" {
        plugin_data {
          database_type = "{{ .Values.server.datastore.sql.databaseType }}"
          {{- if .Values.server.datastore.sql.connectionStringSecret.enabled }}
          connection_string = "$SPIRE_DB_CONNECTION_STRING"
          {{- else }}
          connection_string = "{{ .Values.server.datastore.sql.connectionString }}"
          {{- end }}
        }
      }

      NodeAttestor "k8s_psat" {
        plugin_data {
          clusters = {
            "{{ .Values.server.nodeAttestor.k8sPsat.cluster }}" = {
              service_account_allow_list = {{ .Values.server.nodeAttestor.k8sPsat.serviceAccountAllowList | toJson }}
            }
          }
        }
      }

      {{- if eq .Values.server.config.keyManager.type "disk" }}
      KeyManager "disk" {
        plugin_data {
          keys_path = "/run/spire/data/keys"
        }
      }
      {{- else if eq .Values.server.config.keyManager.type "aws_kms" }}
      KeyManager "aws_kms" {
        plugin_data {
          {{/* Add AWS KMS specific configuration here */}}
        }
      }
      {{- else }}
      KeyManager "memory" {
        plugin_data {}
      }
      {{- end }}

      Notifier "k8sbundle" {
        plugin_data {
          namespace = "{{ .Release.Namespace }}"
          config_map = "spire-bundle"
        }
      }

      {{- if .Values.server.config.upstreamAuthority.vault.enabled }}
      UpstreamAuthority "vault" {
        plugin_data {
          vault_addr = "{{ .Values.server.config.upstreamAuthority.vault.vaultAddr }}"
          pki_mount_point = "{{ .Values.server.config.upstreamAuthority.vault.pkiMountPoint }}"
          ca_cert_path = "{{ .Values.server.config.upstreamAuthority.vault.caCertPath }}"
        }
      }
      {{- end }}
    }

    health_checks {
      listener_enabled = true
      bind_address = "0.0.0.0"
      bind_port = "8080"
      live_path = "/live"
      ready_path = "/ready"
    }
