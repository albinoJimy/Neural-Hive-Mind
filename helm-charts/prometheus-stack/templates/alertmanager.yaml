{{- if .Values.alertmanager.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  name: {{ include "neural-hive-prometheus-stack.fullname" . }}-alertmanager
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neural-hive-prometheus-stack.labels" . | nindent 4 }}
    neural.hive/component: alertmanager
    neural.hive/layer: observabilidade
spec:
  replicas: {{ .Values.alertmanager.alertmanagerSpec.replicas }}

  # Service Account
  serviceAccountName: {{ include "neural-hive-prometheus-stack.fullname" . }}-alertmanager

  # Image
  image:
    repository: quay.io/prometheus/alertmanager
    tag: v0.26.0

  # Resources
  resources:
    {{- toYaml .Values.alertmanager.alertmanagerSpec.resources | nindent 4 }}

  # Storage
  storage:
    volumeClaimTemplate:
      metadata:
        name: alertmanager-storage
      spec:
        storageClassName: {{ .Values.alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.storageClassName }}
        accessModes:
        {{- range .Values.alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.accessModes }}
        - {{ . }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.resources.requests.storage }}

  # Security Context
  securityContext:
    runAsUser: 1000
    runAsGroup: 2000
    runAsNonRoot: true
    fsGroup: 2000

  # Configuration
  configMaps:
  - {{ include "neural-hive-prometheus-stack.fullname" . }}-alertmanager-config

  # External URL
  externalUrl: https://alertmanager.{{ .Values.global.domain }}

  # Route Prefix
  routePrefix: /

  # Log Level and Format
  logLevel: info
  logFormat: logfmt

  # Retention
  retention: 120h

  # Cluster configuration for HA
  {{- if gt (int .Values.alertmanager.alertmanagerSpec.replicas) 1 }}
  listenLocal: false
  {{- end }}

  # Port Name
  portName: web

  # Affinity for HA
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - alertmanager
        topologyKey: kubernetes.io/hostname

---
# ConfigMap with AlertManager configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "neural-hive-prometheus-stack.fullname" . }}-alertmanager-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neural-hive-prometheus-stack.labels" . | nindent 4 }}
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'localhost:587'
      smtp_from: 'alertmanager@{{ .Values.global.domain }}'
      smtp_auth_username: ''
      smtp_auth_password: ''
      smtp_require_tls: false
      slack_api_url: 'https://hooks.slack.com/services/PLACEHOLDER'

    # Templates para customiza√ß√£o de mensagens
    templates:
    - '/etc/alertmanager/templates/*.tmpl'

    route:
      group_by: ['neural_hive_component', 'neural_hive_layer', 'alertname', 'cluster']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'neural-hive-default'
      routes:

      # Alertas cr√≠ticos - notifica√ß√£o imediata
      - match:
          severity: critical
        receiver: 'neural-hive-critical'
        group_wait: 0s
        repeat_interval: 5m
        continue: true

      # Alertas de SLO - equipe SRE
      - match_re:
          slo: ".*"
        receiver: 'neural-hive-slo'
        group_wait: 30s
        repeat_interval: 30m
        continue: true

      # Alertas por camada arquitetural
      - match:
          neural_hive_layer: experiencia
        receiver: 'neural-hive-experiencia'
        group_wait: 15s

      - match:
          neural_hive_layer: cognicao
        receiver: 'neural-hive-cognicao'
        group_wait: 15s

      - match:
          neural_hive_layer: orquestracao
        receiver: 'neural-hive-orquestracao'
        group_wait: 15s

      - match:
          neural_hive_layer: execucao
        receiver: 'neural-hive-execucao'
        group_wait: 15s

      - match:
          neural_hive_layer: resiliencia
        receiver: 'neural-hive-resiliencia'
        group_wait: 15s

      - match:
          neural_hive_layer: observabilidade
        receiver: 'neural-hive-observabilidade'
        group_wait: 15s

      # Alertas de seguran√ßa
      - match_re:
          alertname: ".*Security.*|.*Auth.*|.*Certificate.*"
        receiver: 'neural-hive-security'
        group_wait: 0s
        repeat_interval: 15m

    receivers:
    # Default receiver
    - name: 'neural-hive-default'
      slack_configs:
      - channel: '#neural-hive-alerts'
        title: 'Neural Hive-Mind: {{ "{{ .GroupLabels.alertname }}" }}'
        text: |
          *Ambiente:* {{ "{{ .CommonLabels.environment | default \"unknown\" }}" }}
          *Cluster:* {{ "{{ .CommonLabels.cluster | default \"unknown\" }}" }}
          {{ "{{ range .Alerts }}" }}
          *Alerta:* {{ "{{ .Annotations.summary }}" }}
          *Descri√ß√£o:* {{ "{{ .Annotations.description }}" }}
          *Severidade:* {{ "{{ .Labels.severity | default \"unknown\" }}" }}
          *Componente:* {{ "{{ .Labels.neural_hive_component | default \"unknown\" }}" }}
          *Camada:* {{ "{{ .Labels.neural_hive_layer | default \"unknown\" }}" }}
          {{ "{{ if .Annotations.runbook_url }}" }}*Runbook:* {{ "{{ .Annotations.runbook_url }}" }}{{ "{{ end }}" }}
          {{ "{{ end }}" }}
        actions:
        - type: button
          text: 'Ver no Grafana'
          url: 'https://grafana.{{ .Values.global.domain }}/d/neural-hive-overview/neural-hive-overview'

    # Critical alerts - PagerDuty + Slack
    - name: 'neural-hive-critical'
      slack_configs:
      - channel: '#neural-hive-critical'
        color: 'danger'
        title: 'üö® CR√çTICO - Neural Hive-Mind'
        text: |
          *‚ö†Ô∏è ALERTA CR√çTICO DETECTADO ‚ö†Ô∏è*

          *Alerta:* {{ "{{ .GroupLabels.alertname }}" }}
          *Ambiente:* {{ "{{ .CommonLabels.environment }}" }}
          *Componente:* {{ "{{ .GroupLabels.neural_hive_component }}" }}
          *Camada:* {{ "{{ .GroupLabels.neural_hive_layer }}" }}

          {{ "{{ range .Alerts }}" }}
          *Descri√ß√£o:* {{ "{{ .Annotations.description }}" }}
          *Valor Atual:* {{ "{{ .Annotations.current_value | default \"N/A\" }}" }}
          *Threshold:* {{ "{{ .Annotations.threshold | default \"N/A\" }}" }}
          {{ "{{ if .Annotations.runbook_url }}" }}*Runbook:* {{ "{{ .Annotations.runbook_url }}" }}{{ "{{ end }}" }}

          *Labels:*
          {{ "{{ range .Labels.SortedPairs }}" }}‚Ä¢ {{ "{{ .Name }}" }}: {{ "{{ .Value }}" }}
          {{ "{{ end }}" }}
          {{ "{{ end }}" }}
        actions:
        - type: button
          text: 'üìä Ver Grafana'
          url: 'https://grafana.{{ .Values.global.domain }}'
        - type: button
          text: 'üìñ Ver Runbook'
          url: '{{ "{{ .CommonAnnotations.runbook_url }}" }}'
        - type: button
          text: 'üîç Ver Prometheus'
          url: 'https://prometheus.{{ .Values.global.domain }}'

    # SLO violations - SRE team
    - name: 'neural-hive-slo'
      slack_configs:
      - channel: '#neural-hive-slo'
        color: 'warning'
        title: 'üìä Viola√ß√£o de SLO - Neural Hive-Mind'
        text: |
          *SLO Violado:* {{ "{{ .GroupLabels.slo }}" }}
          *Ambiente:* {{ "{{ .CommonLabels.environment }}" }}

          {{ "{{ range .Alerts }}" }}
          *M√©trica:* {{ "{{ .Annotations.summary }}" }}
          *Valor Atual:* {{ "{{ .Annotations.current_value }}" }}
          *SLO Target:* {{ "{{ .Annotations.slo_target }}" }}
          *Error Budget Burn Rate:* {{ "{{ .Annotations.burn_rate | default \"N/A\" }}" }}
          *Error Budget Restante:* {{ "{{ .Annotations.error_budget_remaining | default \"N/A\" }}" }}

          *Impact Assessment:*
          ‚Ä¢ Componente: {{ "{{ .Labels.neural_hive_component }}" }}
          ‚Ä¢ Camada: {{ "{{ .Labels.neural_hive_layer }}" }}
          {{ "{{ if .Labels.neural_hive_domain }}" }}‚Ä¢ Dom√≠nio: {{ "{{ .Labels.neural_hive_domain }}" }}{{ "{{ end }}" }}
          {{ "{{ end }}" }}
        actions:
        - type: button
          text: 'üìä SLO Dashboard'
          url: 'https://grafana.{{ .Values.global.domain }}/d/slos-eb/slos-error-budgets'

    # Receivers por camada arquitetural
    - name: 'neural-hive-experiencia'
      slack_configs:
      - channel: '#neural-hive-experiencia'
        title: 'üéØ Camada Experi√™ncia'
        text: |
          *Componente:* {{ "{{ .GroupLabels.neural_hive_component | default \"unknown\" }}" }}
          {{ "{{ range .Alerts }}" }}*Alerta:* {{ "{{ .Annotations.summary }}" }}{{ "{{ end }}" }}

    - name: 'neural-hive-cognicao'
      slack_configs:
      - channel: '#neural-hive-cognicao'
        title: 'üß† Camada Cogni√ß√£o'
        text: |
          *Componente:* {{ "{{ .GroupLabels.neural_hive_component | default \"unknown\" }}" }}
          {{ "{{ range .Alerts }}" }}*Alerta:* {{ "{{ .Annotations.summary }}" }}{{ "{{ end }}" }}

    - name: 'neural-hive-orquestracao'
      slack_configs:
      - channel: '#neural-hive-orquestracao'
        title: 'üéº Camada Orquestra√ß√£o'
        text: |
          *Componente:* {{ "{{ .GroupLabels.neural_hive_component | default \"unknown\" }}" }}
          {{ "{{ range .Alerts }}" }}*Alerta:* {{ "{{ .Annotations.summary }}" }}{{ "{{ end }}" }}

    - name: 'neural-hive-execucao'
      slack_configs:
      - channel: '#neural-hive-execucao'
        title: '‚ö° Camada Execu√ß√£o'
        text: |
          *Componente:* {{ "{{ .GroupLabels.neural_hive_component | default \"unknown\" }}" }}
          {{ "{{ range .Alerts }}" }}*Alerta:* {{ "{{ .Annotations.summary }}" }}{{ "{{ end }}" }}

    - name: 'neural-hive-resiliencia'
      slack_configs:
      - channel: '#neural-hive-resiliencia'
        title: 'üõ°Ô∏è Camada Resili√™ncia'
        text: |
          *Componente:* {{ "{{ .GroupLabels.neural_hive_component | default \"unknown\" }}" }}
          {{ "{{ range .Alerts }}" }}*Alerta:* {{ "{{ .Annotations.summary }}" }}{{ "{{ end }}" }}

    - name: 'neural-hive-observabilidade'
      slack_configs:
      - channel: '#neural-hive-observabilidade'
        title: 'üëÅÔ∏è Camada Observabilidade'
        text: |
          *Componente:* {{ "{{ .GroupLabels.neural_hive_component | default \"unknown\" }}" }}
          {{ "{{ range .Alerts }}" }}*Alerta:* {{ "{{ .Annotations.summary }}" }}{{ "{{ end }}" }}

    - name: 'neural-hive-security'
      slack_configs:
      - channel: '#neural-hive-security'
        color: 'danger'
        title: 'üîê Alerta de Seguran√ßa'
        text: |
          *‚ö†Ô∏è ALERTA DE SEGURAN√áA DETECTADO ‚ö†Ô∏è*

          {{ "{{ range .Alerts }}" }}
          *Alerta:* {{ "{{ .Annotations.summary }}" }}
          *Descri√ß√£o:* {{ "{{ .Annotations.description }}" }}
          *Severidade:* {{ "{{ .Labels.severity }}" }}
          {{ "{{ if .Annotations.remediation }}" }}*Remedia√ß√£o:* {{ "{{ .Annotations.remediation }}" }}{{ "{{ end }}" }}
          {{ "{{ end }}" }}

    # Inhibit rules - evitar spam de alertas
    inhibit_rules:
    # Cr√≠tico inibe warning para o mesmo componente
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['neural_hive_component', 'alertname', 'instance']

    # Node down inibe todos os alertas do node
    - source_match:
        alertname: 'KubernetesNodeNotReady'
      target_match_re:
        alertname: '.*'
      equal: ['instance']

    # SLO violation inibe m√©tricas individuais
    - source_match_re:
        slo: '.*'
      target_match_re:
        alertname: 'Neural.*High.*|Neural.*Low.*'
      equal: ['neural_hive_component']

{{- end }}
