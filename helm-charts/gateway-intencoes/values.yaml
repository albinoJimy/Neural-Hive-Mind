# Configurações do Gateway de Intenções
image:
  repository: neural-hive-mind/gateway-intencoes
  pullPolicy: IfNotPresent
  tag: "1.0.0"

replicaCount: 3

nameOverride: ""
fullnameOverride: ""

# Configurações do serviço
service:
  type: ClusterIP
  port: 80
  targetPort: 8000
  annotations:
    neural-hive-mind.org/component: "gateway-intencoes"

# Configurações de ingress
ingress:
  enabled: false
  className: "istio"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: gateway-intencoes.neural-hive-mind.org
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: gateway-intencoes-tls
      hosts:
        - gateway-intencoes.neural-hive-mind.org

# Resources
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 1000m
    memory: 2Gi

# Autoscaling
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Node selection
nodeSelector:
  neural-hive-mind.org/workload-type: "compute-intensive"

tolerations:
  - key: "neural-hive-mind.org/gpu"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values: [gateway-intencoes]
        topologyKey: kubernetes.io/hostname

# Security context
podSecurityContext:
  fsGroup: 1001
  runAsGroup: 1001
  runAsUser: 1001
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop: [ALL]
  readOnlyRootFilesystem: false  # Necessário para modelos ML
  runAsNonRoot: true

# Health checks
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Configurações da aplicação
config:
  environment: "prod"
  logLevel: "INFO"
  debug: false

  # Kafka
  kafka:
    bootstrapServers: "neural-hive-kafka-bootstrap.neural-hive-kafka.svc.cluster.local:9092"
    schemaRegistryUrl: "http://schema-registry.neural-hive-kafka.svc.cluster.local:8081"
    # TLS/SSL configuration
    tls:
      enabled: false
      caVerifyMode: "none"  # none, optional, required
      protocol: "TLSv1_2"
    # SASL configuration
    sasl:
      enabled: false
      mechanism: "SCRAM-SHA-512"  # PLAIN, SCRAM-SHA-256, SCRAM-SHA-512, GSSAPI, OAUTHBEARER
      # OAuth2 for SASL_OAUTHBEARER
      oauth2:
        enabled: false
        tokenEndpoint: ""
        scope: ""
    # Performance configuration
    performance:
      batchSize: 16384     # bytes
      lingerMs: 10         # milliseconds
      compressionType: "snappy"  # none, gzip, snappy, lz4, zstd

  # Redis Cache
  redis:
    clusterNodes: "neural-hive-cache.redis-cluster.svc.cluster.local:6379"
    defaultTtl: 600
    maxConnections: 100
    poolSize: 10
    timeout: 5000
    retryOnTimeout: true
    connectionPoolMaxConnections: 100
    # TLS/SSL configuration
    ssl:
      enabled: false
      certReqs: "none"  # none, optional, required
      caCerts: "/etc/ssl/certs/redis-ca.crt"
      certFile: ""  # Client certificate path
      keyFile: ""   # Client key path

  # OAuth2/Keycloak
  keycloak:
    url: "https://keycloak.neural-hive.local"
    realm: "neural-hive"
    clientId: "gateway-intencoes"
    jwksUri: "https://keycloak.neural-hive.local/auth/realms/neural-hive/protocol/openid-connect/certs"
    tokenValidationEnabled: true

  # ASR Pipeline
  asr:
    modelName: "base"
    device: "cpu"

  # NLU Pipeline
  nlu:
    languageModel: "pt_core_news_sm"
    # IMPORTANTE: confidenceThreshold é usado APENAS para análise interna do NLU,
    # NÃO para decisões de roteamento. Para controlar o roteamento de intents,
    # ajuste routingThresholdHigh e routingThresholdLow abaixo.
    # Valor mantido em 0.6 para compatibilidade com análises internas do pipeline.
    confidenceThreshold: 0.6  # Base threshold para análise NLU (não usado para roteamento)
    confidenceThresholdStrict: 0.75
    adaptiveThresholdEnabled: true
    rulesConfigPath: "/app/config/nlu_rules.yaml"

    # Routing Thresholds - controla decisões de roteamento de intents
    # Matriz de Decisão de Roteamento:
    # - confidence >= routingThresholdHigh (0.5): status="processed" → intentions.captured
    # - routingThresholdLow <= confidence < routingThresholdHigh: status="processed_low_confidence" → intentions.captured (com flag)
    # - confidence < routingThresholdLow (0.3): status="routed_to_validation" → intentions.validation
    #
    # Para reduzir roteamento para validação manual:
    # - Reduzir routingThresholdLow (ex: 0.2) permite mais intents serem processadas
    # - Reduzir routingThresholdHigh (ex: 0.4) aumenta volume de "low confidence" mas ainda processa
    #
    # Recomendações por ambiente:
    # - Dev: routingThresholdHigh=0.4, routingThresholdLow=0.2 (mais permissivo para testes)
    # - Staging: routingThresholdHigh=0.5, routingThresholdLow=0.3 (balanceado)
    # - Prod: routingThresholdHigh=0.6, routingThresholdLow=0.35 (mais conservador)
    routingThresholdHigh: 0.5  # >= 0.5: processamento normal
    routingThresholdLow: 0.3   # 0.3-0.5: processamento com baixa confiança
                                # < 0.3: roteamento para validação manual
    routingUseAdaptiveForDecisions: false  # Se true, usa adaptive threshold para roteamento

  # Limites
  limits:
    maxAudioSizeMb: 10
    maxTextLength: 10000

  # CORS
  cors:
    allowedOrigins: ["*"]
    allowedHosts: ["*"]

# Secrets
secrets:
  jwtSecretKey: "change-in-production"

  # Kafka secrets
  kafka:
    username: ""
    password: ""
    # OAuth2 for SASL_OAUTHBEARER
    oauth2:
      clientId: ""
      clientSecret: ""
      tokenEndpoint: ""
    # mTLS certificates
    tls:
      clientCert: ""  # Base64 encoded client certificate
      clientKey: ""   # Base64 encoded client private key
      caCert: ""      # Base64 encoded CA certificate

  # Redis secrets
  redis:
    password: "change-in-production"
    caCert: ""  # Base64 encoded CA certificate

  # Keycloak secrets
  keycloak:
    clientSecret: "change-in-production"

  # Schema Registry secrets
  schemaRegistry:
    username: ""
    password: ""

# Service Monitor para Prometheus
serviceMonitor:
  enabled: true
  interval: 30s
  path: /metrics
  labels:
    neural-hive-mind.org/monitoring: "enabled"

# Network Policy
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: istio-system
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - namespaceSelector:
            matchLabels:
              neural-hive-mind.org/kafka-access: "enabled"
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: neural-hive-kafka
    - to: []  # DNS
      ports:
        - protocol: UDP
          port: 53

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Istio configuration
istio:
  enabled: true
  sidecar:
    inject: true
  virtualService:
    enabled: false
  gateway:
    enabled: false

# Observabilidade
observability:
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      path: /metrics
      labels:
        neural-hive-mind.org/monitoring: "enabled"
  jaeger:
    endpoint: "http://jaeger-collector.monitoring.svc.cluster.local:14268/api/traces"

# Volume mounts para modelos ML
volumes:
  - name: model-cache
    emptyDir: {}

volumeMounts:
  - name: model-cache
    mountPath: /app/models

# Environment específicos
environments:
  dev:
    replicaCount: 1
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi
    config:
      debug: true
      logLevel: "DEBUG"
      nlu:
        routingThresholdHigh: 0.4  # Mais permissivo em dev
        routingThresholdLow: 0.2
        routingUseAdaptiveForDecisions: true  # Testar adaptive em dev

  staging:
    replicaCount: 2
    config:
      logLevel: "INFO"
      nlu:
        # Configuração para testes A/B: adaptive desabilitado para usar thresholds fixos
        # Esta configuração é temporária para experimentos de validação
        adaptiveThresholdEnabled: false  # Desabilitado para A/B test com thresholds fixos
        routingUseAdaptiveForDecisions: false  # Usar apenas thresholds fixos para roteamento
        routingThresholdHigh: 0.5  # Balanceado
        routingThresholdLow: 0.3

  prod:
    replicaCount: 3
    config:
      logLevel: "WARNING"
      nlu:
        routingThresholdHigh: 0.6  # Mais conservador
        routingThresholdLow: 0.35