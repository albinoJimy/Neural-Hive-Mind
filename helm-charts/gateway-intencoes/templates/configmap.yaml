apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway-intencoes.fullname" . }}-config
  labels:
    {{- include "gateway-intencoes.labels" . | nindent 4 }}
data:
  environment: {{ .Values.config.environment | quote }}
  log_level: {{ .Values.config.logLevel | quote }}
  kafka_bootstrap_servers: {{ .Values.config.kafka.bootstrapServers | quote }}
  schema_registry_url: {{ .Values.config.kafka.schemaRegistryUrl | quote }}

  # Kafka Security Configuration
  kafka_security_protocol: {{ if .Values.config.kafka.tls.enabled }}{{ if .Values.config.kafka.sasl.enabled }}"SASL_SSL"{{ else }}"SSL"{{ end }}{{ else }}{{ if .Values.config.kafka.sasl.enabled }}"SASL_PLAINTEXT"{{ else }}"PLAINTEXT"{{ end }}{{ end }}
  kafka_sasl_mechanism: {{ .Values.config.kafka.sasl.mechanism | quote }}

  # Kafka Performance Configuration
  kafka_batch_size: {{ .Values.config.kafka.performance.batchSize | default "16384" | quote }}
  kafka_linger_ms: {{ .Values.config.kafka.performance.lingerMs | default "10" | quote }}
  kafka_compression_type: {{ .Values.config.kafka.performance.compressionType | default "snappy" | quote }}

  # Kafka TLS Certificate Paths
  {{- if .Values.config.kafka.tls.enabled }}
  kafka_ssl_ca_location: "/etc/ssl/certs/kafka-ca.crt"
  kafka_ssl_certificate_location: "/etc/ssl/certs/kafka-client.crt"
  kafka_ssl_key_location: "/etc/ssl/certs/kafka-client.key"
  {{- else }}
  kafka_ssl_ca_location: ""
  kafka_ssl_certificate_location: ""
  kafka_ssl_key_location: ""
  {{- end }}

  # Legacy Kafka TLS configuration (maintained for compatibility)
  kafka_ssl_enabled: {{ .Values.config.kafka.tls.enabled | quote }}
  kafka_ssl_ca_verify_mode: {{ .Values.config.kafka.tls.caVerifyMode | quote }}
  kafka_ssl_protocol: {{ .Values.config.kafka.tls.protocol | quote }}

  # Legacy Kafka SASL configuration (maintained for compatibility)
  kafka_sasl_enabled: {{ .Values.config.kafka.sasl.enabled | quote }}
  kafka_sasl_oauth2_enabled: {{ .Values.config.kafka.sasl.oauth2.enabled | quote }}
  kafka_sasl_oauth2_token_endpoint: {{ .Values.config.kafka.sasl.oauth2.tokenEndpoint | quote }}
  kafka_sasl_oauth2_scope: {{ .Values.config.kafka.sasl.oauth2.scope | quote }}

  # Redis configuration
  redis_cluster_nodes: {{ .Values.config.redis.clusterNodes | quote }}
  redis_default_ttl: {{ .Values.config.redis.defaultTtl | quote }}
  redis_max_connections: {{ .Values.config.redis.maxConnections | quote }}
  redis_pool_size: {{ .Values.config.redis.poolSize | quote }}
  redis_timeout: {{ .Values.config.redis.timeout | quote }}
  redis_retry_on_timeout: {{ .Values.config.redis.retryOnTimeout | quote }}
  redis_connection_pool_max_connections: {{ .Values.config.redis.connectionPoolMaxConnections | quote }}

  # Redis SSL configuration
  redis_ssl_enabled: {{ .Values.config.redis.ssl.enabled | quote }}
  redis_ssl_cert_reqs: {{ .Values.config.redis.ssl.certReqs | quote }}
  redis_ssl_ca_certs: {{ .Values.config.redis.ssl.caCerts | quote }}
  redis_ssl_certfile: {{ .Values.config.redis.ssl.certFile | quote }}
  redis_ssl_keyfile: {{ .Values.config.redis.ssl.keyFile | quote }}

  # Keycloak configuration
  keycloak_url: {{ .Values.config.keycloak.url | quote }}
  keycloak_realm: {{ .Values.config.keycloak.realm | quote }}
  keycloak_client_id: {{ .Values.config.keycloak.clientId | quote }}
  jwks_uri: {{ .Values.config.keycloak.jwksUri | quote }}
  token_validation_enabled: {{ .Values.config.keycloak.tokenValidationEnabled | quote }}

  asr_model_name: {{ .Values.config.asr.modelName | quote }}
  asr_device: {{ .Values.config.asr.device | quote }}
  nlu_language_model: {{ .Values.config.nlu.languageModel | quote }}
  nlu_confidence_threshold: {{ .Values.config.nlu.confidenceThreshold | quote }}
  nlu_confidence_threshold_strict: {{ .Values.config.nlu.confidenceThresholdStrict | quote }}
  nlu_adaptive_threshold_enabled: {{ .Values.config.nlu.adaptiveThresholdEnabled | quote }}
  nlu_rules_config_path: {{ .Values.config.nlu.rulesConfigPath | quote }}

  # NLU Routing Thresholds
  nlu_routing_threshold_high: {{ .Values.config.nlu.routingThresholdHigh | default "0.5" | quote }}
  nlu_routing_threshold_low: {{ .Values.config.nlu.routingThresholdLow | default "0.3" | quote }}
  nlu_routing_use_adaptive_for_decisions: {{ .Values.config.nlu.routingUseAdaptiveForDecisions | default "false" | quote }}
  max_audio_size_mb: {{ .Values.config.limits.maxAudioSizeMb | quote }}
  max_text_length: {{ .Values.config.limits.maxTextLength | quote }}
  jaeger_endpoint: {{ .Values.observability.jaeger.endpoint | quote }}
  enable_tracing: {{ .Values.observability.tracing.enabled | default "true" | quote }}
  # OpenTelemetry Configuration
  otel_enabled: {{ .Values.observability.otelEnabled | default "false" | quote }}
  otel_endpoint: {{ .Values.observability.otelEndpoint | default "http://opentelemetry-collector.observability.svc.cluster.local:4317" | quote }}

  # Neural Hive Observability Metadata
  neural_hive_service_name: {{ .Values.observability.neuralHive.serviceName | default "gateway-intencoes" | quote }}
  neural_hive_component: {{ .Values.observability.neuralHive.component | default "gateway" | quote }}
  neural_hive_layer: {{ .Values.observability.neuralHive.layer | default "experiencia" | quote }}

  # Rate Limiting Configuration
  rate_limit_enabled: {{ .Values.config.rateLimit.enabled | default "true" | quote }}
  rate_limit_requests_per_minute: {{ .Values.config.rateLimit.requestsPerMinute | default "1000" | quote }}
  rate_limit_burst_size: {{ .Values.config.rateLimit.burstSize | default "100" | quote }}
  rate_limit_fail_open: {{ .Values.config.rateLimit.failOpen | default "true" | quote }}
  rate_limit_tenant_overrides: {{ .Values.config.rateLimit.tenantOverrides | default "{}" | quote }}
  rate_limit_user_overrides: {{ .Values.config.rateLimit.userOverrides | default "{}" | quote }}

  # Security Configuration
  allow_insecure_http_endpoints: {{ .Values.config.security.allowInsecureHttpEndpoints | default "false" | quote }}