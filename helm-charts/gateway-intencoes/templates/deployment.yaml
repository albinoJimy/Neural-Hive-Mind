{{- $ctx := include "gateway-intencoes.context" . | fromYaml }}
{{- $checksumConfig := include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
{{- $checksumSecret := include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}

{{/*
Construir lista de env vars para o deployment
*/}}
{{- $envVars := list }}

{{/* ConfigMap refs */}}
{{- $envVars = append $envVars (dict "name" "ENVIRONMENT" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "environment"))) }}
{{- $envVars = append $envVars (dict "name" "LOG_LEVEL" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "log_level"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_BOOTSTRAP_SERVERS" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_bootstrap_servers"))) }}
{{- $envVars = append $envVars (dict "name" "SCHEMA_REGISTRY_URL" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "schema_registry_url"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SECURITY_PROTOCOL" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_security_protocol"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_BATCH_SIZE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_batch_size"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_LINGER_MS" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_linger_ms"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_COMPRESSION_TYPE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_compression_type"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SSL_CA_LOCATION" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_ssl_ca_location"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SSL_CERTIFICATE_LOCATION" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_ssl_certificate_location"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SSL_KEY_LOCATION" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_ssl_key_location"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SSL_ENABLED" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_ssl_enabled"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SSL_CA_VERIFY_MODE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_ssl_ca_verify_mode"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SSL_PROTOCOL" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_ssl_protocol"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_ENABLED" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_sasl_enabled"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_MECHANISM" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_sasl_mechanism"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_OAUTH2_ENABLED" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_sasl_oauth2_enabled"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_OAUTH2_TOKEN_ENDPOINT" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_sasl_oauth2_token_endpoint"))) }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_OAUTH2_SCOPE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "kafka_sasl_oauth2_scope"))) }}

{{/* Kafka secrets */}}
{{- if .Values.secrets.kafka.username }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_USERNAME" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "kafka-username"))) }}
{{- end }}
{{- if .Values.secrets.kafka.password }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "kafka-password"))) }}
{{- end }}
{{- if .Values.secrets.kafka.oauth2.clientId }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_OAUTH2_CLIENT_ID" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "kafka-oauth2-client-id"))) }}
{{- end }}
{{- if .Values.secrets.kafka.oauth2.clientSecret }}
{{- $envVars = append $envVars (dict "name" "KAFKA_SASL_OAUTH2_CLIENT_SECRET" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "kafka-oauth2-client-secret"))) }}
{{- end }}

{{/* Redis ConfigMap */}}
{{- $envVars = append $envVars (dict "name" "REDIS_CLUSTER_NODES" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_cluster_nodes"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_DEFAULT_TTL" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_default_ttl"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_MAX_CONNECTIONS" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_max_connections"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_POOL_SIZE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_pool_size"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_TIMEOUT" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_timeout"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_RETRY_ON_TIMEOUT" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_retry_on_timeout"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_CONNECTION_POOL_MAX_CONNECTIONS" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_connection_pool_max_connections"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_SSL_ENABLED" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_ssl_enabled"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_SSL_CERT_REQS" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_ssl_cert_reqs"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_SSL_CA_CERTS" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_ssl_ca_certs"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_SSL_CERTFILE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_ssl_certfile"))) }}
{{- $envVars = append $envVars (dict "name" "REDIS_SSL_KEYFILE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "redis_ssl_keyfile"))) }}
{{- if .Values.secrets.redis }}
{{- $envVars = append $envVars (dict "name" "REDIS_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "redis-password"))) }}
{{- end }}

{{/* Keycloak ConfigMap */}}
{{- $envVars = append $envVars (dict "name" "KEYCLOAK_URL" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "keycloak_url"))) }}
{{- $envVars = append $envVars (dict "name" "KEYCLOAK_REALM" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "keycloak_realm"))) }}
{{- $envVars = append $envVars (dict "name" "KEYCLOAK_CLIENT_ID" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "keycloak_client_id"))) }}
{{- $envVars = append $envVars (dict "name" "JWKS_URI" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "jwks_uri"))) }}
{{- $envVars = append $envVars (dict "name" "TOKEN_VALIDATION_ENABLED" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "token_validation_enabled"))) }}
{{- if .Values.secrets.keycloak }}
{{- $envVars = append $envVars (dict "name" "KEYCLOAK_CLIENT_SECRET" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "keycloak-client-secret"))) }}
{{- end }}

{{/* Schema Registry secrets */}}
{{- if .Values.secrets.schemaRegistry.username }}
{{- $envVars = append $envVars (dict "name" "SCHEMA_REGISTRY_USERNAME" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "schema-registry-username"))) }}
{{- end }}
{{- if .Values.secrets.schemaRegistry.password }}
{{- $envVars = append $envVars (dict "name" "SCHEMA_REGISTRY_PASSWORD" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "schema-registry-password"))) }}
{{- end }}

{{/* JWT and ASR/NLU */}}
{{- $envVars = append $envVars (dict "name" "JWT_SECRET_KEY" "valueFrom" (dict "secretKeyRef" (dict "name" (include "gateway-intencoes.secretName" .) "key" "jwt-secret-key"))) }}
{{- $envVars = append $envVars (dict "name" "ASR_MODEL_NAME" "value" .Values.config.asr.modelName) }}
{{- $envVars = append $envVars (dict "name" "ASR_DEVICE" "value" .Values.config.asr.device) }}
{{- $envVars = append $envVars (dict "name" "ASR_LAZY_LOADING" "value" (.Values.config.asr.lazyLoading | toString)) }}
{{- $envVars = append $envVars (dict "name" "ASR_MODEL_CACHE_DIR" "value" .Values.config.asr.modelCacheDir) }}
{{- $envVars = append $envVars (dict "name" "NLU_LANGUAGE_MODEL" "value" .Values.config.nlu.languageModel) }}
{{- $envVars = append $envVars (dict "name" "NLU_MODEL_CACHE_DIR" "value" "/app/models/spacy") }}
{{- $envVars = append $envVars (dict "name" "NLU_CONFIDENCE_THRESHOLD" "value" (.Values.config.nlu.confidenceThreshold | toString)) }}
{{- $envVars = append $envVars (dict "name" "NLU_CONFIDENCE_THRESHOLD_STRICT" "value" (.Values.config.nlu.confidenceThresholdStrict | toString)) }}
{{- $envVars = append $envVars (dict "name" "NLU_ADAPTIVE_THRESHOLD_ENABLED" "value" (.Values.config.nlu.adaptiveThresholdEnabled | toString)) }}
{{- $envVars = append $envVars (dict "name" "NLU_RULES_CONFIG_PATH" "value" .Values.config.nlu.rulesConfigPath) }}
{{- $envVars = append $envVars (dict "name" "NLU_ROUTING_THRESHOLD_HIGH" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "nlu_routing_threshold_high"))) }}
{{- $envVars = append $envVars (dict "name" "NLU_ROUTING_THRESHOLD_LOW" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "nlu_routing_threshold_low"))) }}
{{- $envVars = append $envVars (dict "name" "NLU_ROUTING_USE_ADAPTIVE_FOR_DECISIONS" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "nlu_routing_use_adaptive_for_decisions"))) }}
{{- $envVars = append $envVars (dict "name" "JAEGER_ENDPOINT" "value" .Values.observability.jaeger.endpoint) }}
{{- $envVars = append $envVars (dict "name" "ENABLE_TRACING" "value" (default "true" (.Values.observability.tracing.enabled | toString))) }}
{{- $envVars = append $envVars (dict "name" "OTEL_ENABLED" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "otel_enabled"))) }}
{{- $envVars = append $envVars (dict "name" "OTEL_ENDPOINT" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "otel_endpoint"))) }}

{{/* Rate Limiting ConfigMap */}}
{{- $envVars = append $envVars (dict "name" "RATE_LIMIT_ENABLED" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "rate_limit_enabled"))) }}
{{- $envVars = append $envVars (dict "name" "RATE_LIMIT_REQUESTS_PER_MINUTE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "rate_limit_requests_per_minute"))) }}
{{- $envVars = append $envVars (dict "name" "RATE_LIMIT_BURST_SIZE" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "rate_limit_burst_size"))) }}
{{- $envVars = append $envVars (dict "name" "RATE_LIMIT_FAIL_OPEN" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "rate_limit_fail_open"))) }}
{{- $envVars = append $envVars (dict "name" "RATE_LIMIT_TENANT_OVERRIDES" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "rate_limit_tenant_overrides"))) }}
{{- $envVars = append $envVars (dict "name" "RATE_LIMIT_USER_OVERRIDES" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "rate_limit_user_overrides"))) }}

{{/* Security Configuration */}}
{{- $envVars = append $envVars (dict "name" "ALLOW_INSECURE_HTTP_ENDPOINTS" "valueFrom" (dict "configMapKeyRef" (dict "name" (include "gateway-intencoes.configMapName" .) "key" "allow_insecure_http_endpoints"))) }}

{{/* Kubernetes Downward API */}}
{{- $envVars = append $envVars (dict "name" "POD_UID" "valueFrom" (dict "fieldRef" (dict "fieldPath" "metadata.uid"))) }}
{{- $envVars = append $envVars (dict "name" "POD_NAME" "valueFrom" (dict "fieldRef" (dict "fieldPath" "metadata.name"))) }}

{{/*
Construir volume mounts
*/}}
{{- $volumeMounts := .Values.volumeMounts | default list }}
{{- if .Values.secrets.redis.caCert }}
{{- $volumeMounts = append $volumeMounts (dict "name" "redis-ca-cert" "mountPath" "/etc/ssl/certs/redis-ca.crt" "subPath" "redis-ca.crt" "readOnly" true) }}
{{- end }}
{{- if .Values.secrets.kafka.tls.caCert }}
{{- $volumeMounts = append $volumeMounts (dict "name" "kafka-ca-cert" "mountPath" "/etc/ssl/certs/kafka-ca.crt" "subPath" "kafka-ca.crt" "readOnly" true) }}
{{- end }}
{{- if .Values.secrets.kafka.tls.clientCert }}
{{- $volumeMounts = append $volumeMounts (dict "name" "kafka-client-cert" "mountPath" "/etc/ssl/certs/kafka-client.crt" "subPath" "kafka-client.crt" "readOnly" true) }}
{{- end }}
{{- if .Values.secrets.kafka.tls.clientKey }}
{{- $volumeMounts = append $volumeMounts (dict "name" "kafka-client-key" "mountPath" "/etc/ssl/certs/kafka-client.key" "subPath" "kafka-client.key" "readOnly" true) }}
{{- end }}

{{/*
Construir volumes
*/}}
{{- $volumes := list }}
{{- if .Values.persistence.models.enabled }}
{{- $volumes = append $volumes (dict "name" "model-cache" "persistentVolumeClaim" (dict "claimName" (printf "%s-models-pvc" (include "gateway-intencoes.fullname" .)))) }}
{{- else }}
{{- $volumes = .Values.volumes | default list }}
{{- end }}
{{- if .Values.secrets.redis.caCert }}
{{- $volumes = append $volumes (dict "name" "redis-ca-cert" "secret" (dict "secretName" (include "gateway-intencoes.secretName" .) "items" (list (dict "key" "redis-ca-cert" "path" "redis-ca.crt")))) }}
{{- end }}
{{- if .Values.secrets.kafka.tls.caCert }}
{{- $volumes = append $volumes (dict "name" "kafka-ca-cert" "secret" (dict "secretName" (include "gateway-intencoes.secretName" .) "items" (list (dict "key" "kafka-ca-cert" "path" "kafka-ca.crt")))) }}
{{- end }}
{{- if .Values.secrets.kafka.tls.clientCert }}
{{- $volumes = append $volumes (dict "name" "kafka-client-cert" "secret" (dict "secretName" (include "gateway-intencoes.secretName" .) "items" (list (dict "key" "kafka-client-cert" "path" "kafka-client.crt")))) }}
{{- end }}
{{- if .Values.secrets.kafka.tls.clientKey }}
{{- $volumes = append $volumes (dict "name" "kafka-client-key" "secret" (dict "secretName" (include "gateway-intencoes.secretName" .) "items" (list (dict "key" "kafka-client-key" "path" "kafka-client.key")))) }}
{{- end }}

{{/*
Construir init containers
*/}}
{{- $initContainers := list }}
{{- if .Values.initContainers.modelDownloader.enabled }}
{{- $initContainerEnv := list }}
{{- $initContainerEnv = append $initContainerEnv (dict "name" "ASR_MODEL_NAME" "value" .Values.config.asr.modelName) }}
{{- $initContainerEnv = append $initContainerEnv (dict "name" "NLU_LANGUAGE_MODEL" "value" .Values.config.nlu.languageModel) }}
{{- $initContainerEnv = append $initContainerEnv (dict "name" "MODEL_CACHE_DIR" "value" "/app/models") }}
{{- $initContainer := dict "name" "model-downloader" "image" .Values.initContainers.modelDownloader.image "command" (list "/bin/sh" "-c" (printf `set -e
echo "=== Verificando e baixando modelos ML ==="

# Verificar se modelo Whisper já existe
WHISPER_MODEL_PATH="/app/models/whisper/%s.pt"
if [ -f "$WHISPER_MODEL_PATH" ]; then
  echo "✓ Modelo Whisper %s já existe no cache"
else
  echo "→ Baixando modelo Whisper %s..."

  # Verificar se openai-whisper já está instalado (presente na imagem base)
  if python -c "import whisper" 2>/dev/null; then
    echo "  openai-whisper já instalado na imagem base"
  else
    # Instalar dependências pesadas primeiro se necessário
    pip install --no-cache-dir torch torchaudio || true
    # Instalar whisper sem re-baixar dependências já presentes
    pip install --no-cache-dir --no-deps openai-whisper
  fi

  export XDG_CACHE_HOME=/app/models
  python -c "import whisper; whisper.load_model('%s')"
  echo "✓ Modelo Whisper %s baixado com sucesso"
fi

# Verificar se modelo spaCy já existe
SPACY_MODEL_DIR="/app/models/spacy"
SPACY_MODEL_PATH="$SPACY_MODEL_DIR/%s"

# Criar diretório de modelos spaCy se não existir
mkdir -p "$SPACY_MODEL_DIR"

if [ -d "$SPACY_MODEL_PATH" ]; then
  echo "✓ Modelo spaCy %s já existe no cache"
else
  echo "→ Baixando modelo spaCy %s..."

  # Verificar se spaCy já está instalado (presente na imagem base)
  if python -c "import spacy" 2>/dev/null; then
    echo "  spaCy já instalado na imagem base"
  else
    pip install --no-cache-dir spacy
  fi

  # Configurar variáveis de ambiente para instalar no volume persistente
  export PYTHONUSERBASE="$SPACY_MODEL_DIR"

  # Baixar modelo e instalá-lo no diretório compartilhado
  python -m spacy download %s --user

  # Criar link simbólico para facilitar o acesso
  SITE_PACKAGES=$(python -c "import site; print(site.USER_SITE)")
  mkdir -p "$SITE_PACKAGES"
  if [ -d "$SITE_PACKAGES/%s" ]; then
    ln -sf "$SITE_PACKAGES/%s" "$SPACY_MODEL_PATH"
  else
    # Fallback: baixar diretamente para o diretório de destino usando --no-deps
    pip download --no-deps %s -d /tmp
    pip install --no-cache-dir --no-deps --target="$SPACY_MODEL_PATH" /tmp/%s*.tar.gz || \
    pip install --no-cache-dir --no-deps --target="$SPACY_MODEL_PATH" /tmp/%s*.whl
  fi

  echo "✓ Modelo spaCy %s baixado e instalado em $SPACY_MODEL_PATH"
fi

echo "=== Download de modelos concluído ==="` .Values.config.asr.modelName .Values.config.asr.modelName .Values.config.asr.modelName .Values.config.asr.modelName .Values.config.asr.modelName .Values.config.nlu.languageModel .Values.config.nlu.languageModel .Values.config.nlu.languageModel .Values.config.nlu.languageModel .Values.config.nlu.languageModel .Values.config.nlu.languageModel .Values.config.nlu.languageModel .Values.config.nlu.languageModel .Values.config.nlu.languageModel .Values.config.nlu.languageModel)) "env" $initContainerEnv "resources" .Values.initContainers.modelDownloader.resources "volumeMounts" (list (dict "name" "model-cache" "mountPath" "/app/models")) "securityContext" .Values.securityContext }}
{{- $initContainers = append $initContainers $initContainer }}
{{- end }}

{{/*
Construir valores modificados para o template comum
*/}}
{{- $modifiedValues := deepCopy .Values }}
{{- $_ := set $modifiedValues "volumeMounts" $volumeMounts }}
{{- $_ := set $modifiedValues "volumes" $volumes }}
{{- $_ := set $modifiedValues "initContainers" $initContainers }}

{{/*
Configuração para o template
*/}}
{{- $config := dict "checksumConfig" $checksumConfig "checksumSecret" $checksumSecret "env" $envVars }}

{{- include "neural-hive.deployment" (dict "values" $modifiedValues "context" $ctx "config" $config) }}
