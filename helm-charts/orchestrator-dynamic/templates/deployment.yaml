{{/*
Orchestrator Dynamic - Deployment usando templates comuns do Neural Hive Mind
*/}}
{{- $ctx := include "orchestrator-dynamic.context" . | fromYaml }}

{{/* Checksums para config e secret */}}
{{- $checksumConfig := include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
{{- $checksumSecret := include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}

{{/* Construir envFrom list */}}
{{- $envFrom := list }}
{{- $envFrom = append $envFrom (dict "configMapRef" (dict "name" (include "orchestrator-dynamic.configMapName" .))) }}
{{- $envFrom = append $envFrom (dict "secretRef" (dict "name" (include "orchestrator-dynamic.secretName" .))) }}

{{/* Construir volumes dinamicamente (incluindo SPIFFE se habilitado) */}}
{{- $volumes := .Values.volumes | default list }}
{{- if .Values.config.spiffe.enabled }}
{{- $volumes = append $volumes (dict "name" "spire-agent-socket" "hostPath" (dict "path" "/run/spire/sockets" "type" "Directory")) }}
{{- end }}

{{/* Construir volumeMounts dinamicamente (incluindo SPIFFE se habilitado) */}}
{{- $volumeMounts := .Values.volumeMounts | default list }}
{{- if .Values.config.spiffe.enabled }}
{{- $volumeMounts = append $volumeMounts (dict "name" "spire-agent-socket" "mountPath" "/run/spire/sockets" "readOnly" true) }}
{{- end }}

{{/* Construir podAnnotations dinamicamente (incluindo Vault se habilitado) */}}
{{- $podAnnotations := .Values.podAnnotations | default dict }}
{{- if .Values.config.vault.enabled }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject" "true" }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/role" .Values.config.vault.kubernetesRole }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-secret-mongodb" (printf "%s/data/orchestrator/mongodb" .Values.config.vault.mountKv) }}
{{- $mongodbTemplate := printf "{{`{{- with secret \"%s/data/orchestrator/mongodb\" -}}\nexport MONGODB_URI=\"{{ .Data.data.uri }}\"\n{{- end }}`}}" .Values.config.vault.mountKv }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-template-mongodb" $mongodbTemplate }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-secret-postgres" (printf "%s/creds/temporal-orchestrator" .Values.config.vault.mountDatabase) }}
{{- $postgresTemplate := printf "{{`{{- with secret \"%s/creds/temporal-orchestrator\" -}}\nexport POSTGRES_USER=\"{{ .Data.username }}\"\nexport POSTGRES_PASSWORD=\"{{ .Data.password }}\"\n{{- end }}`}}" .Values.config.vault.mountDatabase }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-template-postgres" $postgresTemplate }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-secret-kafka" (printf "%s/data/orchestrator/kafka" .Values.config.vault.mountKv) }}
{{- $kafkaTemplate := printf "{{`{{- with secret \"%s/data/orchestrator/kafka\" -}}\nexport KAFKA_SASL_USERNAME=\"{{ .Data.data.username }}\"\nexport KAFKA_SASL_PASSWORD=\"{{ .Data.data.password }}\"\n{{- end }}`}}" .Values.config.vault.mountKv }}
{{- $_ := set $podAnnotations "vault.hashicorp.com/agent-inject-template-kafka" $kafkaTemplate }}
{{- end }}

{{/* Construir valores modificados com overrides */}}
{{- $modifiedValues := deepCopy .Values }}
{{- $_ := set $modifiedValues "volumeMounts" $volumeMounts }}
{{- $_ := set $modifiedValues "volumes" $volumes }}
{{- $_ := set $modifiedValues "podAnnotations" $podAnnotations }}

{{/* Configuração para o template comum */}}
{{- $config := dict "checksumConfig" $checksumConfig "checksumSecret" $checksumSecret "envFrom" $envFrom }}

{{/* Chamar template comum */}}
{{- include "neural-hive.deployment" (dict "values" $modifiedValues "context" $ctx "config" $config) }}
