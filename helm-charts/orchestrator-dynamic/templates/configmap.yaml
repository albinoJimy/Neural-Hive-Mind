apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "orchestrator-dynamic.configMapName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "orchestrator-dynamic.labels" . | nindent 4 }}
data:
  SERVICE_NAME: {{ .Values.config.serviceName | quote }}
  SERVICE_VERSION: {{ .Values.config.serviceVersion | quote }}
  ENVIRONMENT: {{ .Values.config.environment | quote }}
  LOG_LEVEL: {{ .Values.config.logLevel | quote }}

  # Temporal
  TEMPORAL_ENABLED: {{ .Values.config.temporal.enabled | quote }}
  TEMPORAL_HOST: {{ .Values.config.temporal.host | quote }}
  TEMPORAL_PORT: {{ .Values.config.temporal.port | quote }}
  TEMPORAL_NAMESPACE: {{ .Values.config.temporal.namespace | quote }}
  TEMPORAL_TASK_QUEUE: {{ .Values.config.temporal.taskQueue | quote }}
  TEMPORAL_TLS_ENABLED: {{ .Values.config.temporal.tlsEnabled | quote }}

  # Kafka
  KAFKA_BOOTSTRAP_SERVERS: {{ .Values.config.kafka.bootstrapServers | quote }}
  KAFKA_CONSENSUS_TOPIC: {{ .Values.config.kafka.consensusTopic | quote }}
  KAFKA_TICKETS_TOPIC: {{ .Values.config.kafka.ticketsTopic | quote }}
  KAFKA_CONSUMER_GROUP_ID: {{ .Values.config.kafka.consumerGroupId | quote }}
  KAFKA_SECURITY_PROTOCOL: {{ .Values.config.kafka.securityProtocol | quote }}
  KAFKA_SASL_MECHANISM: {{ .Values.config.kafka.saslMechanism | quote }}
  KAFKA_SASL_USERNAME: {{ .Values.config.kafka.saslUsername | quote }}
  KAFKA_SASL_PASSWORD: {{ .Values.config.kafka.saslPassword | quote }}
  KAFKA_SSL_CA_LOCATION: {{ .Values.config.kafka.sslCaLocation | quote }}
  KAFKA_SSL_CERTIFICATE_LOCATION: {{ .Values.config.kafka.sslCertificateLocation | quote }}
  KAFKA_SSL_KEY_LOCATION: {{ .Values.config.kafka.sslKeyLocation | quote }}
  KAFKA_SCHEMA_REGISTRY_URL: {{ .Values.config.kafka.schemaRegistryUrl | quote }}
  SCHEMAS_BASE_PATH: {{ .Values.config.kafka.schemasBasePath | quote }}

  # PostgreSQL
  POSTGRES_HOST: {{ .Values.config.postgres.host | quote }}
  POSTGRES_PORT: {{ .Values.config.postgres.port | quote }}
  POSTGRES_DATABASE: {{ .Values.config.postgres.database | quote }}
  POSTGRES_SSL_MODE: {{ .Values.config.postgres.sslMode | quote }}

  # MongoDB
  MONGODB_DATABASE: {{ .Values.config.mongodb.database | quote }}
  MONGODB_COLLECTION_TICKETS: {{ .Values.config.mongodb.collectionTickets | quote }}
  MONGODB_COLLECTION_WORKFLOWS: {{ .Values.config.mongodb.collectionWorkflows | quote }}
  MONGODB_FAIL_OPEN_EXECUTION_TICKETS: {{ .Values.config.mongodb.persistence.failOpenExecutionTickets | quote }}
  MONGODB_FAIL_OPEN_VALIDATION_AUDIT: {{ .Values.config.mongodb.persistence.failOpenValidationAudit | quote }}
  MONGODB_FAIL_OPEN_WORKFLOW_RESULTS: {{ .Values.config.mongodb.persistence.failOpenWorkflowResults | quote }}

  # Redis
  REDIS_CLUSTER_NODES: {{ .Values.config.redis.clusterNodes | quote }}
  REDIS_SSL_ENABLED: {{ .Values.config.redis.sslEnabled | quote }}

  # Scheduler
  ENABLE_INTELLIGENT_SCHEDULER: {{ .Values.config.scheduler.enableIntelligentScheduler | quote }}
  ENABLE_ML_ENHANCED_SCHEDULING: {{ .Values.config.scheduler.enableMlEnhancedScheduling | quote }}
  SCHEDULER_MAX_PARALLEL_TICKETS: {{ .Values.config.scheduler.maxParallelTickets | quote }}

  # Scheduler Preemption
  SCHEDULER_ENABLE_PREEMPTION: {{ .Values.config.scheduler.enablePreemption | quote }}
  SCHEDULER_PREEMPTION_MIN_PREEMPTOR_PRIORITY: {{ .Values.config.scheduler.preemption.minPreemptorPriority | quote }}
  SCHEDULER_PREEMPTION_MAX_PREEMPTABLE_PRIORITY: {{ .Values.config.scheduler.preemption.maxPreemptablePriority | quote }}
  SCHEDULER_PREEMPTION_GRACE_PERIOD_SECONDS: {{ .Values.config.scheduler.preemption.gracePeriodSeconds | quote }}
  SCHEDULER_PREEMPTION_MAX_CONCURRENT: {{ .Values.config.scheduler.preemption.maxConcurrentPreemptions | quote }}
  SCHEDULER_PREEMPTION_WORKER_COOLDOWN_SECONDS: {{ .Values.config.scheduler.preemption.workerCooldownSeconds | quote }}
  SCHEDULER_PREEMPTION_RETRY_PREEMPTED_TASKS: {{ .Values.config.scheduler.preemption.retryPreemptedTasks | quote }}
  SCHEDULER_PREEMPTION_RETRY_DELAY_SECONDS: {{ .Values.config.scheduler.preemption.retryDelaySeconds | quote }}

  # Scheduler Affinity/Anti-Affinity
  SCHEDULER_ENABLE_AFFINITY: {{ .Values.config.scheduler.enableAffinity | quote }}
  SCHEDULER_AFFINITY_PLAN_WEIGHT: {{ .Values.config.scheduler.affinity.weights.planAffinity | quote }}
  SCHEDULER_AFFINITY_ANTI_WEIGHT: {{ .Values.config.scheduler.affinity.weights.antiAffinity | quote }}
  SCHEDULER_AFFINITY_INTENT_WEIGHT: {{ .Values.config.scheduler.affinity.weights.intentAffinity | quote }}
  SCHEDULER_AFFINITY_PLAN_THRESHOLD: {{ .Values.config.scheduler.affinity.planAffinityThreshold | quote }}
  SCHEDULER_AFFINITY_CACHE_TTL_SECONDS: {{ .Values.config.scheduler.affinity.cacheTtlSeconds | quote }}
  SCHEDULER_AFFINITY_ANTI_AFFINITY_RISK_BANDS: {{ .Values.config.scheduler.affinity.antiAffinityRiskBands | toJson | quote }}
  SCHEDULER_AFFINITY_ANTI_AFFINITY_PRIORITIES: {{ .Values.config.scheduler.affinity.antiAffinityPriorities | toJson | quote }}

  # ML
  ML_PREDICTIONS_ENABLED: {{ .Values.config.ml.predictionsEnabled | quote }}
  ML_DRIFT_DETECTION_ENABLED: {{ .Values.config.ml.driftDetectionEnabled | quote }}
  ML_DRIFT_BASELINE_ENABLED: {{ .Values.config.ml.driftBaselineEnabled | quote }}
  ML_BACKFILL_ERRORS: {{ .Values.config.ml.backfillErrors | quote }}

  # SLA
  SLA_DEFAULT_TIMEOUT_MS: {{ printf "%d" (int64 .Values.config.sla.defaultTimeoutMs) | quote }}
  SLA_CHECK_INTERVAL_SECONDS: {{ .Values.config.sla.checkIntervalSeconds | quote }}
  SLA_ALERT_THRESHOLD_PERCENT: {{ .Values.config.sla.alertThresholdPercent | quote }}
  SLA_TICKET_MIN_TIMEOUT_MS: {{ printf "%d" (int64 .Values.config.sla.ticketMinTimeoutMs) | quote }}
  SLA_TICKET_TIMEOUT_BUFFER_MULTIPLIER: {{ .Values.config.sla.ticketTimeoutBufferMultiplier | quote }}

  # Retry
  RETRY_MAX_ATTEMPTS: {{ .Values.config.retry.maxAttempts | quote }}
  RETRY_INITIAL_INTERVAL_MS: {{ .Values.config.retry.initialIntervalMs | quote }}
  RETRY_BACKOFF_COEFFICIENT: {{ .Values.config.retry.backoffCoefficient | quote }}
  RETRY_MAX_INTERVAL_MS: {{ .Values.config.retry.maxIntervalMs | quote }}

  # Observability
  OTEL_ENABLED: {{ .Values.config.observability.otelEnabled | quote }}
  OTEL_EXPORTER_ENDPOINT: {{ .Values.config.observability.otelExporterEndpoint | quote }}
  OTEL_SAMPLING_RATE: {{ .Values.config.observability.tracingSamplingRate | quote }}
  PROMETHEUS_PORT: {{ .Values.config.observability.prometheusPort | quote }}

  # OPA Policy Engine
  OPA_ENABLED: {{ .Values.config.opa.enabled | quote }}
  OPA_HOST: {{ .Values.config.opa.host | quote }}
  OPA_PORT: {{ .Values.config.opa.port | quote }}
  OPA_TIMEOUT_SECONDS: {{ .Values.config.opa.timeoutSeconds | quote }}
  OPA_RETRY_ATTEMPTS: {{ .Values.config.opa.retryAttempts | quote }}
  OPA_CACHE_TTL_SECONDS: {{ .Values.config.opa.cacheTtlSeconds | quote }}
  OPA_FAIL_OPEN: {{ .Values.config.opa.failOpen | quote }}

  # OPA Policy Parameters
  OPA_MAX_CONCURRENT_TICKETS: {{ .Values.config.opa.policies.maxConcurrentTickets | quote }}
  OPA_ALLOWED_CAPABILITIES: {{ .Values.config.opa.policies.allowedCapabilities | toJson | quote }}
  OPA_RESOURCE_LIMITS: {{ .Values.config.opa.policies.resourceLimits | toJson | quote }}

  # OPA Feature Flags
  OPA_INTELLIGENT_SCHEDULER_ENABLED: {{ .Values.config.opa.featureFlags.intelligentSchedulerEnabled | quote }}
  OPA_BURST_CAPACITY_ENABLED: {{ .Values.config.opa.featureFlags.burstCapacityEnabled | quote }}
  OPA_BURST_THRESHOLD: {{ .Values.config.opa.featureFlags.burstThreshold | quote }}
  OPA_PREDICTIVE_ALLOCATION_ENABLED: {{ .Values.config.opa.featureFlags.predictiveAllocationEnabled | quote }}
  OPA_AUTO_SCALING_ENABLED: {{ .Values.config.opa.featureFlags.autoScalingEnabled | quote }}
  OPA_SCHEDULER_NAMESPACES: {{ .Values.config.opa.featureFlags.schedulerNamespaces | toJson | quote }}
  OPA_PREMIUM_TENANTS: {{ .Values.config.opa.featureFlags.premiumTenants | toJson | quote }}

  # Circuit Breaker Configuration
  CIRCUIT_BREAKER_ENABLED: {{ .Values.config.circuitBreaker.enabled | quote }}
  CIRCUIT_BREAKER_FAIL_MAX: {{ .Values.config.circuitBreaker.failMax | quote }}
  CIRCUIT_BREAKER_TIMEOUT: {{ .Values.config.circuitBreaker.timeoutSeconds | quote }}
  CIRCUIT_BREAKER_RECOVERY_TIMEOUT: {{ .Values.config.circuitBreaker.recoveryTimeoutSeconds | quote }}

  # Kafka Circuit Breaker
  KAFKA_CIRCUIT_BREAKER_ENABLED: {{ .Values.config.circuitBreaker.kafka.enabled | quote }}
  KAFKA_CIRCUIT_BREAKER_FAIL_MAX: {{ .Values.config.circuitBreaker.kafka.failMax | quote }}
  KAFKA_CIRCUIT_BREAKER_TIMEOUT: {{ .Values.config.circuitBreaker.kafka.timeoutSeconds | quote }}
  KAFKA_CIRCUIT_BREAKER_RECOVERY_TIMEOUT: {{ .Values.config.circuitBreaker.kafka.recoveryTimeoutSeconds | quote }}

  # Temporal Circuit Breaker
  TEMPORAL_CIRCUIT_BREAKER_ENABLED: {{ .Values.config.circuitBreaker.temporal.enabled | quote }}
  TEMPORAL_CIRCUIT_BREAKER_FAIL_MAX: {{ .Values.config.circuitBreaker.temporal.failMax | quote }}
  TEMPORAL_CIRCUIT_BREAKER_TIMEOUT: {{ .Values.config.circuitBreaker.temporal.timeoutSeconds | quote }}
  TEMPORAL_CIRCUIT_BREAKER_RECOVERY_TIMEOUT: {{ .Values.config.circuitBreaker.temporal.recoveryTimeoutSeconds | quote }}

  # Redis Circuit Breaker
  REDIS_CIRCUIT_BREAKER_ENABLED: {{ .Values.config.circuitBreaker.redis.enabled | quote }}
  REDIS_CIRCUIT_BREAKER_FAIL_MAX: {{ .Values.config.circuitBreaker.redis.failMax | quote }}
  REDIS_CIRCUIT_BREAKER_TIMEOUT: {{ .Values.config.circuitBreaker.redis.timeoutSeconds | quote }}
  REDIS_CIRCUIT_BREAKER_RECOVERY_TIMEOUT: {{ .Values.config.circuitBreaker.redis.recoveryTimeoutSeconds | quote }}

  # SPIFFE/SPIRE Configuration
  {{- if .Values.config.spiffe.enabled }}
  SPIFFE_ENABLED: {{ .Values.config.spiffe.enabled | quote }}
  SPIFFE_SOCKET_PATH: {{ .Values.config.spiffe.socketPath | quote }}
  SPIFFE_TRUST_DOMAIN: {{ .Values.config.spiffe.trustDomain | quote }}
  SPIFFE_JWT_AUDIENCE: {{ .Values.config.spiffe.jwtAudience | quote }}
  SPIFFE_ENABLE_X509: {{ .Values.config.spiffe.enableX509 | quote }}
  SPIFFE_FALLBACK_ALLOWED: {{ .Values.config.spiffe.fallbackAllowed | quote }}
  SERVICE_REGISTRY_JWT_AUDIENCE: {{ .Values.config.spiffe.serviceRegistryJwtAudience | quote }}
  {{- end }}
