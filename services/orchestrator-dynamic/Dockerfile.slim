# Single-stage Dockerfile for memory-constrained builds
# Uses pre-built observability base image with all dependencies
FROM 37.60.241.150:30500/neural-hive-mind/python-observability-base:1.2.3

# Metadados OCI para rastreabilidade
LABEL org.opencontainers.image.title="Orchestrator Dynamic"
LABEL org.opencontainers.image.description="Orquestrador Dinâmico do Neural Hive-Mind usando Temporal"
LABEL org.opencontainers.image.version="1.2.7"
LABEL org.opencontainers.image.vendor="Neural Hive-Mind"
LABEL neural-hive.layer="orchestration"
LABEL neural-hive.component="orchestrator-dynamic"

# Instalar dependências de runtime (libpq para psycopg2)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Criar usuário não-root para segurança
RUN groupadd -r orchestrator && useradd -r -g orchestrator -u 1000 orchestrator

# Criar diretórios necessários
RUN mkdir -p /app/logs /app/tmp && chown -R orchestrator:orchestrator /app

# Definir diretório de trabalho
WORKDIR /app

# Copiar e instalar requirements específicos do orchestrator (runtime-only, sem TensorFlow)
COPY services/orchestrator-dynamic/requirements-runtime.txt .
COPY libraries /libraries
RUN pip install --no-cache-dir -r requirements-runtime.txt && rm -rf /root/.cache/pip

# Copiar código fonte
COPY --chown=orchestrator:orchestrator services/orchestrator-dynamic/src/ ./src/

# Copiar scripts de treinamento ML
COPY --chown=orchestrator:orchestrator services/orchestrator-dynamic/scripts/ ./scripts/

# Mudar para usuário não-root
USER orchestrator

# Expor portas (HTTP, Prometheus, gRPC)
EXPOSE 8000 9090 50053

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Comando de inicialização
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--log-level", "info"]
