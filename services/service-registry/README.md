# Service Registry

Dynamic agent registration and discovery service for Neural Hive-Mind.

## Overview

The Service Registry manages the lifecycle of all agents in the Neural Hive-Mind system:

- **Register:** Initial agent registration with capabilities and metadata
- **Heartbeat:** Periodic status and telemetry updates
- **Discover:** Find agents by capabilities and filters
- **Deregister:** Remove agents from the registry

## Proto Compilation

### Compile Stubs Locally

```bash
# Compile only Service Registry protos
make proto-service-registry

# Compile all protos (includes Service Registry)
make proto-gen-all
```

### Manual Compilation

```bash
bash services/service-registry/scripts/compile_protos.sh
```

### Generated Files

Server-side stubs:
- `src/proto/service_registry_pb2.py`
- `src/proto/service_registry_pb2_grpc.py`
- `src/proto/service_registry_pb2.pyi`

Client-side stubs (in library):
- `libraries/neural_hive_integration/neural_hive_integration/proto_stubs/service_registry_pb2.py`
- `libraries/neural_hive_integration/neural_hive_integration/proto_stubs/service_registry_pb2_grpc.py`

## Client Usage

### Option 1: Canonical Client (Recommended)

Use the canonical client from `neural_hive_integration` for standard operations:

```python
from neural_hive_integration.clients import ServiceRegistryClient, AgentInfo, HealthStatus

# Initialize client
client = ServiceRegistryClient(host="service-registry", port=50051)

# Register agent
agent = AgentInfo(
    agent_id="",  # Generated by server
    agent_type="worker",
    capabilities=["python", "terraform"],
    endpoint="worker-1:8000",
    metadata={
        "version": "1.0.0",
        "namespace": "default",
        "cluster": "neural-hive"
    }
)
await client.register_agent(agent)

# Send heartbeat
health = HealthStatus(
    status="healthy",
    last_heartbeat=datetime.utcnow().isoformat(),
    metrics={
        "success_rate": 0.95,
        "avg_duration_ms": 150.0,
        "total_executions": 100.0
    }
)
await client.update_health(agent.agent_id, health)

# Discover agents
agents = await client.discover_agents(
    capabilities=["python"],
    filters={"status": "healthy"}
)

# Deregister
await client.deregister_agent(agent.agent_id)

# Close
await client.close()
```

### Option 2: Direct Proto Stubs

For custom implementations with fine-grained control:

```python
import grpc
from neural_hive_integration.proto_stubs import (
    service_registry_pb2,
    service_registry_pb2_grpc
)

# Create channel and stub
channel = grpc.aio.insecure_channel("service-registry:50051")
stub = service_registry_pb2_grpc.ServiceRegistryStub(channel)

# Register
request = service_registry_pb2.RegisterRequest(
    agent_type=service_registry_pb2.WORKER,
    capabilities=["python", "terraform"],
    metadata={"version": "1.0.0"},
    namespace="default",
    cluster="neural-hive",
    version="1.0.0"
)
response = await stub.Register(request)
agent_id = response.agent_id

# Heartbeat
telemetry = service_registry_pb2.AgentTelemetry(
    success_rate=0.95,
    avg_duration_ms=150,
    total_executions=100,
    failed_executions=5
)
heartbeat_request = service_registry_pb2.HeartbeatRequest(
    agent_id=agent_id,
    telemetry=telemetry
)
await stub.Heartbeat(heartbeat_request)

# Discover
discover_request = service_registry_pb2.DiscoverRequest(
    capabilities=["python"],
    filters={"status": "healthy"},
    max_results=10
)
discover_response = await stub.DiscoverAgents(discover_request)

# Deregister
deregister_request = service_registry_pb2.DeregisterRequest(agent_id=agent_id)
await stub.Deregister(deregister_request)

# Close channel
await channel.close()
```

## gRPC API

### Service Methods

| Method | Description |
|--------|-------------|
| `Register` | Register a new agent |
| `Heartbeat` | Send heartbeat with telemetry |
| `Deregister` | Remove agent from registry |
| `DiscoverAgents` | Find agents by capabilities |
| `GetAgent` | Get info for specific agent |
| `ListAgents` | List all agents by type |
| `WatchAgents` | Stream agent changes (server streaming) |
| `NotifyAgent` | Send notification to agent |

### Agent Types

```protobuf
enum AgentType {
  AGENT_TYPE_UNSPECIFIED = 0;
  WORKER = 1;
  SCOUT = 2;
  GUARD = 3;
}
```

### Agent Status

```protobuf
enum AgentStatus {
  AGENT_STATUS_UNSPECIFIED = 0;
  HEALTHY = 1;
  UNHEALTHY = 2;
  DEGRADED = 3;
}
```

## Tests

### Unit Tests

```bash
pytest services/service-registry/tests/unit/ -v
```

### Integration Tests

```bash
# Requires Service Registry running
SERVICE_REGISTRY_HOST=localhost SERVICE_REGISTRY_PORT=50051 \
    pytest services/guard-agents/tests/integration/test_service_registry_integration.py -v -m integration

SERVICE_REGISTRY_HOST=localhost SERVICE_REGISTRY_PORT=50051 \
    pytest services/analyst-agents/tests/integration/test_service_registry_client.py -v -m integration
```

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `SERVICE_REGISTRY_HOST` | gRPC server host | `localhost` |
| `SERVICE_REGISTRY_PORT` | gRPC server port | `50051` |
| `REDIS_URL` | Redis connection URL | `redis://localhost:6379` |
| `HEARTBEAT_TIMEOUT` | Agent timeout in seconds | `60` |

### Kubernetes

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-registry
  namespace: neural-hive
spec:
  ports:
    - port: 50051
      targetPort: 50051
      protocol: TCP
      name: grpc
```

## Monitoring

### Prometheus Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `service_registry_agents_total` | Gauge | Total registered agents |
| `service_registry_register_total` | Counter | Registration attempts |
| `service_registry_heartbeat_total` | Counter | Heartbeat attempts |
| `service_registry_discover_total` | Counter | Discovery requests |
| `service_registry_latency_seconds` | Histogram | Operation latency |

### Health Check

```bash
grpc_health_probe -addr=localhost:50051
```

## Architecture

```
+-------------------+       +-------------------+
|   Guard Agent     |       |   Scout Agent     |
+--------+----------+       +--------+----------+
         |                           |
         v                           v
+------------------------------------------------+
|              Service Registry                   |
|  +------------------------------------------+  |
|  |            gRPC Server                   |  |
|  |  - Register()                            |  |
|  |  - Heartbeat()                           |  |
|  |  - DiscoverAgents()                      |  |
|  |  - Deregister()                          |  |
|  +------------------------------------------+  |
|                      |                          |
|  +------------------------------------------+  |
|  |            Redis Backend                 |  |
|  |  - Agent registry storage                |  |
|  |  - TTL-based expiration                  |  |
|  |  - Pub/Sub for events                    |  |
|  +------------------------------------------+  |
+------------------------------------------------+
```

## Development

### Local Development

```bash
# Start Redis
docker run -d -p 6379:6379 redis:7-alpine

# Run Service Registry
cd services/service-registry
python -m src.main
```

### Docker

```bash
docker build -t service-registry:latest -f services/service-registry/Dockerfile .
docker run -p 50051:50051 service-registry:latest
```
