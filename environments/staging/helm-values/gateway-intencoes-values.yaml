# Staging Environment Values for Gateway de Intenções
# Override values for staging environment

# Configurações globais para staging
global:
  cluster: "neural-hive-staging"
  environment: "staging"

# Desabilitar init container que falha por permissões
initContainers:
  modelDownloader:
    enabled: false

# Image pull authentication
imagePullSecrets:
  - name: ghcr-secret

# Image configuration
image:
  # Pull policy para ambiente de testes
  # Always: Garante que sempre baixa a versão mais recente da imagem do registry
  # Essencial para staging onde a mesma tag pode ser atualizada durante testes iterativos
  # Permite validar mudanças rapidamente sem necessidade de bump de versão
  pullPolicy: Always

# Réplica única para staging (cluster com recursos limitados)
replicaCount: 1
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Recursos reduzidos para staging (cluster com recursos limitados)
resources:
  limits:
    cpu: 500m
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 256Mi

# Staging-specific configuration
config:
  environment: "staging"
  logLevel: "INFO"
  debug: false

  # Security configuration
  security:
    # Schema Registry agora usa TLS
    allowInsecureHttpEndpoints: false

  # Staging Kafka endpoints - namespace correto é 'kafka'
  kafka:
    bootstrapServers: "neural-hive-kafka-kafka-bootstrap.kafka.svc.cluster.local:9092"
    # Schema Registry com TLS habilitado
    schemaRegistryUrl: "https://schema-registry.kafka.svc.cluster.local:8081"
    # TLS settings for Schema Registry client
    schemaRegistry:
      tls:
        enabled: true
        # CA certificate mounted from the same cert-manager issuer
        caSecretName: "schema-registry-tls-secret"
        verifyHostname: true

  # ASR Pipeline
  asr:
    modelName: "base"
    device: "cpu"

  # NLU Pipeline - configuração para testes A/B com thresholds fixos
  nlu:
    languageModel: "pt_core_news_sm"
    confidenceThreshold: 0.6
    confidenceThresholdStrict: 0.75
    # A/B Test: Adaptive desabilitado para usar apenas thresholds fixos
    adaptiveThresholdEnabled: false
    rulesConfigPath: "/app/config/nlu_rules.yaml"
    # Routing Thresholds - balanceado para staging
    routingThresholdHigh: 0.5  # Balanceado: aceitável para maioria dos casos
    routingThresholdLow: 0.3   # Threshold baixo moderado
    routingUseAdaptiveForDecisions: false  # Desabilitado para A/B test

  # Staging limits
  limits:
    maxAudioSizeMb: 10
    maxTextLength: 10000

  # CORS - controlled for staging
  cors:
    allowedOrigins: ["https://staging.neural-hive.local", "https://staging-app.neural-hive.local"]
    allowedHosts: ["staging.neural-hive.local", "staging-app.neural-hive.local"]

# Istio enabled for staging
istio:
  enabled: true
  sidecar:
    inject: true
  virtualService:
    enabled: false
  gateway:
    enabled: false

# Ingress enabled for staging
ingress:
  enabled: true
  className: "istio"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-staging"
  hosts:
    - host: gateway-staging.neural-hive.local
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: gateway-intencoes-staging-tls
      hosts:
        - gateway-staging.neural-hive.local

# Node selection - staging pode usar qualquer node
# Usar null para remover completamente o nodeSelector da base
nodeSelector: null

# Desabilitar topology constraints para staging
topologySpreadConstraints: []

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values: [gateway-intencoes]
          topologyKey: kubernetes.io/hostname

# Network policy enabled for staging
networkPolicy:
  enabled: true

# PDB enabled for staging
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Monitoring enabled
serviceMonitor:
  enabled: true
  interval: 30s
  path: /metrics
  labels:
    neural-hive-mind.org/monitoring: "enabled"

# Staging secrets
secrets:
  jwtSecretKey: "staging-secret-key-change-me"
  # Redis em staging não requer autenticação
  redis:
    password: ""

# Health checks
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 45
  periodSeconds: 25
  timeoutSeconds: 8
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 20
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Persistence - usar StorageClass disponível no cluster
persistence:
  models:
    enabled: true
    storageClass: "longhorn"
    accessMode: ReadWriteOnce
    size: 2Gi

# Observability for staging
# OTEL Collector não tem TLS configurado - usar HTTP
observability:
  otelEnabled: true
  otelEndpoint: "http://opentelemetry-collector.observability.svc.cluster.local:4317"
  jaeger:
    enabled: true
    endpoint: "http://jaeger-collector.monitoring.svc.cluster.local:14268/api/traces"
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
