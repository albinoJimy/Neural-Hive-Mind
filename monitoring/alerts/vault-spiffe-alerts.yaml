apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: vault-spiffe-alerts
  labels:
    role: vault-spiffe
spec:
  groups:
  - name: vault-health
    rules:
    - alert: VaultTokenExpiringSoon
      expr: vault_token_ttl_seconds < 3600
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Vault token expiring soon"
        description: "Vault token TTL below 1h. Check renewal task."
    - alert: VaultTokenExpiringSoonCritical
      expr: vault_token_ttl_seconds < 900
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "Vault token expiring in <15m"
        description: "Vault token TTL critical. Renewal failing."
    - alert: VaultTokenRenewalFailing
      expr: rate(vault_token_renewals_total{status="error"}[5m]) > 3
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Vault token renewals failing"
        description: "Token renewals failing. Check Vault/SPIRE connectivity."
    - alert: VaultCredentialFetchFailing
      expr: rate(orchestrator_vault_credentials_fetched_total{status="error"}[5m]) > 5
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Vault credential fetch failures"
        description: "High rate of Vault credential fetch failures."
    - alert: VaultAPIHighLatency
      expr: histogram_quantile(0.95, sum(rate(vault_request_duration_seconds_bucket[5m])) by (le,operation)) > 2
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Vault API latency high"
        description: "Vault API p95 latency above 2s."

  - name: spiffe-health
    rules:
    - alert: SPIFFESVIDExpiringSoon
      expr: spiffe_svid_ttl_seconds < 1800
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "SPIFFE SVID expiring soon"
        description: "JWT/X509 SVID expiring. Check SPIRE agent."
    - alert: SPIFFESVIDExpiringCritical
      expr: spiffe_svid_ttl_seconds < 300
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "SPIFFE SVID expiring in <5m"
        description: "Immediate action required to renew SVID."
    - alert: SPIFFESVIDFetchFailing
      expr: rate(spiffe_svid_fetch_total{status="error"}[5m]) > 3
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "SPIFFE SVID fetch failing"
        description: "JWT/X509 fetches failing from SPIRE agent."
    - alert: SPIFFETrustBundleStale
      expr: rate(spiffe_trust_bundle_updates_total[1h]) == 0
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "SPIFFE trust bundle not updated"
        description: "Trust bundle not refreshed in the last hour."

  - name: grpc-auth
    rules:
    - alert: GRPCAuthFailureRateHigh
      expr: rate(grpc_jwt_auth_failures_total[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High gRPC auth failure rate"
        description: "JWT-SVID authentication failures exceed 10%."
    - alert: GRPCUnauthenticatedFallbackHigh
      expr: rate(grpc_jwt_auth_attempts_total{status="fallback"}[5m]) > 0.05
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Unauthenticated fallback in gRPC calls"
        description: "Fallback to unauthenticated calls detected."

  - name: credential-rotation
    rules:
    - alert: CredentialRotationStuck
      expr: rate(orchestrator_vault_renewal_task_runs_total{status="success"}[1h]) == 0
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "Vault credential renewal not running"
        description: "No successful credential renewal in the last hour."
