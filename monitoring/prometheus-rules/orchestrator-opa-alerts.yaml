groups:
  - name: orchestrator_opa_alerts
    interval: 30s
    rules:
      # Alta taxa de rejeições OPA
      - alert: HighOPARejectionRate
        expr: rate(orchestration_opa_policy_rejections_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: orchestrator-dynamic
        annotations:
          summary: "Alta taxa de rejeições OPA"
          description: "Taxa de rejeições OPA está acima de 0.1/s por 5 minutos (policy: {{ $labels.policy_name }}, rule: {{ $labels.rule }})"

      # Circuit breaker OPA aberto
      - alert: OPACircuitBreakerOpen
        expr: orchestration_opa_circuit_breaker_state{circuit_name="opa_client"} == 2
        for: 1m
        labels:
          severity: critical
          component: orchestrator-dynamic
        annotations:
          summary: "Circuit breaker OPA aberto"
          description: "Circuit breaker OPA está aberto, validações de políticas estão falhando"

      # Alta latência de validação OPA
      - alert: HighOPAValidationLatency
        expr: histogram_quantile(0.95, rate(orchestration_opa_validation_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: orchestrator-dynamic
        annotations:
          summary: "Alta latência de validação OPA"
          description: "P95 de latência de validação OPA está acima de 1s (policy: {{ $labels.policy_name }})"

      # Alta taxa de erros OPA
      - alert: HighOPAErrorRate
        expr: rate(orchestration_opa_evaluation_errors_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: orchestrator-dynamic
        annotations:
          summary: "Alta taxa de erros OPA"
          description: "Taxa de erros OPA está acima de 0.05/s por 5 minutos (error_type: {{ $labels.error_type }})"

      # Baixa taxa de cache hits OPA
      - alert: LowOPACacheHitRate
        expr: rate(orchestration_opa_cache_hits_total[5m]) / (rate(orchestration_opa_validations_total[5m]) + rate(orchestration_opa_cache_hits_total[5m])) < 0.5
        for: 10m
        labels:
          severity: info
          component: orchestrator-dynamic
        annotations:
          summary: "Baixa taxa de cache hits OPA"
          description: "Taxa de cache hits OPA está abaixo de 50% por 10 minutos"

      # Violações de segurança críticas
      - alert: CriticalSecurityViolations
        expr: rate(orchestration_security_violations_total{severity="critical"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: orchestrator-dynamic
        annotations:
          summary: "Violações de segurança críticas detectadas"
          description: "Violações de segurança críticas detectadas (tenant: {{ $labels.tenant_id }}, type: {{ $labels.violation_type }})"
