{{/* Template Customizado do Slack para Alertas de SLA */}}
{{/* Arquivo: slack-message-template.tmpl */}}
{{/* Uso: Referenciar em alertmanager.yml via templates: ['/etc/alertmanager/templates/*.tmpl'] */}}

{{/* Template Principal para Texto do Slack */}}
{{ define "slack.sla.text" }}
{{- $status := .Status -}}
{{- $severity := .CommonLabels.severity | default "unknown" -}}
{{- $alertname := .GroupLabels.alertname | default "UnknownAlert" -}}

{{/* Emoji baseado no status */}}
{{- if eq $status "firing" }}{{ if eq $severity "critical" }}üî¥{{ else }}‚ö†Ô∏è{{ end }}{{ else }}üü¢{{ end }} *{{ $alertname }}* [{{ $severity | toUpper }}]

{{/* Informa√ß√µes de Contexto */}}
üì¶ *Servi√ßo:* {{ .CommonLabels.service_name | default "orchestrator-dynamic" }}
üîß *Componente:* {{ .CommonLabels.component | default "N/A" }}
{{- if .CommonAnnotations.workflow_id }}
üîÑ *Workflow ID:* `{{ .CommonAnnotations.workflow_id }}`
{{- end }}
üïê *Timestamp:* {{ .StartsAt | date "2006-01-02 15:04:05 MST" }}

{{/* Detalhes Espec√≠ficos por Tipo de Alerta */}}

{{- if eq $alertname "OrchestratorBudgetCritical" }}
{{/* Budget Critical Alert */}}
üìä *Budget Restante:* {{ .CommonAnnotations.budget_remaining | default "N/A" }}%
üìà *Status:* {{ .CommonAnnotations.status | toUpper }}
{{- if .CommonAnnotations.burn_rate }}
üî• *Burn Rate:* {{ .CommonAnnotations.burn_rate }}x
{{- end }}

‚ö†Ô∏è *A√ß√£o Requerida:* Budget de erro est√° criticamente baixo. Considere congelar deployments n√£o-cr√≠ticos e investigar fonte de erros.

{{- else if eq $alertname "OrchestratorDeadlineApproaching" }}
{{/* Deadline Approaching Alert */}}
‚è±Ô∏è *Tempo Restante:* {{ .CommonAnnotations.remaining_seconds | default "N/A" }}s
üìä *Progresso:* {{ .CommonAnnotations.percent_consumed | default "N/A" }}% consumido
{{- if .CommonAnnotations.ticket_id }}
üé´ *Ticket ID:* `{{ .CommonAnnotations.ticket_id }}`
{{- end }}

‚ö†Ô∏è *A√ß√£o Requerida:* Workflow est√° se aproximando do deadline de SLA. Monitorar progresso atentamente.

{{- else if eq $alertname "OrchestratorDeadlineExceeded" }}
{{/* SLA Violation Alert */}}
üö® *Tipo de Viola√ß√£o:* {{ .CommonAnnotations.violation_type | default "DEADLINE_EXCEEDED" }}
‚è±Ô∏è *Atraso:* {{ .CommonAnnotations.delay_ms | default "N/A" }}ms
{{- if .CommonAnnotations.ticket_id }}
üé´ *Ticket ID:* `{{ .CommonAnnotations.ticket_id }}`
{{- end }}

üö® *VIOLA√á√ÉO DE SLA DETECTADA* - Investigar causa raiz imediatamente.

{{- else if eq $alertname "OrchestratorHighBurnRate" }}
{{/* High Burn Rate Alert */}}
üî• *Burn Rate:* {{ .CommonAnnotations.burn_rate | default "N/A" }}x
üìä *Budget Restante:* {{ .CommonAnnotations.budget_remaining | default "N/A" }}%
‚è±Ô∏è *Janela:* {{ .CommonAnnotations.window | default "1h" }}

‚ö†Ô∏è *A√ß√£o Requerida:* Taxa de consumo do budget est√° acima do normal. Verificar se h√° incidente em andamento.

{{- else if eq $alertname "OrchestratorBudgetExhausted" }}
{{/* Budget Exhausted Alert */}}
üö´ *Budget Restante:* 0%
üìà *Status:* EXHAUSTED

üö® *BUDGET ESGOTADO* - Todos os erros futuros violar√£o SLA. Freezar deployments e resolver incidente imediatamente.

{{- else if eq $alertname "OrchestratorSLAMonitorDown" }}
{{/* SLA Monitor Down Alert */}}
üíî *Monitor Status:* DOWN
‚è±Ô∏è *√öltima Verifica√ß√£o:* {{ .CommonAnnotations.last_check | default "N/A" }}

üö® *SLA MONITORING INDISPON√çVEL* - Sem visibilidade de SLA. Verificar health do SLA Management System.

{{- else }}
{{/* Generic Alert */}}
üìù *Descri√ß√£o:* {{ .CommonAnnotations.description | default .CommonAnnotations.summary | default "Sem descri√ß√£o dispon√≠vel" }}
{{- if .CommonAnnotations.budget_remaining }}
üìä *Budget Restante:* {{ .CommonAnnotations.budget_remaining }}%
{{- end }}
{{- if .CommonAnnotations.remaining_seconds }}
‚è±Ô∏è *Tempo Restante:* {{ .CommonAnnotations.remaining_seconds }}s
{{- end }}
{{- end }}

{{/* Links de A√ß√£o */}}
üìé *Links:*
{{- if .CommonAnnotations.dashboard_url }}
  ‚Ä¢ <{{ .CommonAnnotations.dashboard_url }}|üìä Dashboard do Grafana>
{{- else }}
  ‚Ä¢ <http://grafana/d/fluxo-c-orchestration|üìä Dashboard do Grafana>
{{- end }}
{{- if .CommonAnnotations.runbook_url }}
  ‚Ä¢ <{{ .CommonAnnotations.runbook_url }}|üìñ Runbook>
{{- else }}
  ‚Ä¢ <https://docs.example.com/runbooks/sla|üìñ Runbook>
{{- end }}
{{- if .CommonAnnotations.workflow_id }}
  ‚Ä¢ <{{ .ExternalURL }}/logs?workflow_id={{ .CommonAnnotations.workflow_id }}|üìã Logs do Workflow>
{{- end }}

{{/* Lista de Alertas (se m√∫ltiplos) */}}
{{- if gt (len .Alerts) 1 }}

üîî *Alertas neste Grupo:* {{ .Alerts | len }}
{{- range .Alerts }}
  ‚Ä¢ `{{ .Labels.workflow_id | default .Labels.ticket_id | default .Labels.alertname }}` - {{ .Status | toUpper }}{{ if .Labels.risk_band }} [{{ .Labels.risk_band }}]{{ end }} ({{ .StartsAt | since }})
{{- end }}
{{- end }}

{{/* Footer */}}
---
üîá <{{ .ExternalURL }}/#/silences/new?filter=%7Balertname%3D%22{{ $alertname }}%22%7D|Silenciar este alerta> | üìä <{{ .GeneratorURL }}|Ver no Prometheus>
{{ end }}


{{/* Template para T√≠tulo Curto */}}
{{ define "slack.sla.title" }}
{{- if eq .Status "firing" -}}
  {{- if eq .CommonLabels.severity "critical" -}}
    üî¥ [CRITICAL]
  {{- else -}}
    ‚ö†Ô∏è [WARNING]
  {{- end -}}
{{- else -}}
  ‚úÖ [RESOLVED]
{{- end }} {{ .GroupLabels.alertname }}
{{- end }}


{{/* Template para Cor do Slack */}}
{{ define "slack.sla.color" }}
{{- if eq .Status "firing" -}}
  {{- if eq .CommonLabels.severity "critical" -}}
    danger
  {{- else -}}
    warning
  {{- end -}}
{{- else -}}
  good
{{- end -}}
{{- end }}


{{/* Template para Sum√°rio Executivo (PagerDuty) */}}
{{ define "pagerduty.sla.summary" }}
{{- $alertname := .GroupLabels.alertname | default "UnknownAlert" -}}
{{- $severity := .CommonLabels.severity | default "unknown" | toUpper -}}
{{- $service := .CommonLabels.service_name | default "orchestrator-dynamic" -}}

[{{ $severity }}] {{ $alertname }} - {{ $service }}
{{- if .CommonAnnotations.workflow_id }} (Workflow: {{ .CommonAnnotations.workflow_id }}){{ end }}
{{- if .CommonAnnotations.budget_remaining }} - Budget: {{ .CommonAnnotations.budget_remaining }}%{{ end }}
{{- if .CommonAnnotations.remaining_seconds }} - Tempo: {{ .CommonAnnotations.remaining_seconds }}s{{ end }}
{{- end }}


{{/* Template para Detalhes JSON (Webhooks) */}}
{{ define "webhook.sla.payload" }}
{
  "status": "{{ .Status }}",
  "alert_name": "{{ .GroupLabels.alertname }}",
  "severity": "{{ .CommonLabels.severity }}",
  "service": "{{ .CommonLabels.service_name | default "orchestrator-dynamic" }}",
  "component": "{{ .CommonLabels.component }}",
  "workflow_id": "{{ .CommonAnnotations.workflow_id }}",
  "ticket_id": "{{ .CommonAnnotations.ticket_id }}",
  "budget_remaining": "{{ .CommonAnnotations.budget_remaining }}",
  "remaining_seconds": "{{ .CommonAnnotations.remaining_seconds }}",
  "burn_rate": "{{ .CommonAnnotations.burn_rate }}",
  "violation_type": "{{ .CommonAnnotations.violation_type }}",
  "timestamp": "{{ .StartsAt }}",
  "alerts_count": {{ .Alerts | len }},
  "firing_count": {{ .Alerts.Firing | len }},
  "resolved_count": {{ .Alerts.Resolved | len }},
  "dashboard_url": "{{ .CommonAnnotations.dashboard_url }}",
  "runbook_url": "{{ .CommonAnnotations.runbook_url }}",
  "generator_url": "{{ .GeneratorURL }}"
}
{{- end }}


{{/* Template para Email (futuro) */}}
{{ define "email.sla.subject" }}
[{{ .Status | toUpper }}] {{ .CommonLabels.severity | toUpper }}: {{ .GroupLabels.alertname }}
{{- end }}

{{ define "email.sla.body" }}
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; }
    .alert-critical { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; }
    .alert-warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; }
    .alert-resolved { background-color: #d4edda; border: 1px solid #c3e6cb; padding: 10px; }
    .details { margin: 10px 0; }
    .label { font-weight: bold; }
  </style>
</head>
<body>
  <div class="alert-{{ if eq .Status "firing" }}{{ .CommonLabels.severity }}{{ else }}resolved{{ end }}">
    <h2>{{ template "email.sla.subject" . }}</h2>

    <div class="details">
      <p><span class="label">Servi√ßo:</span> {{ .CommonLabels.service_name | default "orchestrator-dynamic" }}</p>
      <p><span class="label">Componente:</span> {{ .CommonLabels.component }}</p>
      {{- if .CommonAnnotations.workflow_id }}
      <p><span class="label">Workflow ID:</span> {{ .CommonAnnotations.workflow_id }}</p>
      {{- end }}
      <p><span class="label">Timestamp:</span> {{ .StartsAt }}</p>
    </div>

    {{- if .CommonAnnotations.description }}
    <p>{{ .CommonAnnotations.description }}</p>
    {{- end }}

    <div class="details">
      {{- if .CommonAnnotations.budget_remaining }}
      <p><span class="label">Budget Restante:</span> {{ .CommonAnnotations.budget_remaining }}%</p>
      {{- end }}
      {{- if .CommonAnnotations.remaining_seconds }}
      <p><span class="label">Tempo Restante:</span> {{ .CommonAnnotations.remaining_seconds }}s</p>
      {{- end }}
      {{- if .CommonAnnotations.burn_rate }}
      <p><span class="label">Burn Rate:</span> {{ .CommonAnnotations.burn_rate }}x</p>
      {{- end }}
    </div>

    <h3>A√ß√µes:</h3>
    <ul>
      <li><a href="{{ .CommonAnnotations.dashboard_url | default "http://grafana/d/fluxo-c-orchestration" }}">Ver Dashboard</a></li>
      <li><a href="{{ .CommonAnnotations.runbook_url | default "https://docs.example.com/runbooks/sla" }}">Consultar Runbook</a></li>
      <li><a href="{{ .GeneratorURL }}">Ver no Prometheus</a></li>
    </ul>

    {{- if gt (len .Alerts) 1 }}
    <h3>Alertas ({{ .Alerts | len }}):</h3>
    <ul>
    {{- range .Alerts }}
      <li>{{ .Labels.alertname }} - {{ .Status | toUpper }} ({{ .StartsAt }})</li>
    {{- end }}
    </ul>
    {{- end }}
  </div>
</body>
</html>
{{- end }}


{{/* INSTRU√á√ïES DE USO:

  1. DEPLOYMENT:

     # Criar ConfigMap com o template
     kubectl create configmap alertmanager-templates \
       --from-file=slack-sla.tmpl=slack-message-template.tmpl \
       -n monitoring

     # Montar em /etc/alertmanager/templates/ no pod do Alertmanager
     # Adicionar ao deployment/statefulset do Alertmanager:
     volumes:
       - name: templates
         configMap:
           name: alertmanager-templates
     volumeMounts:
       - name: templates
         mountPath: /etc/alertmanager/templates

  2. CONFIGURA√á√ÉO NO ALERTMANAGER.YML:

     templates:
       - '/etc/alertmanager/templates/*.tmpl'

     receivers:
       - name: 'slack-sla-warnings'
         slack_configs:
           - channel: '#sla-alerts'
             text: '{{ template "slack.sla.text" . }}'
             title: '{{ template "slack.sla.title" . }}'
             color: '{{ template "slack.sla.color" . }}'

  3. TESTE:

     # Enviar alerta de teste
     curl -H "Content-Type: application/json" -d '[{
       "labels": {
         "alertname": "OrchestratorBudgetCritical",
         "severity": "critical",
         "service_name": "orchestrator-dynamic"
       },
       "annotations": {
         "budget_remaining": "15",
         "burn_rate": "8.5"
       }
     }]' http://alertmanager:9093/api/v1/alerts

  4. CUSTOMIZA√á√ÉO:

     - Adicionar novos templates: Defina com {{ define "nome.template" }}...{{ end }}
     - Modificar formata√ß√£o: Edite os blocos dentro de cada template
     - Adicionar campos: Use .CommonAnnotations.nome_campo ou .CommonLabels.nome_label
     - Testar localmente: Use amtool template render --template-file=slack-sla.tmpl

  5. FUN√á√ïES DISPON√çVEIS:

     - {{ .Status }}: "firing" ou "resolved"
     - {{ .GroupLabels.alertname }}: Nome do alerta
     - {{ .CommonLabels.severity }}: Severidade (critical, warning, info)
     - {{ .CommonAnnotations.campo }}: Annotations do Prometheus alert rule
     - {{ .StartsAt }}: Timestamp de in√≠cio
     - {{ .Alerts }}: Lista de todos os alertas no grupo
     - {{ .Alerts.Firing }}: Alertas em firing
     - {{ .Alerts.Resolved }}: Alertas resolvidos
     - {{ date "layout" .StartsAt }}: Formatar data (Go time layout)
     - {{ since .StartsAt }}: Dura√ß√£o desde in√≠cio
     - {{ toUpper "text" }}: Converter para mai√∫sculas
     - {{ default "valor" .Campo }}: Valor padr√£o se campo n√£o existe

  REFER√äNCIAS:
    - Template Language: https://prometheus.io/docs/alerting/latest/notification_examples/
    - Slack Formatting: https://api.slack.com/reference/surfaces/formatting
    - Go Templates: https://pkg.go.dev/text/template
*/}}
